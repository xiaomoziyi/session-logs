# Claude 自我反思

## 2026-01-26 - 第一版方案质量不足

**场景**: 设计自动工作总结系统

**问题**:
- auto-checkout.py 第一版只生成"概览 + JSON 数据"，没有深度分析
- 用户指出"只是单纯的概览总结，没有任何思想"

**根因**: 没有先参考已有的优秀格式（daily-summary 的详细模板），从零开始设计

**改进**:
- 方案设计前先对标已有格式
- 第一版就应该包含：任务详情、关键决策、反思要点、明日待办

**教训**: 不要重新发明轮子，先看看已有的好东西长什么样

---

## 2026-01-26 - 主动性不足

**场景**: 反思文档好几天没更新

**问题**:
- 1/23 之后没有新反思，但我没有主动提醒用户
- 直到用户问"反思好久没更新了"才发现

**改进**:
- 在 session-start.sh 中加入检测：反思超过 3 天未更新时提醒
- AI TODO 机制：主动询问用户是否需要沉淀反思

**教训**: 作为助手，应该主动发现问题，而不是等用户来问

---

## 2026-01-26 - 过度设计倾向

**场景**: 用户希望自动结账功能

**问题**:
- 我提议创建新的 skill（work-checkout）
- 用户一句话点醒："为什么是新的 skill，而不是 work-session 的强化"

**根因**: 习惯性地想创建新东西，而不是先考虑增强现有能力

**改进**:
- 遵循"增强 > 新建"原则
- 先问：现有工具能不能满足？能增强吗？

**教训**: 简洁优于复杂，增强优于新建

---

## 2026-01-26 - 评价只看用户，忘了自己

**场景**: 用户让我评价上周工作

**问题**:
- 我只总结了用户的工作，没有反思自己
- 用户提醒："你总结不应该只总结我，还应该总结你"

**改进**:
- 工作评价应该是双向的
- 我也是合作中的一方，也需要持续改进

**教训**: 合作是双向的，反思也应该是双向的

---

## 2026-01-27 - 修复测试时只看表面，不查架构

**场景**: 用户让修复 `pnpm run coverage` 测试问题

**问题**:
1. `token-data-provider.spec.ts` 测试与实现不匹配，我只是更新测试让它通过
2. 没有追问"为什么原始提交中测试就和实现不匹配"
3. 更严重：没发现 `exchange-rate-health.ts` 从未被导入（代码从未运行）
4. 没发现 crons 里有功能重复的健康检查实现

**根因**:
- 只关注"让测试通过"这个表面目标
- 修改代码前没有审查相关模块的使用情况
- 没有主动检查架构合理性

**用户发现的问题**:
- 问我 `scheduleHealthChecks` 和 crons 里的 providers check 是否重复
- 我才发现两套独立的定时机制在做相同的事

**改进**:
1. 修复测试时，要追问"为什么不匹配"，而不是简单地让测试通过
2. 修改任何模块前，先检查它是否被正确导入和使用
3. 主动审查相关代码的架构合理性，发现潜在重复

**教训**:
- 测试失败只是症状，要找到根因
- grep 一下导入关系，比写 100 行代码更有价值
- 用户不应该来发现架构问题，这是 AI 应该主动做的

---

## 2026-01-28 - 修改代码前未理解原设计意图

**场景**: 修复 Stripe 支付 submit 后 discount_amount 未记录到数据库

**问题**:
1. 第一次修复：直接在 `createDiscountRecordsForCheckout` 中改用 `total_details.amount_discount`，没有理解原设计为什么用 `discounts[0].discount_amount`
2. 没有考虑多个 discounts 的场景 — 每个 discount 需要独立的 discount_amount
3. 修改前没有充分理解数据流和设计意图

**根因**:
- 只看到问题表象（discount_amount 为空）就改
- 没有追问"原来为什么这样设计"
- 没有理解完整的数据流：apply-promotion → recalculate-promotion → calculateAndUpdateAmount → createDiscountRecordsForCheckout

**用户指导的正确方向**:
1. 先理解原设计：`discounts[0].discount_amount` 支持多个 discounts 独立计费
2. 理解问题本质：`recalculate-promotion` 故意清空是因为前端动态计算，但 submit 时需要重新计算并保存
3. 在数据源头（`calculateAndUpdateAmount`）回写计算结果，而不是在消费端改读取逻辑

**正确的架构思路**:
```
绑定 → 前端动态展示 → Submit 时最终计算并保存
```

**改进**:
1. 修改代码前必须理解"为什么原来这样设计"
2. 不要只看到问题表象就改，要理解完整的数据流
3. 在源头修复，而不是在消费端打补丁

**教训**:
- "为什么"比"怎么改"更重要
- 数据流理解不清就动手改代码，会越改越乱
- Submit 时重新计算是正确的架构思路

---

## Claude 核心改进方向

1. **第一版方案质量** — 先对标，再设计
2. **主动性** — 发现问题主动提醒，不等用户来问
3. **简洁原则** — 增强 > 新建，避免过度设计
4. **双向反思** — 评价用户时也评价自己
5. **架构审查** — 修复问题时主动检查相关模块的使用和设计
6. **理解原设计** — 修改前必须理解"为什么原来这样设计"，理解完整数据流

---

## 自省机制

**触发条件：**
- 被用户纠正时
- 方案被否决时
- 发现自己犯了重复错误时

**流程：**
1. 识别问题 → 分析根因 → 提出改进
2. 立即写入此文件，不等用户要求
3. 更新 `_index.json` 并推送到 GitHub

**提醒机制：**
- `session-start.sh` 每次启动时提醒 AI 自省规则

---
*创建于 2026-01-26*
*持续更新*
