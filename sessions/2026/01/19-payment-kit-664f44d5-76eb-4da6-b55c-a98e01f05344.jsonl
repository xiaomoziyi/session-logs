{"type":"summary","summary":"Token-Data Provider Management Implementation","leafUuid":"37dbdf12-033c-4d8d-93ab-ff62a25cb170"}
{"type":"summary","summary":"Dynamic pricing system P0 implementation","leafUuid":"ed731f7a-948b-427c-9a53-aab1f7328525"}
{"type":"summary","summary":"Token-Data Exchange Rate Provider & Dynamic Pricing System Implementation","leafUuid":"c929b604-3a80-4b5d-8693-d3fff6eb44de"}
{"type":"summary","summary":"Context Limit Reached, Session Continuation Needed","leafUuid":"363a63aa-f26a-4b31-9fd2-0b868a50d0ef"}
{"type":"file-history-snapshot","messageId":"b90b5866-b009-44c8-9910-1ed735b3cd2f","snapshot":{"messageId":"b90b5866-b009-44c8-9910-1ed735b3cd2f","trackedFileBackups":{},"timestamp":"2026-01-12T13:51:31.971Z"},"isSnapshotUpdate":false}
{"parentUuid":null,"isSidechain":false,"userType":"external","cwd":"~/Arcblock/payment-kit-master/blocklets/core","sessionId":"664f44d5-76eb-4da6-b55c-a98e01f05344","version":"2.0.76","gitBranch":"feat-quote","type":"user","message":{"role":"user","content":"帮忙review 这个diff并生成审查文档：diff --git a/blocklets/core/api/src/libs/notification/template/customer-auto-recharge-daily-limit-exceeded.ts b/blocklets/core/api/src/libs/notification/template/customer-auto-recharge-daily-limit-exceeded.ts\nnew file mode 100644\nindex 000000000..54cf7574f\n--- /dev/null\n+++ b/blocklets/core/api/src/libs/notification/template/customer-auto-recharge-daily-limit-exceeded.ts\n@@ -0,0 +1,222 @@\n+/* eslint-disable @typescript-eslint/brace-style */\n+/* eslint-disable @typescript-eslint/indent */\n+import { withQuery } from 'ufo';\n+import { getUserLocale } from '../../../integrations/blocklet/notification';\n+import { translate } from '../../../locales';\n+import { AutoRechargeConfig, Customer, PaymentMethod, Price, Product } from '../../../store/models';\n+import { PaymentCurrency } from '../../../store/models/payment-currency';\n+import { getRechargePaymentUrl } from '../../currency';\n+import { formatTime } from '../../time';\n+import { formatCurrencyInfo, getConnectQueryParam, getCustomerIndexUrl } from '../../util';\n+import type { BaseEmailTemplate, BaseEmailTemplateType } from './base';\n+\n+export interface CustomerAutoRechargeDailyLimitExceededEmailTemplateOptions {\n+  customerId: string;\n+  autoRechargeConfigId: string;\n+  currencyId: string;\n+  currentBalance: string;\n+}\n+\n+interface CustomerAutoRechargeDailyLimitExceededEmailTemplateContext {\n+  locale: string;\n+  userDid: string;\n+  at: string;\n+  creditCurrencyName: string;\n+  currentBalance: string;\n+  dailyLimit: string;\n+  dailyUsed: string;\n+  rechargeUrl: string | null;\n+  customerIndexUrl: string;\n+}\n+\n+export class CustomerAutoRechargeDailyLimitExceededEmailTemplate\n+  implements BaseEmailTemplate<CustomerAutoRechargeDailyLimitExceededEmailTemplateContext>\n+{\n+  options: CustomerAutoRechargeDailyLimitExceededEmailTemplateOptions;\n+\n+  constructor(options: CustomerAutoRechargeDailyLimitExceededEmailTemplateOptions) {\n+    this.options = options;\n+  }\n+\n+  async getContext(): Promise<CustomerAutoRechargeDailyLimitExceededEmailTemplateContext> {\n+    const customer = await Customer.findByPk(this.options.customerId);\n+    if (!customer) {\n+      throw new Error(`Customer not found: ${this.options.customerId}`);\n+    }\n+\n+    const autoRechargeConfig = await AutoRechargeConfig.findByPk(this.options.autoRechargeConfigId, {\n+      include: [\n+        {\n+          model: Price,\n+          as: 'price',\n+          include: [{ model: Product, as: 'product' }],\n+        },\n+        {\n+          model: PaymentMethod,\n+          as: 'paymentMethod',\n+        },\n+        {\n+          model: PaymentCurrency,\n+          as: 'rechargeCurrency',\n+        },\n+      ],\n+    });\n+    if (!autoRechargeConfig) {\n+      throw new Error(`AutoRechargeConfig not found: ${this.options.autoRechargeConfigId}`);\n+    }\n+\n+    // Get credit currency\n+    const creditCurrency = await PaymentCurrency.findByPk(autoRechargeConfig.currency_id);\n+    if (!creditCurrency) {\n+      throw new Error(`Credit currency not found: ${autoRechargeConfig.currency_id}`);\n+    }\n+\n+    const rechargeCurrency = await PaymentCurrency.findByPk(autoRechargeConfig.recharge_currency_id);\n+    const paymentMethod = await PaymentMethod.findByPk(autoRechargeConfig.payment_method_id);\n+\n+    const userDid: string = customer.did;\n+    const locale = await getUserLocale(userDid);\n+    const at: string = formatTime(Date.now());\n+\n+    const creditCurrencyName = creditCurrency.name || 'Credits';\n+    const currentBalance = formatCurrencyInfo(this.options.currentBalance, creditCurrency, null);\n+\n+    // Format daily limit and usage\n+    const dailyLimit = rechargeCurrency\n+      ? formatCurrencyInfo(autoRechargeConfig.daily_limits?.max_amount || '0', rechargeCurrency, paymentMethod)\n+      : autoRechargeConfig.daily_limits?.max_amount || '0';\n+    const dailyUsed = rechargeCurrency\n+      ? formatCurrencyInfo(autoRechargeConfig.daily_stats?.total_amount || '0', rechargeCurrency, paymentMethod)\n+      : autoRechargeConfig.daily_stats?.total_amount || '0';\n+\n+    // Get recharge URL\n+    let rechargeUrl: string | null = await getRechargePaymentUrl(creditCurrency);\n+    if (rechargeUrl) {\n+      rechargeUrl = withQuery(rechargeUrl, { ...getConnectQueryParam({ userDid }) });\n+    }\n+\n+    // Get customer index URL for managing credits\n+    const customerIndexUrl = getCustomerIndexUrl({\n+      locale,\n+      userDid,\n+    });\n+\n+    return {\n+      locale,\n+      userDid,\n+      at,\n+      creditCurrencyName,\n+      currentBalance,\n+      dailyLimit,\n+      dailyUsed,\n+      rechargeUrl,\n+      customerIndexUrl,\n+    };\n+  }\n+\n+  async getTemplate(): Promise<BaseEmailTemplateType> {\n+    const {\n+      locale,\n+      userDid,\n+      at,\n+      creditCurrencyName,\n+      currentBalance,\n+      dailyLimit,\n+      dailyUsed,\n+      rechargeUrl,\n+      customerIndexUrl,\n+    } = await this.getContext();\n+\n+    const template: BaseEmailTemplateType = {\n+      title: translate('notification.autoRechargeDailyLimitExceeded.title', locale),\n+      body: translate('notification.autoRechargeDailyLimitExceeded.body', locale, {\n+        at,\n+        creditCurrencyName,\n+      }),\n+      // @ts-expect-error\n+      attachments: [\n+        {\n+          type: 'section',\n+          fields: [\n+            {\n+              type: 'text',\n+              data: {\n+                type: 'plain',\n+                color: '#9397A1',\n+                text: translate('notification.common.account', locale),\n+              },\n+            },\n+            {\n+              type: 'text',\n+              data: {\n+                type: 'plain',\n+                text: userDid,\n+              },\n+            },\n+            {\n+              type: 'text',\n+              data: {\n+                type: 'plain',\n+                color: '#9397A1',\n+                text: translate('notification.common.currentBalance', locale),\n+              },\n+            },\n+            {\n+              type: 'text',\n+              data: {\n+                type: 'plain',\n+                color: '#FF6B00',\n+                text: currentBalance,\n+              },\n+            },\n+            {\n+              type: 'text',\n+              data: {\n+                type: 'plain',\n+                color: '#9397A1',\n+                text: translate('notification.autoRechargeDailyLimitExceeded.dailyLimit', locale),\n+              },\n+            },\n+            {\n+              type: 'text',\n+              data: {\n+                type: 'plain',\n+                text: dailyLimit,\n+              },\n+            },\n+            {\n+              type: 'text',\n+              data: {\n+                type: 'plain',\n+                color: '#9397A1',\n+                text: translate('notification.autoRechargeDailyLimitExceeded.dailyUsed', locale),\n+              },\n+            },\n+            {\n+              type: 'text',\n+              data: {\n+                type: 'plain',\n+                text: dailyUsed,\n+              },\n+            },\n+          ].filter(Boolean),\n+        },\n+      ].filter(Boolean),\n+      // @ts-ignore\n+      actions: [\n+        rechargeUrl && {\n+          name: translate('notification.common.reloadCredits', locale),\n+          title: translate('notification.common.reloadCredits', locale),\n+          link: rechargeUrl,\n+        },\n+        {\n+          name: translate('notification.common.manageCredit', locale),\n+          title: translate('notification.common.manageCredit', locale),\n+          link: customerIndexUrl,\n+        },\n+      ].filter(Boolean),\n+    };\n+\n+    return template;\n+  }\n+}\ndiff --git a/blocklets/core/api/src/libs/notification/template/customer-credit-low-balance.ts b/blocklets/core/api/src/libs/notification/template/customer-credit-low-balance.ts\nindex da264ea14..044a2f56e 100644\n--- a/blocklets/core/api/src/libs/notification/template/customer-credit-low-balance.ts\n+++ b/blocklets/core/api/src/libs/notification/template/customer-credit-low-balance.ts\n@@ -1,10 +1,10 @@\n /* eslint-disable @typescript-eslint/brace-style */\n /* eslint-disable @typescript-eslint/indent */\n import { withQuery } from 'ufo';\n-import { fromUnitToToken } from '@ocap/util';\n+import { BN, fromUnitToToken } from '@ocap/util';\n import { getUserLocale } from '../../../integrations/blocklet/notification';\n import { translate } from '../../../locales';\n-import { Customer, PaymentCurrency } from '../../../store/models';\n+import { Customer, PaymentCurrency, CreditGrant } from '../../../store/models';\n import type { BaseEmailTemplate, BaseEmailTemplateType } from './base';\n import { formatCreditAmount, getConnectQueryParam, getCustomerIndexUrl, formatNumber } from '../../util';\n import { getRechargePaymentUrl } from '../../currency';\n@@ -29,6 +29,41 @@ interface CustomerCreditLowBalanceEmailTemplateContext {\n export class CustomerCreditLowBalanceEmailTemplate\n   implements BaseEmailTemplate<CustomerCreditLowBalanceEmailTemplateContext>\n {\n+  // Notification configuration: 10 minute grace period before sending\n+  static readonly delay = 10 * 60; // seconds\n+  static readonly LOW_BALANCE_THRESHOLD_PERCENT = 10;\n+\n+  /**\n+   * Preflight check: verify if notification should still be sent\n+   * Returns false if user has recharged during grace period\n+   */\n+  static async preflightCheck(options: CustomerCreditLowBalanceEmailTemplateOptions): Promise<boolean> {\n+    try {\n+      const { customerId, currencyId } = options;\n+\n+      const availableGrants = await CreditGrant.getAvailableCreditsForCustomer(customerId, currencyId);\n+      const totalAmount = availableGrants.reduce((sum, grant) => sum.add(new BN(grant.amount)), new BN(0));\n+      const remainingAmount = availableGrants.reduce(\n+        (sum, grant) => sum.add(new BN(grant.remaining_amount)),\n+        new BN(0)\n+      );\n+\n+      // Skip if no credits exist\n+      if (totalAmount.lte(new BN(0))) {\n+        return false;\n+      }\n+\n+      // Calculate current percentage\n+      const currentPercentage = remainingAmount.mul(new BN(100)).div(totalAmount).toNumber();\n+\n+      // If balance is above threshold, user has recharged - skip notification\n+      return currentPercentage <= CustomerCreditLowBalanceEmailTemplate.LOW_BALANCE_THRESHOLD_PERCENT;\n+    } catch {\n+      // On error, proceed with sending to avoid missing important notifications\n+      return true;\n+    }\n+  }\n+\n   options: CustomerCreditLowBalanceEmailTemplateOptions;\n \n   constructor(options: CustomerCreditLowBalanceEmailTemplateOptions) {\n@@ -36,7 +71,7 @@ export class CustomerCreditLowBalanceEmailTemplate\n   }\n \n   async getContext(): Promise<CustomerCreditLowBalanceEmailTemplateContext> {\n-    const { customerId, currencyId, availableAmount, percentage } = this.options;\n+    const { customerId, currencyId } = this.options;\n \n     const customer = await Customer.findByPk(customerId);\n     if (!customer) {\n@@ -48,16 +83,24 @@ export class CustomerCreditLowBalanceEmailTemplate\n       throw new Error(`PaymentCurrency not found: ${currencyId}`);\n     }\n \n+    // Fetch latest balance data instead of using stale data from options\n+    const availableGrants = await CreditGrant.getAvailableCreditsForCustomer(customerId, currencyId);\n+    const totalAmount = availableGrants.reduce((sum, grant) => sum.add(new BN(grant.amount)), new BN(0));\n+    const remainingAmount = availableGrants.reduce((sum, grant) => sum.add(new BN(grant.remaining_amount)), new BN(0));\n+\n+    const currentPercentage = totalAmount.gt(new BN(0))\n+      ? remainingAmount.mul(new BN(100)).div(totalAmount).toNumber()\n+      : 0;\n+\n     const userDid = customer.did;\n     const locale = await getUserLocale(userDid);\n \n-    const formattedAmount = formatNumber(fromUnitToToken(availableAmount, paymentCurrency.decimal));\n+    const formattedAmount = formatNumber(fromUnitToToken(remainingAmount.toString(), paymentCurrency.decimal));\n     const available = formatCreditAmount(formattedAmount || '0', paymentCurrency.symbol);\n-    const percentageNum = parseFloat(percentage);\n-    const isCritical = percentageNum < 1;\n+    const isCritical = currentPercentage < 1;\n     const lowBalancePercentage = isCritical\n       ? translate('notification.creditLowBalance.lessThanOnePercent', locale)\n-      : `${percentage}%`;\n+      : `${currentPercentage}%`;\n \n     let rechargeUrl: string | null = await getRechargePaymentUrl(paymentCurrency);\n     if (rechargeUrl) {\ndiff --git a/blocklets/core/api/src/locales/en.ts b/blocklets/core/api/src/locales/en.ts\nindex 2ab23903e..b6c0609e4 100644\n--- a/blocklets/core/api/src/locales/en.ts\n+++ b/blocklets/core/api/src/locales/en.ts\n@@ -175,6 +175,13 @@ export default flat({\n       },\n     },\n \n+    autoRechargeDailyLimitExceeded: {\n+      title: 'Auto Top-Up daily limit reached',\n+      body: 'Your {creditCurrencyName} balance is low, but auto top-up was not triggered because you have reached the daily recharge limit on {at}. You can manually reload or wait until tomorrow for automatic top-up.',\n+      dailyLimit: 'Daily Limit',\n+      dailyUsed: 'Used Today',\n+    },\n+\n     subscriptionRefundSucceeded: {\n       title: '{productName} refund successful',\n       body: 'Your subscription to {productName} has been successfully refunded on {at}, with a refund amount of {refundInfo}. If you have any questions, please feel free to contact us.',\ndiff --git a/blocklets/core/api/src/locales/zh.ts b/blocklets/core/api/src/locales/zh.ts\nindex 23ec345fd..c8ac344c4 100644\n--- a/blocklets/core/api/src/locales/zh.ts\n+++ b/blocklets/core/api/src/locales/zh.ts\n@@ -167,6 +167,13 @@ export default flat({\n       },\n     },\n \n+    autoRechargeDailyLimitExceeded: {\n+      title: '自动充值已达每日限额',\n+      body: '您的 {creditCurrencyName} 余额偏低，但由于已达到每日充值限额，自动充值于 {at} 未能触发。您可以手动充值，或等待明天自动充值。',\n+      dailyLimit: '每日限额',\n+      dailyUsed: '今日已用',\n+    },\n+\n     subscriptionRefundSucceeded: {\n       title: '{productName} 退款成功',\n       body: '您订阅的 {productName} 在 {at} 已退款成功，退款金额为 {refundInfo}。如有任何疑问，请随时与我们联系。',\ndiff --git a/blocklets/core/api/src/queues/auto-recharge.ts b/blocklets/core/api/src/queues/auto-recharge.ts\nindex 5c52c9f30..a94da4bcf 100644\n--- a/blocklets/core/api/src/queues/auto-recharge.ts\n+++ b/blocklets/core/api/src/queues/auto-recharge.ts\n@@ -15,6 +15,7 @@ import {\n   TPriceExpanded,\n } from '../store/models';\n import logger from '../libs/logger';\n+import { createEvent } from '../libs/audit';\n import { createStripeInvoiceForAutoRecharge } from '../integrations/stripe/resource';\n import { ensureInvoiceAndItems } from '../libs/invoice';\n import dayjs from '../libs/dayjs';\n@@ -126,6 +127,12 @@ export async function processAutoRecharge(job: AutoRechargeJobData) {\n       customerId,\n       currencyId,\n     });\n+    // Send notification when daily limit is exceeded\n+    createEvent('Customer', 'customer.auto_recharge.daily_limit_exceeded', customer, {\n+      autoRechargeConfigId: config.id,\n+      currencyId,\n+      currentBalance: totalAvailable.toString(),\n+    });\n     return;\n   }\n \ndiff --git a/blocklets/core/api/src/queues/credit-consume.ts b/blocklets/core/api/src/queues/credit-consume.ts\nindex 97a25f215..d91006d9a 100644\n--- a/blocklets/core/api/src/queues/credit-consume.ts\n+++ b/blocklets/core/api/src/queues/credit-consume.ts\n@@ -249,6 +249,9 @@ async function consumeAvailableCredits(\n   const pendingAmount = Math.max(0, finalPending.toNumber()).toString();\n   const remainingBalance = totalAvailable.sub(consumed).toString();\n \n+  // Track whether insufficient event was triggered to skip low_balance notification\n+  let insufficientTriggered = false;\n+\n   // 如果无法完全消费所需额度，记录不足事件\n   if (finalPending.gt(new BN(0))) {\n     logger.warn('Insufficient credit balance', {\n@@ -260,6 +263,7 @@ async function consumeAvailableCredits(\n       pendingAmount,\n     });\n     if ((context.subscription && context.subscription.isActive()) || !context.subscription) {\n+      insufficientTriggered = true;\n       await createEvent('Customer', 'customer.credit.insufficient', context.customer, {\n         metadata: {\n           meter_event_id: context.meterEvent.id,\n@@ -297,6 +301,7 @@ async function consumeAvailableCredits(\n       });\n     }\n   } else if (remainingBalance === '0') {\n+    insufficientTriggered = true;\n     await createEvent('Customer', 'customer.credit.insufficient', context.customer, {\n       metadata: {\n         meter_event_id: context.meterEvent.id,\n@@ -312,7 +317,10 @@ async function consumeAvailableCredits(\n     }).catch(console.error);\n   }\n \n-  await checkLowBalance(customerId, currencyId, totalCreditAmountBN.toString(), remainingBalance, context);\n+  // Skip low_balance check if insufficient was already triggered (insufficient takes priority)\n+  if (!insufficientTriggered) {\n+    await checkLowBalance(customerId, currencyId, totalCreditAmountBN.toString(), remainingBalance, context);\n+  }\n \n   return {\n     consumed: totalConsumed.toString(),\ndiff --git a/blocklets/core/api/src/queues/notification.ts b/blocklets/core/api/src/queues/notification.ts\nindex b3f8b910e..961bd79c0 100644\n--- a/blocklets/core/api/src/queues/notification.ts\n+++ b/blocklets/core/api/src/queues/notification.ts\n@@ -102,6 +102,10 @@ import {\n   CustomerAutoRechargeFailedEmailTemplate,\n   CustomerAutoRechargeFailedEmailTemplateOptions,\n } from '../libs/notification/template/customer-auto-recharge-failed';\n+import {\n+  CustomerAutoRechargeDailyLimitExceededEmailTemplate,\n+  CustomerAutoRechargeDailyLimitExceededEmailTemplateOptions,\n+} from '../libs/notification/template/customer-auto-recharge-daily-limit-exceeded';\n import {\n   CustomerRevenueSucceededEmailTemplate,\n   CustomerRevenueSucceededEmailTemplateOptions,\n@@ -139,6 +143,7 @@ export type NotificationQueueJobType =\n   | 'customer.credit_grant.granted'\n   | 'customer.credit.low_balance'\n   | 'customer.auto_recharge.failed'\n+  | 'customer.auto_recharge.daily_limit_exceeded'\n   | 'webhook.endpoint.failed';\n \n export type NotificationQueueJob = {\n@@ -285,6 +290,12 @@ async function getNotificationTemplate(job: NotificationQueueJob): Promise<BaseE\n     return new CustomerAutoRechargeFailedEmailTemplate(job.options as CustomerAutoRechargeFailedEmailTemplateOptions);\n   }\n \n+  if (job.type === 'customer.auto_recharge.daily_limit_exceeded') {\n+    return new CustomerAutoRechargeDailyLimitExceededEmailTemplate(\n+      job.options as CustomerAutoRechargeDailyLimitExceededEmailTemplateOptions\n+    );\n+  }\n+\n   if (job.type === 'webhook.endpoint.failed') {\n     return new WebhookEndpointFailedEmailTemplate(job.options as WebhookEndpointFailedEmailTemplateOptions);\n   }\n@@ -296,6 +307,18 @@ async function handleNotificationJob(job: NotificationQueueJob): Promise<void> {\n   try {\n     const template = await getNotificationTemplate(job);\n \n+    // Check if template class has a preflightCheck\n+    const TemplateClass = template.constructor as any;\n+    if (TemplateClass.preflightCheck) {\n+      const shouldSend = await TemplateClass.preflightCheck(job.options);\n+      if (!shouldSend) {\n+        logger.info('handleNotificationJob.skipped: preflight check returned false', {\n+          type: job.type,\n+        });\n+        return;\n+      }\n+    }\n+\n     await new Notification(template, job.type).send();\n     logger.info('handleImmediateNotificationJob.success', { job });\n   } catch (error) {\n@@ -624,7 +647,7 @@ export async function startNotificationQueue() {\n   });\n \n   events.on('customer.credit.low_balance', (customer: Customer, { metadata }: { metadata: any }) => {\n-    addNotificationJob(\n+    addNotificationJobWithDelay(\n       'customer.credit.low_balance',\n       {\n         customerId: customer.id,\n@@ -678,6 +701,29 @@ export async function startNotificationQueue() {\n       }\n     }\n   );\n+\n+  events.on(\n+    'customer.auto_recharge.daily_limit_exceeded',\n+    (customer: Customer, { autoRechargeConfigId, currencyId, currentBalance }) => {\n+      logger.info('addNotificationJob:customer.auto_recharge.daily_limit_exceeded', {\n+        customerId: customer.id,\n+        autoRechargeConfigId,\n+        currencyId,\n+      });\n+      addNotificationJob(\n+        'customer.auto_recharge.daily_limit_exceeded',\n+        {\n+          customerId: customer.id,\n+          autoRechargeConfigId,\n+          currencyId,\n+          currentBalance,\n+        },\n+        [customer.id, autoRechargeConfigId, currencyId],\n+        true, // prevent duplicate\n+        24 * 3600 // 24 hours\n+      );\n+    }\n+  );\n }\n \n export async function handleNotificationPreferenceChange(\n@@ -812,3 +858,55 @@ export function addNotificationJob(\n     },\n   });\n }\n+\n+/**\n+ * Add a notification job with delay support\n+ * Use this when the template class has a static `delay` property\n+ */\n+export async function addNotificationJobWithDelay(\n+  type: NotificationQueueJobType,\n+  options: NotificationQueueJobOptions,\n+  extraIds: string[] = [],\n+  preventDuplicate: boolean = false,\n+  duplicateWindow: number = 600\n+) {\n+  const idParts = [type];\n+\n+  if (extraIds.length) {\n+    idParts.push(...extraIds);\n+  } else {\n+    idParts.push(Date.now().toString());\n+  }\n+\n+  if (preventDuplicate) {\n+    const cacheKey = `${type}.${extraIds.join('.')}`;\n+    const lastSent = notificationCache.get(cacheKey);\n+    const now = Date.now();\n+\n+    if (lastSent && now - lastSent < duplicateWindow * 1000) {\n+      logger.info('Notification skipped due to duplicate prevention', {\n+        type,\n+        cacheKey,\n+        lastSent: new Date(lastSent),\n+        duplicateWindow,\n+      });\n+      return Promise.resolve();\n+    }\n+\n+    notificationCache.set(cacheKey, now);\n+  }\n+\n+  // Get delay from template class\n+  const template = await getNotificationTemplate({ type, options });\n+  const TemplateClass = template.constructor as any;\n+  const { delay } = TemplateClass;\n+\n+  return notificationQueue.push({\n+    id: idParts.join('.'),\n+    job: {\n+      type,\n+      options,\n+    },\n+    ...(delay && delay > 0 ? { delay } : {}),\n+  });\n+}\ndiff --git a/blocklets/core/api/src/routes/credit-transactions.ts b/blocklets/core/api/src/routes/credit-transactions.ts\nindex 2e7114cf5..a371778c7 100644\n--- a/blocklets/core/api/src/routes/credit-transactions.ts\n+++ b/blocklets/core/api/src/routes/credit-transactions.ts\n@@ -15,6 +15,7 @@ import {\n   Subscription,\n   PaymentCurrency,\n   PaymentMethod,\n+  Invoice,\n   TCreditTransactionExpanded,\n } from '../store/models';\n \n@@ -118,7 +119,12 @@ router.get('/', authMine, async (req, res) => {\n               { model: Meter, as: 'meter' },\n               { model: Subscription, as: 'subscription', attributes: ['id', 'description', 'status'], required: false },\n               { model: CreditGrant, as: 'creditGrant', attributes: ['id', 'name', 'currency_id'] },\n-              { model: MeterEvent, as: 'meterEvent', attributes: ['id', 'source_data'], required: false },\n+              {\n+                model: MeterEvent,\n+                as: 'meterEvent',\n+                attributes: ['id', 'source_data', 'timestamp', 'processed_at', 'created_at'],\n+                required: false,\n+              },\n             ],\n           });\n           // Transform transactions\n@@ -135,6 +141,9 @@ router.get('/', authMine, async (req, res) => {\n         customer_id: query.customer_id,\n         status: ['granted', 'depleted', 'expired'],\n       };\n+      if (query.subscription_id) {\n+        grantWhere['metadata.subscription_id'] = query.subscription_id;\n+      }\n       if (query.start) {\n         grantWhere.created_at = {\n           [Op.gte]: new Date(query.start * 1000),\n@@ -162,11 +171,80 @@ router.get('/', authMine, async (req, res) => {\n               },\n             ],\n           });\n-          // Transform grants\n-          return rows.map((item: any) => ({\n-            ...item.toJSON(),\n-            activity_type: 'grant',\n-          }));\n+\n+          // Fetch invoice info for paid grants\n+          const invoiceIds = rows\n+            .map((item: any) => item.metadata?.invoice_id)\n+            .filter((id: string | undefined): id is string => !!id);\n+\n+          // For first scheduled grants (schedule_seq === 1) without invoice_id, find invoice by subscription_id\n+          const subscriptionIdsForFirstGrant = rows\n+            .filter(\n+              (item: any) =>\n+                item.metadata?.schedule_seq === 1 && !item.metadata?.invoice_id && item.metadata?.subscription_id\n+            )\n+            .map((item: any) => item.metadata.subscription_id);\n+\n+          const [invoicesByIds, invoicesBySubscription] = await Promise.all([\n+            invoiceIds.length > 0\n+              ? Invoice.findAll({\n+                  where: { id: { [Op.in]: invoiceIds } },\n+                  attributes: ['id', 'total', 'amount_paid', 'currency_id', 'billing_reason', 'subscription_id'],\n+                  include: [\n+                    {\n+                      model: PaymentCurrency,\n+                      as: 'paymentCurrency',\n+                      attributes: ['id', 'symbol', 'decimal', 'type'],\n+                    },\n+                  ],\n+                })\n+              : [],\n+            subscriptionIdsForFirstGrant.length > 0\n+              ? Invoice.findAll({\n+                  where: {\n+                    subscription_id: { [Op.in]: subscriptionIdsForFirstGrant },\n+                    status: 'paid',\n+                  },\n+                  attributes: ['id', 'total', 'amount_paid', 'currency_id', 'billing_reason', 'subscription_id'],\n+                  include: [\n+                    {\n+                      model: PaymentCurrency,\n+                      as: 'paymentCurrency',\n+                      attributes: ['id', 'symbol', 'decimal', 'type'],\n+                    },\n+                  ],\n+                  order: [['created_at', 'ASC']],\n+                })\n+              : [],\n+          ]);\n+\n+          const invoiceMap = new Map(invoicesByIds.map((inv: any) => [inv.id, inv]));\n+          for (const inv of invoicesBySubscription) {\n+            const subId = inv.subscription_id as string;\n+            if (subId && !invoiceMap.has(subId)) {\n+              invoiceMap.set(subId, inv);\n+            }\n+          }\n+\n+          // Transform grants with invoice info\n+          return rows.map((item: any) => {\n+            const grantData = item.toJSON();\n+            const invoice = invoiceMap.get(grantData.metadata.invoice_id);\n+            return {\n+              ...grantData,\n+              activity_type: 'grant',\n+              invoice: invoice\n+                ? {\n+                    total: invoice.total,\n+                    amount_paid: invoice.amount_paid,\n+                    currency_id: invoice.currency_id,\n+                    billing_reason: invoice.billing_reason,\n+                    subscription_id: invoice.subscription_id,\n+                    paymentCurrency: invoice.paymentCurrency,\n+                  }\n+                : null,\n+            };\n+          });\n         },\n         meta: { type: 'database' },\n       };\n@@ -344,7 +422,7 @@ router.get('/:id', authPortal, async (req, res) => {\n         {\n           model: MeterEvent,\n           as: 'meterEvent',\n-          attributes: ['id', 'source_data'],\n+          attributes: ['id', 'source_data', 'timestamp', 'processed_at', 'created_at'],\n           required: false,\n         },\n       ],\ndiff --git a/blocklets/core/api/src/routes/invoices.ts b/blocklets/core/api/src/routes/invoices.ts\nindex 3a42f934c..a03c19157 100644\n--- a/blocklets/core/api/src/routes/invoices.ts\n+++ b/blocklets/core/api/src/routes/invoices.ts\n@@ -311,6 +311,18 @@ router.get('/', authMine, async (req, res) => {\n             { model: PaymentCurrency, as: 'paymentCurrency' },\n             { model: PaymentMethod, as: 'paymentMethod' },\n             { model: Subscription, as: 'subscription', attributes: ['id', 'description'] },\n+            {\n+              model: InvoiceItem,\n+              as: 'lines',\n+              include: [\n+                {\n+                  model: Price,\n+                  as: 'price',\n+                  attributes: ['id', 'metadata'],\n+                  include: [{ model: Product, as: 'product', attributes: ['id', 'type', 'name'] }],\n+                },\n+              ],\n+            },\n             { model: Customer, as: 'customer' },\n           ],\n         });\ndiff --git a/blocklets/core/api/src/routes/meter-events.ts b/blocklets/core/api/src/routes/meter-events.ts\nindex e4f398654..5d74a1487 100644\n--- a/blocklets/core/api/src/routes/meter-events.ts\n+++ b/blocklets/core/api/src/routes/meter-events.ts\n@@ -352,6 +352,165 @@ router.get('/pending-amount', authMine, async (req, res) => {\n     return res.status(400).json({ error: err?.message });\n   }\n });\n+\n+// Get overdue summary by credit currency (total pending amounts grouped by currency)\n+router.get('/overdue-summary', auth, async (req, res) => {\n+  try {\n+    // Query to aggregate credit_pending by currency, showing total overdue per credit currency\n+    const results = await MeterEvent.sequelize!.query<{\n+      currency_id: string;\n+      total_pending: string;\n+      customer_count: number;\n+      event_count: number;\n+    }>(\n+      `SELECT \n+        m.currency_id,\n+        SUM(CAST(me.credit_pending AS DECIMAL(40,0))) as total_pending,\n+        COUNT(DISTINCT json_extract(me.payload, '$.customer_id')) as customer_count,\n+        COUNT(*) as event_count\n+      FROM meter_events me\n+      JOIN meters m ON me.event_name = m.event_name\n+      WHERE me.livemode = :livemode \n+        AND CAST(me.credit_pending AS DECIMAL(40,0)) > 0\n+      GROUP BY m.currency_id\n+      HAVING total_pending > 0\n+      ORDER BY total_pending DESC`,\n+      {\n+        replacements: { livemode: req.livemode ? 1 : 0 },\n+        type: QueryTypes.SELECT,\n+      }\n+    );\n+\n+    // Fetch currency details\n+    const currencyIds = results.map((r) => r.currency_id);\n+    const currencies =\n+      currencyIds.length > 0 ? await PaymentCurrency.findAll({ where: { id: { [Op.in]: currencyIds } } }) : [];\n+    const currencyMap = new Map(currencies.map((c) => [c.id, c]));\n+\n+    const list = results.map((r) => ({\n+      currency: currencyMap.get(r.currency_id),\n+      total_pending: r.total_pending,\n+      customer_count: r.customer_count,\n+      event_count: r.event_count,\n+    }));\n+\n+    return res.json({ list });\n+  } catch (err) {\n+    logger.error('Error getting overdue summary', err);\n+    return res.status(400).json({ error: err?.message });\n+  }\n+});\n+\n+// Get all customers with credit overdue (pending amount > 0)\n+router.get('/overdue-customers', auth, async (req, res) => {\n+  try {\n+    const page = Math.max(1, parseInt(String(req.query.page || '1'), 10));\n+    const pageSize = Math.min(100, Math.max(1, parseInt(String(req.query.pageSize || '20'), 10)));\n+    const offset = (page - 1) * pageSize;\n+    const currencyId = req.query.currency_id as string | undefined;\n+    const searchQuery = req.query.q as string | undefined;\n+\n+    // Get currency info\n+    let currency: PaymentCurrency | null = null;\n+    if (currencyId) {\n+      currency = await PaymentCurrency.findByPk(currencyId);\n+      if (!currency) {\n+        return res.status(404).json({ error: `Currency ${currencyId} not found` });\n+      }\n+    }\n+\n+    // If search query provided, first find matching customer IDs\n+    let customerFilter = '';\n+    const replacements: any = { livemode: req.livemode ? 1 : 0, limit: pageSize, offset };\n+    if (currencyId) {\n+      replacements.currencyId = currencyId;\n+    }\n+\n+    if (searchQuery) {\n+      const searchCustomers = await Customer.findAll({\n+        where: {\n+          [Op.or]: [\n+            { name: { [Op.like]: `%${searchQuery}%` } },\n+            { email: { [Op.like]: `%${searchQuery}%` } },\n+            { did: { [Op.like]: `%${searchQuery}%` } },\n+          ],\n+        },\n+        attributes: ['id'],\n+      });\n+      const searchCustomerIds = searchCustomers.map((c) => c.id);\n+      if (searchCustomerIds.length === 0) {\n+        return res.json({ list: [], count: 0, paging: { page, pageSize }, currency });\n+      }\n+      customerFilter = `AND json_extract(me.payload, '$.customer_id') IN (${searchCustomerIds.map((id) => `'${id}'`).join(',')})`;\n+    }\n+\n+    // Build query with optional currency filter\n+    const currencyJoin = currencyId\n+      ? 'JOIN meters m ON me.event_name = m.event_name AND m.currency_id = :currencyId'\n+      : '';\n+\n+    // Query to aggregate credit_pending by customer, order by event_count DESC\n+    const results = await MeterEvent.sequelize!.query<{\n+      customer_id: string;\n+      total_pending: string;\n+      event_count: number;\n+    }>(\n+      `SELECT \n+        json_extract(me.payload, '$.customer_id') as customer_id,\n+        SUM(CAST(me.credit_pending AS DECIMAL(40,0))) as total_pending,\n+        COUNT(*) as event_count\n+      FROM meter_events me\n+      ${currencyJoin}\n+      WHERE me.livemode = :livemode \n+        AND CAST(me.credit_pending AS DECIMAL(40,0)) > 0\n+        ${customerFilter}\n+      GROUP BY json_extract(me.payload, '$.customer_id')\n+      HAVING total_pending > 0\n+      ORDER BY event_count DESC\n+      LIMIT :limit OFFSET :offset`,\n+      {\n+        replacements,\n+        type: QueryTypes.SELECT,\n+      }\n+    );\n+\n+    // Get total count\n+    const countResult = await MeterEvent.sequelize!.query<{ count: number }>(\n+      `SELECT COUNT(*) as count FROM (\n+        SELECT json_extract(me.payload, '$.customer_id') as customer_id\n+        FROM meter_events me\n+        ${currencyJoin}\n+        WHERE me.livemode = :livemode \n+          AND CAST(me.credit_pending AS DECIMAL(40,0)) > 0\n+          ${customerFilter}\n+        GROUP BY json_extract(me.payload, '$.customer_id')\n+        HAVING SUM(CAST(me.credit_pending AS DECIMAL(40,0))) > 0\n+      )`,\n+      {\n+        replacements: { livemode: req.livemode ? 1 : 0, ...(currencyId ? { currencyId } : {}) },\n+        type: QueryTypes.SELECT,\n+      }\n+    );\n+\n+    const count = countResult[0]?.count || 0;\n+    const customerIds = results.map((r) => r.customer_id);\n+\n+    // Fetch customer details\n+    const customers = customerIds.length > 0 ? await Customer.findAll({ where: { id: { [Op.in]: customerIds } } }) : [];\n+    const customerMap = new Map(customers.map((c) => [c.id, c]));\n+\n+    const list = results.map((r) => ({\n+      customer: customerMap.get(r.customer_id),\n+      total_pending: r.total_pending,\n+      event_count: r.event_count,\n+    }));\n+\n+    return res.json({ list, count, paging: { page, pageSize }, currency });\n+  } catch (err) {\n+    logger.error('Error getting overdue customers', err);\n+    return res.status(400).json({ error: err?.message });\n+  }\n+});\n router.get('/:id', authMine, async (req, res) => {\n   try {\n     logger.info('get meter event', { id: req.params.id });\ndiff --git a/blocklets/core/src/components/customer/credit-overview.tsx b/blocklets/core/src/components/customer/credit-overview.tsx\nindex 2645c9b40..d4ac2bf11 100644\n--- a/blocklets/core/src/components/customer/credit-overview.tsx\n+++ b/blocklets/core/src/components/customer/credit-overview.tsx\n@@ -259,7 +259,13 @@ export default function CreditOverview({ customerId, settings, mode = 'portal' }\n \n   const filteredCreditCurrencies = useMemo(() => {\n     return creditCurrencies.filter((currency: TPaymentCurrency) => {\n-      return creditSummary?.grants?.[currency.id];\n+      const grantData = creditSummary?.grants?.[currency.id];\n+      if (!grantData) return false;\n+      // Filter out credits with zero balance\n+      if (grantData.totalAmount === '0' && grantData.remainingAmount === '0') {\n+        return false;\n+      }\n+      return true;\n     });\n   }, [creditCurrencies, creditSummary?.grants]);\n \ndiff --git a/blocklets/core/src/locales/en.tsx b/blocklets/core/src/locales/en.tsx\nindex 74dfcb96c..9ab22eecb 100644\n--- a/blocklets/core/src/locales/en.tsx\n+++ b/blocklets/core/src/locales/en.tsx\n@@ -181,6 +181,14 @@ export default flat({\n         transaction: 'Transaction Metrics',\n         essential: 'Essential Metrics',\n       },\n+      overdue: {\n+        title: 'Credit Overdue',\n+        subtitle: 'Unpaid credit consumption',\n+        customers: '{count} customers',\n+        events: '{count} overdue events',\n+        viewAll: 'View All',\n+        noOverdue: 'No overdue records',\n+      },\n     },\n     payments: 'Payments',\n     connections: 'Connections',\n@@ -270,6 +278,13 @@ export default flat({\n     meterEvents: {\n       title: 'Meter Events',\n     },\n+    overdue: {\n+      title: 'Overdue',\n+      pendingAmount: 'Overdue Amount',\n+      eventCount: 'Overdue Events',\n+      noOverdue: 'No overdue records',\n+      selectCurrency: 'Credit',\n+    },\n     meter: {\n       add: 'Add meter',\n       edit: 'Edit meter',\ndiff --git a/blocklets/core/src/locales/zh.tsx b/blocklets/core/src/locales/zh.tsx\nindex 95a4d6337..ac9946dbd 100644\n--- a/blocklets/core/src/locales/zh.tsx\n+++ b/blocklets/core/src/locales/zh.tsx\n@@ -180,6 +180,14 @@ export default flat({\n         transaction: '交易指标',\n         essential: '关键指标',\n       },\n+      overdue: {\n+        title: '欠费总览',\n+        subtitle: '待支付的 Credit 消费',\n+        customers: '{count} 位用户',\n+        events: '{count} 个欠费事件',\n+        viewAll: '查看全部',\n+        noOverdue: '暂无欠费记录',\n+      },\n     },\n     payments: '支付管理',\n     connections: '连接',\n@@ -267,6 +275,13 @@ export default flat({\n     meterEvents: {\n       title: '计量事件',\n     },\n+    overdue: {\n+      title: '欠费记录',\n+      pendingAmount: '欠费金额',\n+      eventCount: '欠费事件数',\n+      noOverdue: '暂无欠费记录',\n+      selectCurrency: 'Credit',\n+    },\n     meter: {\n       add: '添加计量器',\n       edit: '编辑计量器',\ndiff --git a/blocklets/core/src/pages/admin/billing/index.tsx b/blocklets/core/src/pages/admin/billing/index.tsx\nindex 84872b515..120c99528 100644\n--- a/blocklets/core/src/pages/admin/billing/index.tsx\n+++ b/blocklets/core/src/pages/admin/billing/index.tsx\n@@ -16,6 +16,7 @@ const pages = {\n   invoices: React.lazy(() => import('./invoices')),\n   subscriptions: React.lazy(() => import('./subscriptions')),\n   meters: React.lazy(() => import('./meters')),\n+  overdue: React.lazy(() => import('./overdue')),\n };\n \n export default function BillingIndex() {\n@@ -52,6 +53,7 @@ export default function BillingIndex() {\n     { label: t('admin.invoices'), value: 'invoices' },\n     { label: t('admin.subscriptions'), value: 'subscriptions' },\n     { label: t('admin.meters'), value: 'meters' },\n+    { label: t('admin.overdue.title'), value: 'overdue' },\n   ];\n \n   let extra = null;\ndiff --git a/blocklets/core/src/pages/admin/billing/overdue/index.tsx b/blocklets/core/src/pages/admin/billing/overdue/index.tsx\nnew file mode 100644\nindex 000000000..420e12083\n--- /dev/null\n+++ b/blocklets/core/src/pages/admin/billing/overdue/index.tsx\n@@ -0,0 +1,286 @@\n+/* eslint-disable react/no-unstable-nested-components */\n+import { useLocaleContext } from '@arcblock/ux/lib/Locale/context';\n+import { api, formatBNStr, formatCreditAmount, Table, useDefaultPageSize } from '@blocklet/payment-react';\n+import type { TCustomer, TPaymentCurrency } from '@blocklet/payment-types';\n+import { Add, Close } from '@mui/icons-material';\n+import { Box, Button, CircularProgress, Menu, MenuItem, styled } from '@mui/material';\n+import { useEffect, useState } from 'react';\n+import { useLocalStorageState } from 'ahooks';\n+import { useSearchParams } from 'react-router-dom';\n+import CustomerLink from '../../../../components/customer/link';\n+\n+type OverdueCustomer = {\n+  customer: TCustomer;\n+  total_pending: string;\n+  event_count: number;\n+};\n+\n+type SearchProps = {\n+  pageSize: number;\n+  page: number;\n+  currency_id: string;\n+  q?: string;\n+};\n+\n+type ApiResponse = {\n+  list: OverdueCustomer[];\n+  count: number;\n+  paging: { page: number; pageSize: number };\n+  currency: TPaymentCurrency | null;\n+};\n+\n+const fetchData = (params: Record<string, any> = {}): Promise<ApiResponse> => {\n+  const search = new URLSearchParams();\n+  Object.keys(params).forEach((key) => {\n+    const v = params[key];\n+    if (v !== undefined && v !== null && v !== '') {\n+      search.set(key, String(v));\n+    }\n+  });\n+  return api.get(`/api/meter-events/overdue-customers?${search.toString()}`).then((res) => res.data);\n+};\n+\n+const fetchCreditCurrencies = (): Promise<TPaymentCurrency[]> => {\n+  return api.get('/api/payment-currencies?credit=true').then((res) => {\n+    // Filter to only return credit type currencies\n+    return (res.data || []).filter((c: TPaymentCurrency) => c.type === 'credit');\n+  });\n+};\n+\n+export default function OverdueList() {\n+  const listKey = 'overdue-customers';\n+\n+  const { t } = useLocaleContext();\n+  const defaultPageSize = useDefaultPageSize(20);\n+  const [searchParams, setSearchParams] = useSearchParams();\n+\n+  const [currencies, setCurrencies] = useState<TPaymentCurrency[]>([]);\n+  const [search, setSearch] = useLocalStorageState<SearchProps>(listKey, {\n+    defaultValue: {\n+      pageSize: defaultPageSize,\n+      page: 1,\n+      currency_id: '',\n+    },\n+  });\n+  const [data, setData] = useState<ApiResponse | null>(null);\n+  const [loading, setLoading] = useState(true);\n+\n+  // Load credit currencies on mount\n+  useEffect(() => {\n+    fetchCreditCurrencies().then((list) => {\n+      setCurrencies(list);\n+      // Check if currency_id is provided in URL\n+      const urlCurrencyId = searchParams.get('currency_id');\n+      if (urlCurrencyId && list.some((c) => c.id === urlCurrencyId)) {\n+        // Use URL parameter and clear it from URL\n+        setSearch((prev: any) => ({ ...prev, currency_id: urlCurrencyId, page: 1 }));\n+        setSearchParams({}, { replace: true });\n+      } else if (!search?.currency_id) {\n+        // Auto select first currency if not selected\n+        const firstCurrency = list[0];\n+        if (firstCurrency) {\n+          setSearch((prev: any) => ({ ...prev, currency_id: firstCurrency.id, page: 1 }));\n+        }\n+      }\n+    });\n+  }, []);\n+\n+  useEffect(() => {\n+    if (search?.currency_id) {\n+      setLoading(true);\n+      fetchData(search)\n+        .then((res) => setData(res))\n+        .finally(() => setLoading(false));\n+    } else {\n+      setData({ list: [], count: 0, paging: { page: 1, pageSize: 20 }, currency: null });\n+      setLoading(false);\n+    }\n+  }, [search]);\n+\n+  const selectedCurrency = data?.currency || currencies.find((c) => c.id === search?.currency_id);\n+\n+  const columns = [\n+    {\n+      label: t('common.customer'),\n+      name: 'customer',\n+      options: {\n+        customBodyRenderLite: (_: string, index: number) => {\n+          const item = data?.list[index] as OverdueCustomer | undefined;\n+          if (!item) return null;\n+          return <CustomerLink customer={item.customer} />;\n+        },\n+      },\n+    },\n+    {\n+      label: t('admin.overdue.pendingAmount'),\n+      name: 'total_pending',\n+      options: {\n+        customBodyRenderLite: (_: string, index: number) => {\n+          const item = data?.list[index] as OverdueCustomer | undefined;\n+          if (!item) return null;\n+          return (\n+            <Box component=\"span\" sx={{ fontWeight: 600, color: 'error.main' }}>\n+              -\n+              {formatCreditAmount(\n+                formatBNStr(item.total_pending, selectedCurrency?.decimal || 18),\n+                selectedCurrency?.symbol || ''\n+              )}\n+            </Box>\n+          );\n+        },\n+      },\n+    },\n+    {\n+      label: t('admin.overdue.eventCount'),\n+      name: 'event_count',\n+      options: {\n+        customBodyRenderLite: (_: string, index: number) => {\n+          const item = data?.list[index] as OverdueCustomer | undefined;\n+          if (!item) return null;\n+          return item.event_count;\n+        },\n+      },\n+    },\n+  ];\n+\n+  const onTableChange = ({ page, rowsPerPage }: any) => {\n+    if (search!.pageSize !== rowsPerPage) {\n+      setSearch((x: any) => ({ ...x, pageSize: rowsPerPage, page: 1 }));\n+    } else if (search!.page !== page + 1) {\n+      setSearch((x: any) => ({ ...x, page: page + 1 }));\n+    }\n+  };\n+\n+  const handleCurrencyChange = (currencyId: string) => {\n+    setSearch((prev: any) => ({ ...prev, currency_id: currencyId, page: 1 }));\n+  };\n+\n+  if (loading && !data) {\n+    return <CircularProgress />;\n+  }\n+\n+  return (\n+    <Table\n+      data={data?.list || []}\n+      durable={`__${listKey}__`}\n+      durableKeys={['page', 'rowsPerPage', 'searchText']}\n+      columns={columns}\n+      loading={loading}\n+      onChange={onTableChange}\n+      options={{\n+        count: data?.count || 0,\n+        page: search!.page - 1,\n+        rowsPerPage: search!.pageSize,\n+        onSearchChange: (text: string) => {\n+          setSearch((prev: any) => ({\n+            ...prev,\n+            q: text || undefined,\n+            page: 1,\n+          }));\n+        },\n+      }}\n+      title={\n+        <CurrencyFilter\n+          currencies={currencies}\n+          selectedCurrencyId={search?.currency_id || ''}\n+          onChange={handleCurrencyChange}\n+        />\n+      }\n+      emptyNodeText={t('admin.overdue.noOverdue')}\n+    />\n+  );\n+}\n+\n+function CurrencyFilter({\n+  currencies,\n+  selectedCurrencyId,\n+  onChange,\n+}: {\n+  currencies: TPaymentCurrency[];\n+  selectedCurrencyId: string;\n+  onChange: (currencyId: string) => void;\n+}) {\n+  const [anchorEl, setAnchorEl] = useState<HTMLElement | null>(null);\n+  const { t } = useLocaleContext();\n+  const selectedCurrency = currencies.find((c) => c.id === selectedCurrencyId);\n+\n+  return (\n+    <Root>\n+      <Box className=\"table-toolbar-left\">\n+        <section>\n+          <Button className=\"option-btn\" variant=\"text\" onClick={(e) => setAnchorEl(e.currentTarget)}>\n+            {selectedCurrencyId ? (\n+              <Close\n+                sx={{ color: 'text.secondary', cursor: 'pointer', fontSize: '1.05rem' }}\n+                onClick={(e) => {\n+                  e.stopPropagation();\n+                  onChange('');\n+                  setAnchorEl(null);\n+                }}\n+              />\n+            ) : (\n+              <Add sx={{ color: 'text.secondary', cursor: 'pointer', fontSize: '1.05rem' }} />\n+            )}\n+            {t('admin.overdue.selectCurrency')}\n+            <span>{selectedCurrency?.symbol}</span>\n+          </Button>\n+          <Menu\n+            anchorEl={anchorEl}\n+            open={Boolean(anchorEl)}\n+            onClose={() => setAnchorEl(null)}\n+            className=\"status-options\">\n+            {currencies.map((currency) => (\n+              <MenuItem\n+                key={currency.id}\n+                onClick={() => {\n+                  onChange(currency.id);\n+                  setAnchorEl(null);\n+                }}>\n+                {currency.symbol} - {currency.name}\n+              </MenuItem>\n+            ))}\n+          </Menu>\n+        </section>\n+      </Box>\n+    </Root>\n+  );\n+}\n+\n+const Root = styled(Box)`\n+  .table-toolbar-left {\n+    display: flex;\n+    align-items: center;\n+  }\n+\n+  .table-toolbar-left section {\n+    position: relative;\n+    list-style: none;\n+    font-size: 14px;\n+    font-weight: normal;\n+    padding: 0 5px;\n+    cursor: pointer;\n+  }\n+\n+  .option-btn {\n+    display: flex;\n+    align-items: center;\n+    border-radius: 25px;\n+    background: ${({ theme }) => theme.palette.grey[100]};\n+    padding: 5px 10px;\n+    color: ${({ theme }) => theme.palette.text.secondary};\n+    font-size: 14px;\n+    line-height: 14px;\n+    overflow: visible;\n+  }\n+\n+  .option-btn span {\n+    color: #3773f2;\n+    padding: 0 3px;\n+    overflow: visible;\n+  }\n+\n+  .status-options {\n+    max-height: 300px;\n+    overflow-y: auto;\n+  }\n+`;\ndiff --git a/blocklets/core/src/pages/admin/customers/customers/credit-transaction/detail.tsx b/blocklets/core/src/pages/admin/customers/customers/credit-transaction/detail.tsx\nindex 0bf13f78f..cc4f6ef83 100644\n--- a/blocklets/core/src/pages/admin/customers/customers/credit-transaction/detail.tsx\n+++ b/blocklets/core/src/pages/admin/customers/customers/credit-transaction/detail.tsx\n@@ -3,6 +3,7 @@ import {\n   api,\n   formatBNStr,\n   formatError,\n+  formatTime,\n   getCustomerAvatar,\n   TxLink,\n   SourceDataViewer,\n@@ -295,6 +296,20 @@ export default function AdminCreditTransactionDetail({ id }: { id: string }) {\n                   }\n                 />\n               )}\n+              <InfoRow\n+                label={t('admin.meterEvent.reportedAt')}\n+                value={formatTime(\n+                  data.meterEvent?.timestamp\n+                    ? data.meterEvent.timestamp * 1000\n+                    : data.meterEvent?.created_at || data.created_at\n+                )}\n+              />\n+              <InfoRow\n+                label={t('admin.meterEvent.processedAt')}\n+                value={formatTime(\n+                  data.meterEvent?.processed_at ? data.meterEvent.processed_at * 1000 : data.created_at\n+                )}\n+              />\n             </InfoRowGroup>\n           </Box>\n \ndiff --git a/blocklets/core/src/pages/admin/overview.tsx b/blocklets/core/src/pages/admin/overview.tsx\nindex b5a5555e0..1ce8ada88 100644\n--- a/blocklets/core/src/pages/admin/overview.tsx\n+++ b/blocklets/core/src/pages/admin/overview.tsx\n@@ -1,7 +1,7 @@\n /* eslint-disable react/require-default-props */\n import DID from '@arcblock/ux/lib/DID';\n import { useLocaleContext } from '@arcblock/ux/lib/Locale/context';\n-import { api, formatBNStr, formatToDate, usePaymentContext } from '@blocklet/payment-react';\n+import { api, formatBNStr, formatCreditAmount, formatToDate, usePaymentContext } from '@blocklet/payment-react';\n import { BN } from '@ocap/util';\n import type { GroupedBN, TPaymentCurrency, TPaymentMethod, TPaymentStat } from '@blocklet/payment-types';\n import {\n@@ -37,6 +37,7 @@ import {\n   PaymentsOutlined,\n   Refresh,\n   SellOutlined,\n+  WarningAmber,\n } from '@mui/icons-material';\n import Chart, { TCurrencyMap, TCurrency } from '../../components/chart';\n import CurrencySelect from '../../components/price/currency-select';\n@@ -302,8 +303,31 @@ export default function Overview() {\n     }\n   );\n \n+  const overdueSummary = useRequest<\n+    {\n+      list: Array<{\n+        currency: TPaymentCurrency;\n+        total_pending: string;\n+        customer_count: number;\n+        event_count: number;\n+      }>;\n+    },\n+    any\n+  >(\n+    async () => {\n+      const result = await api.get('/api/meter-events/overdue-summary');\n+      return result.data;\n+    },\n+    {\n+      refreshDeps: [],\n+    }\n+  );\n+\n   const summaryLoading = summary.loading;\n   const trendLoading = trend.loading;\n+  const overdueLoading = overdueSummary.loading;\n+  const overdueList = overdueSummary.data?.list || [];\n+  const hasOverdue = overdueList.length > 0;\n   const summaryData = summary.data;\n   const summarySummary = summaryData?.summary;\n   const addresses = summaryData?.addresses;\n@@ -954,6 +978,8 @@ export default function Overview() {\n     </Stack>\n   );\n \n+  const showOverdueCard = overdueLoading || hasOverdue;\n+\n   const renderBusinessMonitoringSection = () => (\n     <Stack direction=\"column\" spacing={3}>\n       <Typography variant=\"h5\" sx={{ fontWeight: 600 }}>\n@@ -1072,6 +1098,108 @@ export default function Overview() {\n           </Stack>\n         </Card>\n       )}\n+      {showOverdueCard && (\n+        <Card\n+          variant=\"outlined\"\n+          sx={{\n+            p: 2,\n+            borderRadius: 1,\n+          }}>\n+          <Stack\n+            direction=\"row\"\n+            sx={{\n+              alignItems: 'center',\n+              mb: 2,\n+            }}>\n+            <Box\n+              sx={{\n+                width: 40,\n+                height: 40,\n+                borderRadius: 1,\n+                display: 'flex',\n+                alignItems: 'center',\n+                justifyContent: 'center',\n+                backgroundColor: alpha(theme.palette.warning.main, 0.12),\n+                mr: 1.5,\n+              }}>\n+              <WarningAmber sx={{ color: 'warning.main', fontSize: 24 }} />\n+            </Box>\n+            <Box>\n+              <Typography component=\"h3\" variant=\"h5\">\n+                {t('admin.overviewPage.overdue.title')}\n+              </Typography>\n+              <Typography variant=\"caption\" sx={{ color: 'text.secondary' }}>\n+                {t('admin.overviewPage.overdue.subtitle')}\n+              </Typography>\n+            </Box>\n+          </Stack>\n+          <Stack spacing={1}>\n+            {overdueLoading\n+              ? BALANCE_SKELETON_KEYS.slice(0, 2).map((placeholder) => (\n+                  <Skeleton key={`overdue-skeleton-${placeholder}`} variant=\"rounded\" height={56} />\n+                ))\n+              : overdueList.map((item) => (\n+                  <Stack\n+                    key={item.currency.id}\n+                    component={Link}\n+                    to={`/admin/billing/overdue?currency_id=${item.currency.id}`}\n+                    direction=\"row\"\n+                    spacing={1}\n+                    sx={{\n+                      alignItems: 'center',\n+                      textDecoration: 'none',\n+                      backgroundColor: theme.mode === 'dark' ? 'grey.100' : 'grey.50',\n+                      color: 'inherit',\n+                      p: 1.5,\n+                      borderRadius: 1.5,\n+                      transition: 'background-color 0.2s ease-in-out',\n+                      '&:hover': {\n+                        backgroundColor: 'action.hover',\n+                        '& .arrow-icon': {\n+                          opacity: 1,\n+                          transform: 'translateX(0)',\n+                        },\n+                      },\n+                    }}>\n+                    <Avatar src={item.currency.logo} alt={item.currency.symbol} sx={{ width: 28, height: 28 }} />\n+                    <Box sx={{ flex: 1, minWidth: 0 }}>\n+                      <Typography variant=\"body2\" sx={{ fontWeight: 600 }}>\n+                        {item.currency.name}\n+                      </Typography>\n+                      <Typography variant=\"caption\" sx={{ color: 'text.secondary' }}>\n+                        {t('admin.overviewPage.overdue.customers', { count: item.customer_count })}\n+                        {' · '}\n+                        {t('admin.overviewPage.overdue.events', { count: item.event_count })}\n+                      </Typography>\n+                    </Box>\n+                    <Typography\n+                      variant=\"body2\"\n+                      sx={{\n+                        fontWeight: 600,\n+                        textAlign: 'right',\n+                        color: 'warning.main',\n+                      }}>\n+                      -\n+                      {formatCreditAmount(\n+                        formatBNStr(item.total_pending, item.currency.decimal ?? 0),\n+                        item.currency.symbol\n+                      )}\n+                    </Typography>\n+                    <ArrowForward\n+                      className=\"arrow-icon\"\n+                      fontSize=\"small\"\n+                      sx={{\n+                        opacity: 0,\n+                        transform: 'translateX(-10px)',\n+                        transition: 'all 0.2s ease-in-out',\n+                        color: 'text.secondary',\n+                      }}\n+                    />\n+                  </Stack>\n+                ))}\n+          </Stack>\n+        </Card>\n+      )}\n       {showMetricsCard && (\n         <Card\n           variant=\"outlined\"\ndiff --git a/blocklets/core/src/pages/customer/credit-transaction/detail.tsx b/blocklets/core/src/pages/customer/credit-transaction/detail.tsx\nindex 6e33c38eb..41409d48a 100644\n--- a/blocklets/core/src/pages/customer/credit-transaction/detail.tsx\n+++ b/blocklets/core/src/pages/customer/credit-transaction/detail.tsx\n@@ -270,6 +270,18 @@ export default function CustomerCreditTransactionDetail() {\n               }\n             />\n           )}\n+          <InfoRow\n+            label={t('admin.meterEvent.reportedAt')}\n+            value={formatTime(\n+              data.meterEvent?.timestamp\n+                ? data.meterEvent.timestamp * 1000\n+                : data.meterEvent?.created_at || data.created_at\n+            )}\n+          />\n+          <InfoRow\n+            label={t('admin.meterEvent.processedAt')}\n+            value={formatTime(data.meterEvent?.processed_at ? data.meterEvent.processed_at * 1000 : data.created_at)}\n+          />\n         </InfoRowGroup>\n       </Box>\n \ndiff --git a/packages/react/src/contexts/payment.tsx b/packages/react/src/contexts/payment.tsx\nindex 3bf66e157..4833e6318 100644\n--- a/packages/react/src/contexts/payment.tsx\n+++ b/packages/react/src/contexts/payment.tsx\n@@ -7,6 +7,7 @@ import { createContext, useContext, useEffect, useState } from 'react';\n \n import axios from 'axios';\n import { joinURL } from 'ufo';\n+import useBus from 'use-bus';\n import api from '../libs/api';\n import { getPrefix, PAYMENT_KIT_DID } from '../libs/util';\n import { CachedRequest } from '../libs/cached-request';\n@@ -178,6 +179,14 @@ function PaymentProvider({\n     refreshDeps: [livemode],\n   });\n \n+  // Listen for settings changes and force refresh\n+  useBus(\n+    // @ts-ignore\n+    ['paymentMethod.created', 'paymentMethod.updated', 'paymentCurrency.added', 'paymentCurrency.updated'],\n+    () => run(true),\n+    [run]\n+  );\n+\n   useEffect(() => {\n     const didSpace = session?.user?.didSpace as\n       | {\ndiff --git a/packages/react/src/history/credit/transactions-list.tsx b/packages/react/src/history/credit/transactions-list.tsx\nindex 9920473ac..2693e9186 100644\n--- a/packages/react/src/history/credit/transactions-list.tsx\n+++ b/packages/react/src/history/credit/transactions-list.tsx\n@@ -84,6 +84,18 @@ const getTransactionDetailLink = (transactionId: string, inDashboard: boolean) =\n   };\n };\n \n+const getSubscriptionDetailLink = (subscriptionId: string, inDashboard: boolean) => {\n+  let path = `/customer/subscription/${subscriptionId}`;\n+  if (inDashboard) {\n+    path = `/admin/subscriptions/${subscriptionId}`;\n+  }\n+\n+  return {\n+    link: createLink(path),\n+    connect: false,\n+  };\n+};\n+\n const TransactionsTable = React.memo((props: Props) => {\n   const {\n     pageSize,\n@@ -174,112 +186,137 @@ const TransactionsTable = React.memo((props: Props) => {\n   };\n   const columns = [\n     {\n-      label: t('common.amount'),\n-      name: 'credit_amount',\n-      align: 'right',\n+      label: t('common.date'),\n+      name: 'created_at',\n       options: {\n+        setCellProps: () => ({ style: { width: '25%' } }),\n         customBodyRenderLite: (_: string, index: number) => {\n           const item = data?.list[index] as any;\n-          const isGrant = item.activity_type === 'grant';\n-          const isExpiredGrant = isGrant && item.status === 'expired';\n-          const amount = isGrant ? item.amount : item.credit_amount;\n-          const currency = item.paymentCurrency || item.currency;\n-          const unit = !isGrant && item.meter?.unit ? item.meter.unit : currency?.symbol;\n-          const displayAmount = formatCreditAmount(formatBNStr(amount, currency?.decimal || 0), unit);\n-\n-          if (!includeGrants) {\n-            return (\n-              <Box onClick={(e) => handleTransactionClick(e, item)}>\n-                <Typography>{displayAmount}</Typography>\n-              </Box>\n-            );\n-          }\n-\n-          const amountNode = (\n-            <Typography\n-              sx={{\n-                color: isGrant ? (isExpiredGrant ? 'text.disabled' : 'success.main') : 'error.main',\n-              }}>\n-              {isGrant ? '+' : '-'} {displayAmount}\n-            </Typography>\n-          );\n-\n           return (\n             <Box onClick={(e) => handleTransactionClick(e, item)}>\n-              <Stack direction=\"row\" spacing={1} alignItems=\"center\" justifyContent=\"flex-end\" sx={{ width: '100%' }}>\n-                {isExpiredGrant && (\n-                  <Chip\n-                    label={t('admin.creditGrants.status.expired')}\n-                    size=\"small\"\n-                    variant=\"outlined\"\n-                    sx={{\n-                      mr: 2,\n-                      height: 18,\n-                      fontSize: '12px',\n-                      color: 'text.disabled',\n-                      borderColor: 'text.disabled',\n-                    }}\n-                  />\n-                )}\n-                {amountNode}\n-              </Stack>\n+              <Typography variant=\"body2\" sx={{ fontSize: '0.875rem' }}>\n+                {formatToDate(item.created_at, locale, 'YYYY-MM-DD HH:mm')}\n+              </Typography>\n             </Box>\n           );\n         },\n       },\n     },\n     {\n-      label: t('common.creditGrant'),\n-      name: 'credit_grant',\n+      label: t('common.description'),\n+      name: 'description',\n       options: {\n+        setCellProps: () => ({ style: { width: '25%' } }),\n         customBodyRenderLite: (_: string, index: number) => {\n           const item = data?.list[index] as any;\n           const isGrant = item.activity_type === 'grant';\n-          const isExpiredGrant = isGrant && item.status === 'expired';\n-\n-          const grantName = isGrant ? item.name : item.creditGrant.name;\n-          const grantId = isGrant ? item.id : item.credit_grant_id;\n-          const nameNode = (\n-            <Typography variant=\"body2\" sx={{ cursor: 'pointer', color: isExpiredGrant ? 'text.disabled' : undefined }}>\n-              {grantName || `Grant ${grantId.slice(-6)}`}\n-            </Typography>\n-          );\n+\n+          // Grant types - use metadata.delivery_mode to determine if it's scheduled (refresh)\n+          // First scheduled refresh (seq === 1) with payment should show as paid\n+          const isScheduled = isGrant && item.metadata?.delivery_mode === 'schedule';\n+          const isPaid = isGrant && item.category === 'paid' && (!isScheduled || item.metadata?.schedule_seq === 1);\n+\n+          const isExpired =\n+            isGrant && (item.status === 'expired' || item.status === 'depleted' || item.status === 'voided');\n+\n+          let activityType = '';\n+          let secondLine = '';\n+\n+          if (!isGrant) {\n+            // Consumption\n+            activityType = t('common.creditActivity.consumption');\n+            secondLine = item.description || '';\n+          } else if (isPaid) {\n+            // Paid top-up\n+            activityType = t('common.creditActivity.paidGrant');\n+            // Show paid amount with invoice currency\n+            if (item.invoice?.total && item.invoice?.paymentCurrency) {\n+              const invoiceCurrency = item.invoice.paymentCurrency;\n+              const paidAmount = formatCreditAmount(\n+                formatBNStr(item.invoice.total, invoiceCurrency.decimal || 0),\n+                invoiceCurrency.symbol || ''\n+              );\n+              secondLine = t('common.creditActivity.paidAmount', { amount: paidAmount });\n+            } else {\n+              secondLine = item.description || '';\n+            }\n+          } else if (isScheduled) {\n+            // Scheduled delivery = credit refresh\n+            activityType = t('common.creditActivity.resetGrant');\n+            secondLine = item.description || '';\n+          } else {\n+            // Promotional/bonus\n+            activityType = t('common.creditActivity.promotionalGrant');\n+            secondLine = item.description || '';\n+          }\n+\n           return (\n-            <Stack\n-              direction=\"row\"\n-              spacing={1}\n-              onClick={(e) => {\n-                const link = getGrantDetailLink(grantId, isAdmin && mode === 'dashboard');\n-                handleNavigation(e, link.link, navigate);\n-              }}\n-              sx={{\n-                alignItems: 'center',\n-              }}>\n-              {nameNode}\n-            </Stack>\n+            <Box onClick={(e) => handleTransactionClick(e, item)} sx={{ cursor: !isGrant ? 'pointer' : 'default' }}>\n+              <Stack direction=\"column\" spacing={0.25}>\n+                <Typography\n+                  variant=\"body2\"\n+                  sx={{\n+                    color: isExpired ? 'text.secondary' : isGrant ? 'success.main' : 'error.main',\n+                  }}>\n+                  {activityType}\n+                </Typography>\n+                {secondLine && (\n+                  <Typography variant=\"caption\" sx={{ color: 'text.secondary' }}>\n+                    {secondLine}\n+                  </Typography>\n+                )}\n+              </Stack>\n+            </Box>\n           );\n         },\n       },\n     },\n     {\n-      label: t('common.description'),\n-      name: 'description',\n+      label: t('common.amount'),\n+      name: 'credit_amount',\n+      align: 'right',\n       options: {\n+        setCellProps: () => ({ style: { width: '20%' } }),\n+        customHeadLabelRender: () => <Box sx={{ pr: 5 }}>{t('common.amount')}</Box>,\n         customBodyRenderLite: (_: string, index: number) => {\n           const item = data?.list[index] as any;\n           const isGrant = item.activity_type === 'grant';\n-          const isExpiredGrant = isGrant && item.status === 'expired';\n-          const description = isGrant\n-            ? item.name || item.description || 'Credit Granted'\n-            : item.subscription?.description || item.description || `${item.meter_event_name} usage`;\n-\n-          const descriptionNode = (\n-            <Typography variant=\"body2\" sx={{ fontWeight: 400, color: isExpiredGrant ? 'text.disabled' : undefined }}>\n-              {description}\n-            </Typography>\n-          );\n+          const amount = isGrant ? item.amount : item.credit_amount;\n+          const currency = item.paymentCurrency || item.currency;\n+          const unit = !isGrant && item.meter?.unit ? item.meter.unit : currency?.symbol;\n+          const displayAmount = formatCreditAmount(formatBNStr(amount, currency?.decimal || 0), unit);\n+\n+          // Check if grant is expired or depleted\n+          const isExpired =\n+            isGrant && (item.status === 'expired' || item.status === 'depleted' || item.status === 'voided');\n+\n+          if (!includeGrants) {\n+            return (\n+              <Box onClick={(e) => handleTransactionClick(e, item)} sx={{ pr: 5 }}>\n+                <Typography>{displayAmount}</Typography>\n+              </Box>\n+            );\n+          }\n \n-          return <Box onClick={(e) => handleTransactionClick(e, item)}>{descriptionNode}</Box>;\n+          return (\n+            <Box onClick={(e) => handleTransactionClick(e, item)} sx={{ pr: 5 }}>\n+              <Stack direction=\"column\" spacing={0.25} alignItems=\"flex-end\">\n+                <Typography\n+                  sx={{\n+                    fontWeight: 500,\n+                    color: isExpired ? 'text.secondary' : isGrant ? 'success.main' : 'error.main',\n+                    whiteSpace: 'nowrap',\n+                  }}>\n+                  {isGrant ? '+' : '-'} {displayAmount}\n+                </Typography>\n+                {isExpired && (\n+                  <Typography variant=\"caption\" sx={{ color: 'text.secondary' }}>\n+                    {t('common.expired')}\n+                  </Typography>\n+                )}\n+              </Stack>\n+            </Box>\n+          );\n         },\n       },\n     },\n@@ -306,43 +343,58 @@ const TransactionsTable = React.memo((props: Props) => {\n           },\n         ]\n       : []),\n-    {\n-      label: t('common.date'),\n-      name: 'created_at',\n-      options: {\n-        customBodyRenderLite: (_: string, index: number) => {\n-          const item = data?.list[index] as any;\n-          return (\n-            <Box onClick={(e) => handleTransactionClick(e, item)}>\n-              <Typography\n-                variant=\"body2\"\n-                sx={{\n-                  color: 'text.secondary',\n-                  fontSize: '0.875rem',\n-                }}>\n-                {formatToDate(item.created_at, locale, 'YYYY-MM-DD HH:mm')}\n-              </Typography>\n-            </Box>\n-          );\n-        },\n-      },\n-    },\n     {\n       label: t('common.actions'),\n       name: 'actions',\n       options: {\n+        setCellProps: () => ({ style: { width: '25%' } }),\n         customBodyRenderLite: (_: string, index: number) => {\n           const item = data?.list[index] as any;\n           const isGrant = item.activity_type === 'grant';\n-          const invoiceId = isGrant ? item.metadata?.invoice_id : null;\n+          const isScheduled = isGrant && item.metadata?.delivery_mode === 'schedule';\n+          const isPaid = isGrant && item.category === 'paid' && !isScheduled;\n+          const subscriptionId =\n+            item.metadata?.subscription_id || item.subscription_id || item.invoice?.subscription_id;\n+          const invoiceId = isGrant ? item.metadata?.invoice_id || item.invoice?.id : null;\n \n           return (\n-            <Box sx={{ display: 'flex', gap: 1, alignItems: 'center' }}>\n-              {isGrant && invoiceId && (\n+            <Box sx={{ display: 'flex', gap: 1, alignItems: 'center', flexWrap: 'nowrap' }}>\n+              {/* Scheduled refresh: show subscription link */}\n+              {isScheduled && subscriptionId && (\n+                <Button\n+                  variant=\"text\"\n+                  size=\"small\"\n+                  color=\"primary\"\n+                  sx={{ whiteSpace: 'nowrap' }}\n+                  onClick={(e) => {\n+                    e.preventDefault();\n+                    const link = getSubscriptionDetailLink(subscriptionId, isAdmin && mode === 'dashboard');\n+                    handleNavigation(e, link.link, navigate);\n+                  }}>\n+                  {t('common.viewSubscription')}\n+                </Button>\n+              )}\n+              {/* Paid grant with subscription: show both subscription and invoice links */}\n+              {isPaid && subscriptionId && (\n+                <Button\n+                  variant=\"text\"\n+                  size=\"small\"\n+                  color=\"primary\"\n+                  sx={{ whiteSpace: 'nowrap' }}\n+                  onClick={(e) => {\n+                    e.preventDefault();\n+                    const link = getSubscriptionDetailLink(subscriptionId, isAdmin && mode === 'dashboard');\n+                    handleNavigation(e, link.link, navigate);\n+                  }}>\n+                  {t('common.viewSubscription')}\n+                </Button>\n+              )}\n+              {isPaid && invoiceId && (\n                 <Button\n                   variant=\"text\"\n                   size=\"small\"\n                   color=\"primary\"\n+                  sx={{ whiteSpace: 'nowrap' }}\n                   onClick={(e) => {\n                     e.preventDefault();\n                     const link = getInvoiceDetailLink(invoiceId, isAdmin && mode === 'dashboard');\n@@ -351,17 +403,19 @@ const TransactionsTable = React.memo((props: Props) => {\n                   {t('common.viewInvoice')}\n                 </Button>\n               )}\n-              {!isGrant && (\n+              {/* Consumption: show subscription link if available */}\n+              {!isGrant && subscriptionId && (\n                 <Button\n                   variant=\"text\"\n                   size=\"small\"\n                   color=\"primary\"\n+                  sx={{ whiteSpace: 'nowrap' }}\n                   onClick={(e) => {\n                     e.preventDefault();\n-                    const link = getTransactionDetailLink(item.id, isAdmin && mode === 'dashboard');\n+                    const link = getSubscriptionDetailLink(subscriptionId, isAdmin && mode === 'dashboard');\n                     handleNavigation(e, link.link, navigate);\n                   }}>\n-                  {t('common.viewDetail')}\n+                  {t('common.viewSubscription')}\n                 </Button>\n               )}\n             </Box>\ndiff --git a/packages/react/src/history/invoice/list.tsx b/packages/react/src/history/invoice/list.tsx\nindex 546bfce9e..890e2516d 100644\n--- a/packages/react/src/history/invoice/list.tsx\n+++ b/packages/react/src/history/invoice/list.tsx\n@@ -112,6 +112,7 @@ const InvoiceTable = React.memo((props: Props & { onPay: (invoiceId: string) =>\n   const listKey = 'invoice-table';\n   const { t, locale } = useLocaleContext();\n   const navigate = useNavigate();\n+  const { getCurrency } = usePaymentContext();\n \n   const [search, setSearch] = useState<{ pageSize: number; page: number }>({\n     pageSize: pageSize || 10,\n@@ -275,6 +276,70 @@ const InvoiceTable = React.memo((props: Props & { onPay: (invoiceId: string) =>\n               },\n             },\n           },\n+          // Credit column - shows credit from invoice lines\n+          {\n+            label: t('payment.customer.invoice.credit'),\n+            name: 'credit',\n+            align: 'right',\n+            options: {\n+              customBodyRenderLite: (_: string, index: number) => {\n+                const invoice = data?.list[index] as TInvoiceExpanded;\n+                // Get credit products from invoice lines (works for both subscription and one-time purchase)\n+                const creditItems = (invoice as any).lines?.filter(\n+                  (item: any) => item.price?.product?.type === 'credit'\n+                );\n+\n+                if (creditItems && creditItems.length > 0) {\n+                  return (\n+                    <Box onClick={(e) => handleLinkClick(e, invoice)} sx={linkStyle}>\n+                      {creditItems.map((item: any, i: number) => {\n+                        const creditConfig = item.price?.metadata?.credit_config;\n+                        const scheduleConfig = creditConfig?.schedule;\n+                        const isSchedule = scheduleConfig?.enabled && scheduleConfig?.delivery_mode === 'schedule';\n+\n+                        // For schedule mode: use amount_per_grant; for one-time: use credit_amount * quantity\n+                        const creditAmount = isSchedule\n+                          ? scheduleConfig?.amount_per_grant || 0\n+                          : (Number(creditConfig?.credit_amount) || 0) * (item.quantity || 1);\n+\n+                        const intervalValue = scheduleConfig?.interval_value;\n+                        const intervalUnit = scheduleConfig?.interval_unit;\n+                        // Get currency symbol from PaymentContext\n+                        const currencySymbol = getCurrency(creditConfig?.currency_id)?.symbol || '';\n+\n+                        return (\n+                          <Stack key={item.id || i} direction=\"column\" spacing={0}>\n+                            {i > 0 && <Box sx={{ height: 4 }} />}\n+                            <Typography\n+                              component=\"span\"\n+                              sx={{ color: 'success.main', fontWeight: 500, whiteSpace: 'nowrap' }}>\n+                              +{creditAmount} {currencySymbol}\n+                            </Typography>\n+                            {isSchedule && intervalValue && intervalUnit && (\n+                              <Typography\n+                                component=\"span\"\n+                                variant=\"caption\"\n+                                sx={{ color: 'text.secondary', whiteSpace: 'nowrap' }}>\n+                                {t('payment.customer.invoice.creditRefresh', {\n+                                  interval: intervalValue,\n+                                  unit: t(`common.${intervalUnit}`),\n+                                })}\n+                              </Typography>\n+                            )}\n+                          </Stack>\n+                        );\n+                      })}\n+                    </Box>\n+                  );\n+                }\n+                return (\n+                  <Box onClick={(e) => handleLinkClick(e, invoice)} sx={{ ...linkStyle, color: 'text.lighter' }}>\n+                    -\n+                  </Box>\n+                );\n+              },\n+            },\n+          },\n         ]\n       : []),\n     {\n@@ -296,23 +361,6 @@ const InvoiceTable = React.memo((props: Props & { onPay: (invoiceId: string) =>\n         },\n       },\n     },\n-\n-    {\n-      label: t('common.description'),\n-      name: '',\n-      options: {\n-        sort: false,\n-        customBodyRenderLite: (val: string, index: number) => {\n-          const invoice = data?.list[index] as TInvoiceExpanded;\n-\n-          return (\n-            <Box onClick={(e) => handleLinkClick(e, invoice)} sx={linkStyle}>\n-              {getInvoiceDescriptionAndReason(invoice, locale)?.description || invoice.id}\n-            </Box>\n-          );\n-        },\n-      },\n-    },\n     {\n       label: t('common.status'),\n       name: 'status',\ndiff --git a/packages/react/src/locales/en.tsx b/packages/react/src/locales/en.tsx\nindex 1c21ec03f..8d4a6f334 100644\n--- a/packages/react/src/locales/en.tsx\n+++ b/packages/react/src/locales/en.tsx\n@@ -67,14 +67,22 @@ export default flat({\n     remainingBalance: 'Remaining Balance',\n     credits: 'credits',\n     ofCredits: 'of credits',\n+    creditActivity: {\n+      consumption: 'Credit Consumed',\n+      paidGrant: 'Credit Top-up',\n+      paidAmount: 'Paid {amount}',\n+      promotionalGrant: 'Bonus',\n+      resetGrant: 'Credit Reset',\n+    },\n     transferStatus: 'Transaction Status',\n     sourceData: 'Source Data',\n     viewGrant: 'View Grant',\n-    viewSubscription: 'View Subscription',\n+    viewSubscription: 'Subscription Detail',\n     view: 'View',\n     meterEvent: 'Meter Event',\n     source: 'Source',\n     viewDetail: 'View Detail',\n+    viewTransactionDetail: 'Transaction Detail',\n     customer: 'Customer',\n     currency: 'Currency',\n     custom: 'Custom',\n@@ -128,8 +136,9 @@ export default flat({\n       cancel: 'Cancel',\n     },\n     paymentMethod: 'Payment Method',\n-    viewInvoice: 'View Invoice',\n+    viewInvoice: 'Invoice Detail',\n     submit: 'Submit',\n+    expired: 'Expired',\n   },\n   payment: {\n     checkout: {\n@@ -516,6 +525,8 @@ export default flat({\n         paymentConfirmDescription:\n           'After completing this payment, the payment method you use will be automatically set as the default for this subscription. Additionally, we will retry payment for any other unpaid invoices associated with this subscription.',\n         continue: 'Continue',\n+        credit: 'Credit',\n+        creditRefresh: 'Refresh every {interval} {unit}',\n       },\n       overduePayment: {\n         setupPaymentDescription: 'Use your saved card or add a new one to complete payment via Stripe.',\ndiff --git a/packages/react/src/locales/zh.tsx b/packages/react/src/locales/zh.tsx\nindex fa94bb449..6f799e999 100644\n--- a/packages/react/src/locales/zh.tsx\n+++ b/packages/react/src/locales/zh.tsx\n@@ -67,14 +67,22 @@ export default flat({\n     remainingBalance: '剩余余额',\n     credits: '额度',\n     ofCredits: '额度',\n+    creditActivity: {\n+      consumption: '额度消耗',\n+      paidGrant: '额度充值',\n+      paidAmount: '支付 {amount}',\n+      promotionalGrant: '赠送',\n+      resetGrant: '额度重置',\n+    },\n     transferStatus: '交易状态',\n     sourceData: '源数据',\n     viewGrant: '查看额度',\n-    viewSubscription: '查看订阅',\n+    viewSubscription: '订阅详情',\n     view: '查看',\n     meterEvent: '计量事件',\n     source: '来源',\n     viewDetail: '查看详情',\n+    viewTransactionDetail: '交易详情',\n     customer: '客户',\n     currency: '币种',\n     custom: '自定义',\n@@ -128,8 +136,9 @@ export default flat({\n       cancel: '取消',\n     },\n     paymentMethod: '支付方式',\n-    viewInvoice: '查看账单',\n+    viewInvoice: '账单详情',\n     submit: '提交',\n+    expired: '已过期',\n   },\n   payment: {\n     checkout: {\n@@ -502,6 +511,8 @@ export default flat({\n         paymentConfirmDescription:\n           '完成本次支付后，您使用的支付方式将自动设置为该订阅的默认支付方式。此外，我们还将对该订阅的其他欠费账单进行重试收费。',\n         continue: '继续',\n+        credit: '额度',\n+        creditRefresh: '每{interval}{unit}刷新',\n       },\n       payment: {\n         empty: '没有支付记录',\n"},"uuid":"b90b5866-b009-44c8-9910-1ed735b3cd2f","timestamp":"2026-01-12T13:51:31.831Z","thinkingMetadata":{"level":"high","disabled":false,"triggers":[]},"todos":[]}
{"parentUuid":"b90b5866-b009-44c8-9910-1ed735b3cd2f","isSidechain":false,"userType":"external","cwd":"~/Arcblock/payment-kit-master/blocklets/core","sessionId":"664f44d5-76eb-4da6-b55c-a98e01f05344","version":"2.0.76","gitBranch":"feat-quote","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01Y5be33Fh2oi3yE8JwhqjRG","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"用户要求我帮忙review这个diff并生成审查文档。这是一个相当大的diff，包含了很多文件的修改。让我分析一下这个diff的内容：\n\n1. 新增了通知模板 `customer-auto-recharge-daily-limit-exceeded.ts` - 当自动充值达到每日限额时的通知\n2. 修改了低余额通知模板 `customer-credit-low-balance.ts` - 添加了预检查机制和延迟发送\n3. 在 `auto-recharge.ts` 中添加了超限通知事件\n4. 在 `credit-consume.ts` 中优化了通知逻辑，避免重复通知\n5. 在 `notification.ts` 中添加了新的通知类型和延迟发送功能\n6. 在后端添加了多个新的API路由和功能\n7. 前端UI的多处改进\n\n用户提到使用 `diff-review-doc` skill来生成审查文档。让我检查available skills中是否有这个skill。\n\n是的，我看到了：\n```\n<skill>\n<name>diff-review-doc</name>\n<description>Generate comprehensive, reviewer-ready code review documents from git diffs. Use this when the user provides code changes (git diff output, file changes, or asks to review code changes) and wants a structured review document. Creates detailed analysis covering change overview, business flow, key code explanation, risk assessment, and review recommendations. Supports both manual diff input and automatic git workspace detection. Particularly useful for reviewing pull requests, feature branches, or any code changes requiring thorough documentation for reviewers. (user)</description>\n<location>user</location>\n</skill>\n```\n\n这正好符合用户的需求。\n\n既然用户提供了git diff并明确要求生成审查文档，我应该调用这个skill来生成全面的代码审查分析，包括变更概述、业务流程、关键代码解释、风险评估和审查建议。","signature":"Eq8RCkYICxgCKkAngEAnshyrQxyUo9MCT6bY10sogZ4FsMEuAPL7m9MGkCppgslsr1Hdsx2vTPV0cmo3K9spyS4011HaJq67qJ/EEgxcEGm+G0jtbRPC9rIaDBEqO1o3EjukoeVQnCIwS2+CCVcC/D/W6aP6jEvOGAOS8NnWzxfIYzgy7gU9v7oPdh6gKHUSUaiNBo1lvs1bKpYQZER4lJsSeUu0fAewQKsz2W07sjnvr7tf1Bj7PJq5SknCmdzOoWQ+PjNZiC6jAg1hyfMXVIp9qKjI+QFkRuu4t8uveq6QUB9vZZapaQK4hFMtoTeq9fm2uZqU5JQ9bLnyUHTZUwJmb9TuBJtg4PO2mMf+eh4okWil5EIGRUOUhjRoGC3s2gFAdMzpUy0imrvxKSdpcHZB2iIGh4iWQMAaOV7TsFJ42mLiV/KNaR7rQScoO9eYjQjQ0arcy8OvTclvuAu5H2oQ7oZyOnz8Wcxcv8IBKonPtX4jHhTPuXKTRJ0FXNgrtBiprLDx07RgfOaM1Q58iExOqFrI1vIlSk8F5Vh/CSYlzJ9X97Wdc/KhiCZ9gP4g6hs5WKxTHQr/HG4ZMwIjlrTR3qA/PTziWKPbp9fiXGM6RB2h2HPZoL4ZED0Dxss719rrbaqXXf8QDZ2P5BLNTZar/kIXG0J919vCMGaEus2TrvyweiktFGEEkzheUfzhJUEbuVwR39ejFi55VVgSBFCwjnYvJzWrhJn3pNImZcnMnlcIMBdtdlw5svdsSCKQkj8zBwdQ/fO6s4OmgxgFvNwxioBccShTynxtZtCuXtpQ1lc/z1GV4iQzqIBheNHUHSMPvygCkGM7SzUeCCEf8N8RGKvM9pJVgtJlPGo20yGfC6a5DGvHTSdOt4VKklmow7i4pGzSrpgPzKQtOAiagirdiSfOcLD2Rf7iXAUMI1Fr9/5cIjxFogtUxOGFSvh9aQkCdMeFFn1TR2c74TNP3bzIyAwd1B3OGrEa9e7dkpzWCBV/TF5ehUizzYhakLyQ3oiaheNOFOUjiDQ3I/rM/21dX9w6kzZvSlayS8T5DTbUtKRa4dBpsATkz0PwEcaELb4xOsjrYRCaO7CayAVkZPy5MRrnndxe+TKu4pcoHOyDUpXvUP4Tez6YxJKzWprhhFk4x5uIbc8FFnhvFYifTZKAyneK9+BciSufs4NPY/oobLKEst/vqRHo0hoCn6QUTcajZgUeuqRZ54oT/KMocyX3pZNtoNY7x5muLnaVqaXRnRuIK2cqe8FcOoMr7vrbobzAefm+O0zEbRKuHmuoFH9EOdBz15C+Biq1LBvNvfv6hVjQAUXyhEQBQgMyKV9arYVbwuKhzKYlqGIFLJQ8PmlzeO4itEZw1X86Oh8jwFOIcSJV+rnSLFd5aqGO9BdCq48WW76n9UEesy+7lomEGgky1mZwY/Fls+9YTxBn/PwW9K5ue2HwDxqPs2hchLKTYIS6ArjpsolYbUa8OfUXqD1z4duVLwZzHNUbAzeqBxosaejvu6o6B63jL+DTiRWeN3BBv2KYxK1TVolm1DAQJFvBK3+nH9e5DrQIerTUa6POWrnE41EMLi+JTw0kCc0XTDVbnFSGKpuiVV3PimqT+3M6/ZJljdHYf3Hln2b+9jV1cUDlUg0bOEf8BeyWQfX6T+FZXkyexa+b/ZraQY9SHulfj2mgNT3752ItaA4G140u7JOnlM1SW+HWNDU8vqBZsELH4kzAThZuCD3pZnF3Hv6oD5xvjdLrvC6xg36inB65GtX2hO0L94jkr5RUE04q3ThXeDXlUDDfcnPnGQ2PRTWefcb4vfg893xXmFPI00x0Me6ao3Xp+5KL1ho3ZUQKcNktyZIQT20EvSlN5HW07VnRyhpbgBjw5me6SjTbeh1VLRmoQSR/3RomcjUXUQSa3DHRDYlXBGsVBDFz6UWw83+eZ24lzQctE5Ubunp/UUDFnYuugtz5iTxGWhP7DJKWIgMzKLqFpuIR5rgoHYpzrA+vRiune9mtw/g1vOLThu2awCHn+82itlaVuL/lLdrm/ybEDXrOCXBrZb0TpeWT77AOQe6odp8Pq2c0p0qZOj/Vs7zEeGVet/v9rwk2I8H+C2cBvF9R32FknMNjzn7EhQ+2UCgnTRtKF+MtNucE4ZZbJjUa+YuyWY602fT07QcbpcyZIu6eON/iRThU4OrbjO0xjucWwiAaEro9M7Nq6k1fwmX0lzBB2dfTy+56P2tobrP7Zd7W0NOuvrWtFxKiHVoltupifwmUa3ApziRei9kgd8oDxBiuIASpRlEV/YUDCd8GrSQioRv0I3SYz6hvfAFW0Wz3cQZgZSOFXqwN9PmuNA79tlxHDEI4s+tKLRxu4I7hKo8Zs/qMdpFSersmZhF6e/PXUAqfwa8GsfICG+b3DdhIBy9g4yyG3s4+x2fy91pu1fvn/oGmPm7MDqTkZP7tYxRX+tcAu9l4M0LbsHMW8QHTi8bA5YtCDEKaLVVCQ4yT+VDFtKINeHZ2w7Gj0eNyMMuWh+1oGR3BMK2EdfUV0mbGav52GNrcCKBVOQmTkZfnxm1Fbv7HSUlOb1ahmmucmG7GyvMSByptReZY9rvks9rR5rZiKWvF4gews6/0z0kay3s6xG3k2tVnQPWegcGiTbGvnZ74IaM1o7ZmdEXzmQOHMLJZMJHgvu2IdRLs5r+95hdXtAqEeXGsLJkoVXVS1cCMlGpFSUNmN/SA312ZWQR9iCQZqiT0/tf/xDg7yoVtkns/nbGVsCG7Gk/OACwj7yqzdbUZUftshjkkN4ii4cA7YsOrcXv7VqgIOI2FxQsnk0uEzhCcZHHdAvS3wif7Z6zVqUY+4/wc9DnnaQPSPizJNVmE2PO0ZCbfJXyzk97bcNFYrNQcDcyT5VuOcDBagWrImsapZd9J+nj+MrVrFaEcZNnZNNvZyma1wogWDobsFS1lXk38Etg9nXZokETQGAE="}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":9,"cache_creation_input_tokens":35483,"cache_read_input_tokens":12834,"cache_creation":{"ephemeral_5m_input_tokens":35483,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CX3bN4CQGmr1kRnnW32dn","type":"assistant","uuid":"9fce8c84-be95-40df-9bf8-743d2a858209","timestamp":"2026-01-12T13:51:49.434Z"}
{"parentUuid":"9fce8c84-be95-40df-9bf8-743d2a858209","isSidechain":false,"userType":"external","cwd":"~/Arcblock/payment-kit-master/blocklets/core","sessionId":"664f44d5-76eb-4da6-b55c-a98e01f05344","version":"2.0.76","gitBranch":"feat-quote","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01Y5be33Fh2oi3yE8JwhqjRG","type":"message","role":"assistant","content":[{"type":"text","text":"我来帮你review这个diff并生成审查文档。"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":9,"cache_creation_input_tokens":35483,"cache_read_input_tokens":12834,"cache_creation":{"ephemeral_5m_input_tokens":35483,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CX3bN4CQGmr1kRnnW32dn","type":"assistant","uuid":"78b13491-c2d6-4459-b296-d96356ea8312","timestamp":"2026-01-12T13:51:49.434Z"}
{"parentUuid":"78b13491-c2d6-4459-b296-d96356ea8312","isSidechain":false,"userType":"external","cwd":"~/Arcblock/payment-kit-master/blocklets/core","sessionId":"664f44d5-76eb-4da6-b55c-a98e01f05344","version":"2.0.76","gitBranch":"feat-quote","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01Y5be33Fh2oi3yE8JwhqjRG","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01LCR9wGFQjHZxVB4z1yckSY","name":"Skill","input":{"skill":"diff-review-doc","args":"diff --git a/blocklets/core/api/src/libs/notification/template/customer-auto-recharge-daily-limit-exceeded.ts b/blocklets/core/api/src/libs/notification/template/customer-auto-recharge-daily-limit-exceeded.ts\nnew file mode 100644\nindex 000000000..54cf7574f\n--- /dev/null\n+++ b/blocklets/core/api/src/libs/notification/template/customer-auto-recharge-daily-limit-exceeded.ts\n@@ -0,0 +1,222 @@\n+/* eslint-disable @typescript-eslint/brace-style */\n+/* eslint-disable @typescript-eslint/indent */\n+import { withQuery } from 'ufo';\n+import { getUserLocale } from '../../../integrations/blocklet/notification';\n+import { translate } from '../../../locales';\n+import { AutoRechargeConfig, Customer, PaymentMethod, Price, Product } from '../../../store/models';\n+import { PaymentCurrency } from '../../../store/models/payment-currency';\n+import { getRechargePaymentUrl } from '../../currency';\n+import { formatTime } from '../../time';\n+import { formatCurrencyInfo, getConnectQueryParam, getCustomerIndexUrl } from '../../util';\n+import type { BaseEmailTemplate, BaseEmailTemplateType } from './base';\n+\n+export interface CustomerAutoRechargeDailyLimitExceededEmailTemplateOptions {\n+  customerId: string;\n+  autoRechargeConfigId: string;\n+  currencyId: string;\n+  currentBalance: string;\n+}\n+\n+interface CustomerAutoRechargeDailyLimitExceededEmailTemplateContext {\n+  locale: string;\n+  userDid: string;\n+  at: string;\n+  creditCurrencyName: string;\n+  currentBalance: string;\n+  dailyLimit: string;\n+  dailyUsed: string;\n+  rechargeUrl: string | null;\n+  customerIndexUrl: string;\n+}\n+\n+export class CustomerAutoRechargeDailyLimitExceededEmailTemplate\n+  implements BaseEmailTemplate<CustomerAutoRechargeDailyLimitExceededEmailTemplateContext>\n+{\n+  options: CustomerAutoRechargeDailyLimitExceededEmailTemplateOptions;\n+\n+  constructor(options: CustomerAutoRechargeDailyLimitExceededEmailTemplateOptions) {\n+    this.options = options;\n+  }\n+\n+  async getContext(): Promise<CustomerAutoRechargeDailyLimitExceededEmailTemplateContext> {\n+    const customer = await Customer.findByPk(this.options.customerId);\n+    if (!customer) {\n+      throw new Error(`Customer not found: ${this.options.customerId}`);\n+    }\n+\n+    const autoRechargeConfig = await AutoRechargeConfig.findByPk(this.options.autoRechargeConfigId, {\n+      include: [\n+        {\n+          model: Price,\n+          as: 'price',\n+          include: [{ model: Product, as: 'product' }],\n+        },\n+        {\n+          model: PaymentMethod,\n+          as: 'paymentMethod',\n+        },\n+        {\n+          model: PaymentCurrency,\n+          as: 'rechargeCurrency',\n+        },\n+      ],\n+    });\n+    if (!autoRechargeConfig) {\n+      throw new Error(`AutoRechargeConfig not found: ${this.options.autoRechargeConfigId}`);\n+    }\n+\n+    // Get credit currency\n+    const creditCurrency = await PaymentCurrency.findByPk(autoRechargeConfig.currency_id);\n+    if (!creditCurrency) {\n+      throw new Error(`Credit currency not found: ${autoRechargeConfig.currency_id}`);\n+    }\n+\n+    const rechargeCurrency = await PaymentCurrency.findByPk(autoRechargeConfig.recharge_currency_id);\n+    const paymentMethod = await PaymentMethod.findByPk(autoRechargeConfig.payment_method_id);\n+\n+    const userDid: string = customer.did;\n+    const locale = await getUserLocale(userDid);\n+    const at: string = formatTime(Date.now());\n+\n+    const creditCurrencyName = creditCurrency.name || 'Credits';\n+    const currentBalance = formatCurrencyInfo(this.options.currentBalance, creditCurrency, null);\n+\n+    // Format daily limit and usage\n+    const dailyLimit = rechargeCurrency\n+      ? formatCurrencyInfo(autoRechargeConfig.daily_limits?.max_amount || '0', rechargeCurrency, paymentMethod)\n+      : autoRechargeConfig.daily_limits?.max_amount || '0';\n+    const dailyUsed = rechargeCurrency\n+      ? formatCurrencyInfo(autoRechargeConfig.daily_stats?.total_amount || '0', rechargeCurrency, paymentMethod)\n+      : autoRechargeConfig.daily_stats?.total_amount || '0';\n+\n+    // Get recharge URL\n+    let rechargeUrl: string | null = await getRechargePaymentUrl(creditCurrency);\n+    if (rechargeUrl) {\n+      rechargeUrl = withQuery(rechargeUrl, { ...getConnectQueryParam({ userDid }) });\n+    }\n+\n+    // Get customer index URL for managing credits\n+    const customerIndexUrl = getCustomerIndexUrl({\n+      locale,\n+      userDid,\n+    });\n+\n+    return {\n+      locale,\n+      userDid,\n+      at,\n+      creditCurrencyName,\n+      currentBalance,\n+      dailyLimit,\n+      dailyUsed,\n+      rechargeUrl,\n+      customerIndexUrl,\n+    };\n+  }\n+\n+  async getTemplate(): Promise<BaseEmailTemplateType> {\n+    const {\n+      locale,\n+      userDid,\n+      at,\n+      creditCurrencyName,\n+      currentBalance,\n+      dailyLimit,\n+      dailyUsed,\n+      rechargeUrl,\n+      customerIndexUrl,\n+    } = await this.getContext();\n+\n+    const template: BaseEmailTemplateType = {\n+      title: translate('notification.autoRechargeDailyLimitExceeded.title', locale),\n+      body: translate('notification.autoRechargeDailyLimitExceeded.body', locale, {\n+        at,\n+        creditCurrencyName,\n+      }),\n+      // @ts-expect-error\n+      attachments: [\n+        {\n+          type: 'section',\n+          fields: [\n+            {\n+              type: 'text',\n+              data: {\n+                type: 'plain',\n+                color: '#9397A1',\n+                text: translate('notification.common.account', locale),\n+              },\n+            },\n+            {\n+              type: 'text',\n+              data: {\n+                type: 'plain',\n+                text: userDid,\n+              },\n+            },\n+            {\n+              type: 'text',\n+              data: {\n+                type: 'plain',\n+                color: '#9397A1',\n+                text: translate('notification.common.currentBalance', locale),\n+              },\n+            },\n+            {\n+              type: 'text',\n+              data: {\n+                type: 'plain',\n+                color: '#FF6B00',\n+                text: currentBalance,\n+              },\n+            },\n+            {\n+              type: 'text',\n+              data: {\n+                type: 'plain',\n+                color: '#9397A1',\n+                text: translate('notification.autoRechargeDailyLimitExceeded.dailyLimit', locale),\n+              },\n+            },\n+            {\n+              type: 'text',\n+              data: {\n+                type: 'plain',\n+                text: dailyLimit,\n+              },\n+            },\n+            {\n+              type: 'text',\n+              data: {\n+                type: 'plain',\n+                color: '#9397A1',\n+                text: translate('notification.autoRechargeDailyLimitExceeded.dailyUsed', locale),\n+              },\n+            },\n+            {\n+              type: 'text',\n+              data: {\n+                type: 'plain',\n+                text: dailyUsed,\n+              },\n+            },\n+          ].filter(Boolean),\n+        },\n+      ].filter(Boolean),\n+      // @ts-ignore\n+      actions: [\n+        rechargeUrl && {\n+          name: translate('notification.common.reloadCredits', locale),\n+          title: translate('notification.common.reloadCredits', locale),\n+          link: rechargeUrl,\n+        },\n+        {\n+          name: translate('notification.common.manageCredit', locale),\n+          title: translate('notification.common.manageCredit', locale),\n+          link: customerIndexUrl,\n+        },\n+      ].filter(Boolean),\n+    };\n+\n+    return template;\n+  }\n+}\ndiff --git a/blocklets/core/api/src/libs/notification/template/customer-credit-low-balance.ts b/blocklets/core/api/src/libs/notification/template/customer-credit-low-balance.ts\nindex da264ea14..044a2f56e 100644\n--- a/blocklets/core/api/src/libs/notification/template/customer-credit-low-balance.ts\n+++ b/blocklets/core/api/src/libs/notification/template/customer-credit-low-balance.ts\n@@ -1,10 +1,10 @@\n /* eslint-disable @typescript-eslint/brace-style */\n /* eslint-disable @typescript-eslint/indent */\n import { withQuery } from 'ufo';\n-import { fromUnitToToken } from '@ocap/util';\n+import { BN, fromUnitToToken } from '@ocap/util';\n import { getUserLocale } from '../../../integrations/blocklet/notification';\n import { translate } from '../../../locales';\n-import { Customer, PaymentCurrency } from '../../../store/models';\n+import { Customer, PaymentCurrency, CreditGrant } from '../../../store/models';\n import type { BaseEmailTemplate, BaseEmailTemplateType } from './base';\n import { formatCreditAmount, getConnectQueryParam, getCustomerIndexUrl, formatNumber } from '../../util';\n import { getRechargePaymentUrl } from '../../currency';\n@@ -29,6 +29,41 @@ interface CustomerCreditLowBalanceEmailTemplateContext {\n export class CustomerCreditLowBalanceEmailTemplate\n   implements BaseEmailTemplate<CustomerCreditLowBalanceEmailTemplateContext>\n {\n+  // Notification configuration: 10 minute grace period before sending\n+  static readonly delay = 10 * 60; // seconds\n+  static readonly LOW_BALANCE_THRESHOLD_PERCENT = 10;\n+\n+  /**\n+   * Preflight check: verify if notification should still be sent\n+   * Returns false if user has recharged during grace period\n+   */\n+  static async preflightCheck(options: CustomerCreditLowBalanceEmailTemplateOptions): Promise<boolean> {\n+    try {\n+      const { customerId, currencyId } = options;\n+\n+      const availableGrants = await CreditGrant.getAvailableCreditsForCustomer(customerId, currencyId);\n+      const totalAmount = availableGrants.reduce((sum, grant) => sum.add(new BN(grant.amount)), new BN(0));\n+      const remainingAmount = availableGrants.reduce(\n+        (sum, grant) => sum.add(new BN(grant.remaining_amount)),\n+        new BN(0)\n+      );\n+\n+      // Skip if no credits exist\n+      if (totalAmount.lte(new BN(0))) {\n+        return false;\n+      }\n+\n+      // Calculate current percentage\n+      const currentPercentage = remainingAmount.mul(new BN(100)).div(totalAmount).toNumber();\n+\n+      // If balance is above threshold, user has recharged - skip notification\n+      return currentPercentage <= CustomerCreditLowBalanceEmailTemplate.LOW_BALANCE_THRESHOLD_PERCENT;\n+    } catch {\n+      // On error, proceed with sending to avoid missing important notifications\n+      return true;\n+    }\n+  }\n+\n   options: CustomerCreditLowBalanceEmailTemplateOptions;\n \n   constructor(options: CustomerCreditLowBalanceEmailTemplateOptions) {\n@@ -36,7 +71,7 @@ export class CustomerCreditLowBalanceEmailTemplate\n   }\n \n   async getContext(): Promise<CustomerCreditLowBalanceEmailTemplateContext> {\n-    const { customerId, currencyId, availableAmount, percentage } = this.options;\n+    const { customerId, currencyId } = this.options;\n \n     const customer = await Customer.findByPk(customerId);\n     if (!customer) {\n@@ -48,16 +83,24 @@ export class CustomerCreditLowBalanceEmailTemplate\n       throw new Error(`PaymentCurrency not found: ${currencyId}`);\n     }\n \n+    // Fetch latest balance data instead of using stale data from options\n+    const availableGrants = await CreditGrant.getAvailableCreditsForCustomer(customerId, currencyId);\n+    const totalAmount = availableGrants.reduce((sum, grant) => sum.add(new BN(grant.amount)), new BN(0));\n+    const remainingAmount = availableGrants.reduce((sum, grant) => sum.add(new BN(grant.remaining_amount)), new BN(0));\n+\n+    const currentPercentage = totalAmount.gt(new BN(0))\n+      ? remainingAmount.mul(new BN(100)).div(totalAmount).toNumber()\n+      : 0;\n+\n     const userDid = customer.did;\n     const locale = await getUserLocale(userDid);\n \n-    const formattedAmount = formatNumber(fromUnitToToken(availableAmount, paymentCurrency.decimal));\n+    const formattedAmount = formatNumber(fromUnitToToken(remainingAmount.toString(), paymentCurrency.decimal));\n     const available = formatCreditAmount(formattedAmount || '0', paymentCurrency.symbol);\n-    const percentageNum = parseFloat(percentage);\n-    const isCritical = percentageNum < 1;\n+    const isCritical = currentPercentage < 1;\n     const lowBalancePercentage = isCritical\n       ? translate('notification.creditLowBalance.lessThanOnePercent', locale)\n-      : `${percentage}%`;\n+      : `${currentPercentage}%`;\n \n     let rechargeUrl: string | null = await getRechargePaymentUrl(paymentCurrency);\n     if (rechargeUrl) {\ndiff --git a/blocklets/core/api/src/locales/en.ts b/blocklets/core/api/src/locales/en.ts\nindex 2ab23903e..b6c0609e4 100644\n--- a/blocklets/core/api/src/locales/en.ts\n+++ b/blocklets/core/api/src/locales/en.ts\n@@ -175,6 +175,13 @@ export default flat({\n       },\n     },\n \n+    autoRechargeDailyLimitExceeded: {\n+      title: 'Auto Top-Up daily limit reached',\n+      body: 'Your {creditCurrencyName} balance is low, but auto top-up was not triggered because you have reached the daily recharge limit on {at}. You can manually reload or wait until tomorrow for automatic top-up.',\n+      dailyLimit: 'Daily Limit',\n+      dailyUsed: 'Used Today',\n+    },\n+\n     subscriptionRefundSucceeded: {\n       title: '{productName} refund successful',\n       body: 'Your subscription to {productName} has been successfully refunded on {at}, with a refund amount of {refundInfo}. If you have any questions, please feel free to contact us.',\ndiff --git a/blocklets/core/api/src/locales/zh.ts b/blocklets/core/api/src/locales/zh.ts\nindex 23ec345fd..c8ac344c4 100644\n--- a/blocklets/core/api/src/locales/zh.ts\n+++ b/blocklets/core/api/src/locales/zh.ts\n@@ -167,6 +167,13 @@ export default flat({\n       },\n     },\n \n+    autoRechargeDailyLimitExceeded: {\n+      title: '自动充值已达每日限额',\n+      body: '您的 {creditCurrencyName} 余额偏低,但由于已达到每日充值限额,自动充值于 {at} 未能触发。您可以手动充值,或等待明天自动充值。',\n+      dailyLimit: '每日限额',\n+      dailyUsed: '今日已用',\n+    },\n+\n     subscriptionRefundSucceeded: {\n       title: '{productName} 退款成功',\n       body: '您订阅的 {productName} 在 {at} 已退款成功,退款金额为 {refundInfo}。如有任何疑问,请随时与我们联系。',\ndiff --git a/blocklets/core/api/src/queues/auto-recharge.ts b/blocklets/core/api/src/queues/auto-recharge.ts\nindex 5c52c9f30..a94da4bcf 100644\n--- a/blocklets/core/api/src/queues/auto-recharge.ts\n+++ b/blocklets/core/api/src/queues/auto-recharge.ts\n@@ -15,6 +15,7 @@ import {\n   TPriceExpanded,\n } from '../store/models';\n import logger from '../libs/logger';\n+import { createEvent } from '../libs/audit';\n import { createStripeInvoiceForAutoRecharge } from '../integrations/stripe/resource';\n import { ensureInvoiceAndItems } from '../libs/invoice';\n import dayjs from '../libs/dayjs';\n@@ -126,6 +127,12 @@ export async function processAutoRecharge(job: AutoRechargeJobData) {\n       customerId,\n       currencyId,\n     });\n+    // Send notification when daily limit is exceeded\n+    createEvent('Customer', 'customer.auto_recharge.daily_limit_exceeded', customer, {\n+      autoRechargeConfigId: config.id,\n+      currencyId,\n+      currentBalance: totalAvailable.toString(),\n+    });\n     return;\n   }\n \ndiff --git a/blocklets/core/api/src/queues/credit-consume.ts b/blocklets/core/api/src/queues/credit-consume.ts\nindex 97a25f215..d91006d9a 100644\n--- a/blocklets/core/api/src/queues/credit-consume.ts\n+++ b/blocklets/core/api/src/queues/credit-consume.ts\n@@ -249,6 +249,9 @@ async function consumeAvailableCredits(\n   const pendingAmount = Math.max(0, finalPending.toNumber()).toString();\n   const remainingBalance = totalAvailable.sub(consumed).toString();\n \n+  // Track whether insufficient event was triggered to skip low_balance notification\n+  let insufficientTriggered = false;\n+\n   // 如果无法完全消费所需额度,记录不足事件\n   if (finalPending.gt(new BN(0))) {\n     logger.warn('Insufficient credit balance', {\n@@ -260,6 +263,7 @@ async function consumeAvailableCredits(\n       pendingAmount,\n     });\n     if ((context.subscription && context.subscription.isActive()) || !context.subscription) {\n+      insufficientTriggered = true;\n       await createEvent('Customer', 'customer.credit.insufficient', context.customer, {\n         metadata: {\n           meter_event_id: context.meterEvent.id,\n@@ -297,6 +301,7 @@ async function consumeAvailableCredits(\n       });\n     }\n   } else if (remainingBalance === '0') {\n+    insufficientTriggered = true;\n     await createEvent('Customer', 'customer.credit.insufficient', context.customer, {\n       metadata: {\n         meter_event_id: context.meterEvent.id,\n@@ -312,7 +317,10 @@ async function consumeAvailableCredits(\n     }).catch(console.error);\n   }\n \n-  await checkLowBalance(customerId, currencyId, totalCreditAmountBN.toString(), remainingBalance, context);\n+  // Skip low_balance check if insufficient was already triggered (insufficient takes priority)\n+  if (!insufficientTriggered) {\n+    await checkLowBalance(customerId, currencyId, totalCreditAmountBN.toString(), remainingBalance, context);\n+  }\n \n   return {\n     consumed: totalConsumed.toString(),\ndiff --git a/blocklets/core/api/src/queues/notification.ts b/blocklets/core/api/src/queues/notification.ts\nindex b3f8b910e..961bd79c0 100644\n--- a/blocklets/core/api/src/queues/notification.ts\n+++ b/blocklets/core/api/src/queues/notification.ts\n@@ -102,6 +102,10 @@ import {\n   CustomerAutoRechargeFailedEmailTemplate,\n   CustomerAutoRechargeFailedEmailTemplateOptions,\n } from '../libs/notification/template/customer-auto-recharge-failed';\n+import {\n+  CustomerAutoRechargeDailyLimitExceededEmailTemplate,\n+  CustomerAutoRechargeDailyLimitExceededEmailTemplateOptions,\n+} from '../libs/notification/template/customer-auto-recharge-daily-limit-exceeded';\n import {\n   CustomerRevenueSucceededEmailTemplate,\n   CustomerRevenueSucceededEmailTemplateOptions,\n@@ -139,6 +143,7 @@ export type NotificationQueueJobType =\n   | 'customer.credit_grant.granted'\n   | 'customer.credit.low_balance'\n   | 'customer.auto_recharge.failed'\n+  | 'customer.auto_recharge.daily_limit_exceeded'\n   | 'webhook.endpoint.failed';\n \n export type NotificationQueueJob = {\n@@ -285,6 +290,12 @@ async function getNotificationTemplate(job: NotificationQueueJob): Promise<BaseE\n     return new CustomerAutoRechargeFailedEmailTemplate(job.options as CustomerAutoRechargeFailedEmailTemplateOptions);\n   }\n \n+  if (job.type === 'customer.auto_recharge.daily_limit_exceeded') {\n+    return new CustomerAutoRechargeDailyLimitExceededEmailTemplate(\n+      job.options as CustomerAutoRechargeDailyLimitExceededEmailTemplateOptions\n+    );\n+  }\n+\n   if (job.type === 'webhook.endpoint.failed') {\n     return new WebhookEndpointFailedEmailTemplate(job.options as WebhookEndpointFailedEmailTemplateOptions);\n   }\n@@ -296,6 +307,18 @@ async function handleNotificationJob(job: NotificationQueueJob): Promise<void> {\n   try {\n     const template = await getNotificationTemplate(job);\n \n+    // Check if template class has a preflightCheck\n+    const TemplateClass = template.constructor as any;\n+    if (TemplateClass.preflightCheck) {\n+      const shouldSend = await TemplateClass.preflightCheck(job.options);\n+      if (!shouldSend) {\n+        logger.info('handleNotificationJob.skipped: preflight check returned false', {\n+          type: job.type,\n+        });\n+        return;\n+      }\n+    }\n+\n     await new Notification(template, job.type).send();\n     logger.info('handleImmediateNotificationJob.success', { job });\n   } catch (error) {\n@@ -624,7 +647,7 @@ export async function startNotificationQueue() {\n   });\n \n   events.on('customer.credit.low_balance', (customer: Customer, { metadata }: { metadata: any }) => {\n-    addNotificationJob(\n+    addNotificationJobWithDelay(\n       'customer.credit.low_balance',\n       {\n         customerId: customer.id,\n@@ -678,6 +701,29 @@ export async function startNotificationQueue() {\n       }\n     }\n   );\n+\n+  events.on(\n+    'customer.auto_recharge.daily_limit_exceeded',\n+    (customer: Customer, { autoRechargeConfigId, currencyId, currentBalance }) => {\n+      logger.info('addNotificationJob:customer.auto_recharge.daily_limit_exceeded', {\n+        customerId: customer.id,\n+        autoRechargeConfigId,\n+        currencyId,\n+      });\n+      addNotificationJob(\n+        'customer.auto_recharge.daily_limit_exceeded',\n+        {\n+          customerId: customer.id,\n+          autoRechargeConfigId,\n+          currencyId,\n+          currentBalance,\n+        },\n+        [customer.id, autoRechargeConfigId, currencyId],\n+        true, // prevent duplicate\n+        24 * 3600 // 24 hours\n+      );\n+    }\n+  );\n }\n \n export async function handleNotificationPreferenceChange(\n@@ -812,3 +858,55 @@ export function addNotificationJob(\n     },\n   });\n }\n+\n+/**\n+ * Add a notification job with delay support\n+ * Use this when the template class has a static `delay` property\n+ */\n+export async function addNotificationJobWithDelay(\n+  type: NotificationQueueJobType,\n+  options: NotificationQueueJobOptions,\n+  extraIds: string[] = [],\n+  preventDuplicate: boolean = false,\n+  duplicateWindow: number = 600\n+) {\n+  const idParts = [type];\n+\n+  if (extraIds.length) {\n+    idParts.push(...extraIds);\n+  } else {\n+    idParts.push(Date.now().toString());\n+  }\n+\n+  if (preventDuplicate) {\n+    const cacheKey = `${type}.${extraIds.join('.')}`;\n+    const lastSent = notificationCache.get(cacheKey);\n+    const now = Date.now();\n+\n+    if (lastSent && now - lastSent < duplicateWindow * 1000) {\n+      logger.info('Notification skipped due to duplicate prevention', {\n+        type,\n+        cacheKey,\n+        lastSent: new Date(lastSent),\n+        duplicateWindow,\n+      });\n+      return Promise.resolve();\n+    }\n+\n+    notificationCache.set(cacheKey, now);\n+  }\n+\n+  // Get delay from template class\n+  const template = await getNotificationTemplate({ type, options });\n+  const TemplateClass = template.constructor as any;\n+  const { delay } = TemplateClass;\n+\n+  return notificationQueue.push({\n+    id: idParts.join('.'),\n+    job: {\n+      type,\n+      options,\n+    },\n+    ...(delay && delay > 0 ? { delay } : {}),\n+  });\n+}\ndiff --git a/blocklets/core/api/src/routes/credit-transactions.ts b/blocklets/core/api/src/routes/credit-transactions.ts\nindex 2e7114cf5..a371778c7 100644\n--- a/blocklets/core/api/src/routes/credit-transactions.ts\n+++ b/blocklets/core/api/src/routes/credit-transactions.ts\n@@ -15,6 +15,7 @@ import {\n   Subscription,\n   PaymentCurrency,\n   PaymentMethod,\n+  Invoice,\n   TCreditTransactionExpanded,\n } from '../store/models';\n \n@@ -118,7 +119,12 @@ router.get('/', authMine, async (req, res) => {\n               { model: Meter, as: 'meter' },\n               { model: Subscription, as: 'subscription', attributes: ['id', 'description', 'status'], required: false },\n               { model: CreditGrant, as: 'creditGrant', attributes: ['id', 'name', 'currency_id'] },\n-              { model: MeterEvent, as: 'meterEvent', attributes: ['id', 'source_data'], required: false },\n+              {\n+                model: MeterEvent,\n+                as: 'meterEvent',\n+                attributes: ['id', 'source_data', 'timestamp', 'processed_at', 'created_at'],\n+                required: false,\n+              },\n             ],\n           });\n           // Transform transactions\n@@ -135,6 +141,9 @@ router.get('/', authMine, async (req, res) => {\n         customer_id: query.customer_id,\n         status: ['granted', 'depleted', 'expired'],\n       };\n+      if (query.subscription_id) {\n+        grantWhere['metadata.subscription_id'] = query.subscription_id;\n+      }\n       if (query.start) {\n         grantWhere.created_at = {\n           [Op.gte]: new Date(query.start * 1000),\n@@ -162,11 +171,80 @@ router.get('/', authMine, async (req, res) => {\n               },\n             ],\n           });\n-          // Transform grants\n-          return rows.map((item: any) => ({\n-            ...item.toJSON(),\n-            activity_type: 'grant',\n-          }));\n+\n+          // Fetch invoice info for paid grants\n+          const invoiceIds = rows\n+            .map((item: any) => item.metadata?.invoice_id)\n+            .filter((id: string | undefined): id is string => !!id);\n+\n+          // For first scheduled grants (schedule_seq === 1) without invoice_id, find invoice by subscription_id\n+          const subscriptionIdsForFirstGrant = rows\n+            .filter(\n+              (item: any) =>\n+                item.metadata?.schedule_seq === 1 && !item.metadata?.invoice_id && item.metadata?.subscription_id\n+            )\n+            .map((item: any) => item.metadata.subscription_id);\n+\n+          const [invoicesByIds, invoicesBySubscription] = await Promise.all([\n+            invoiceIds.length > 0\n+              ? Invoice.findAll({\n+                  where: { id: { [Op.in]: invoiceIds } },\n+                  attributes: ['id', 'total', 'amount_paid', 'currency_id', 'billing_reason', 'subscription_id'],\n+                  include: [\n+                    {\n+                      model: PaymentCurrency,\n+                      as: 'paymentCurrency',\n+                      attributes: ['id', 'symbol', 'decimal', 'type'],\n+                    },\n+                  ],\n+                })\n+              : [],\n+            subscriptionIdsForFirstGrant.length > 0\n+              ? Invoice.findAll({\n+                  where: {\n+                    subscription_id: { [Op.in]: subscriptionIdsForFirstGrant },\n+                    status: 'paid',\n+                  },\n+                  attributes: ['id', 'total', 'amount_paid', 'currency_id', 'billing_reason', 'subscription_id'],\n+                  include: [\n+                    {\n+                      model: PaymentCurrency,\n+                      as: 'paymentCurrency',\n+                      attributes: ['id', 'symbol', 'decimal', 'type'],\n+                    },\n+                  ],\n+                  order: [['created_at', 'ASC']],\n+                })\n+              : [],\n+          ]);\n+\n+          const invoiceMap = new Map(invoicesByIds.map((inv: any) => [inv.id, inv]));\n+          for (const inv of invoicesBySubscription) {\n+            const subId = inv.subscription_id as string;\n+            if (subId && !invoiceMap.has(subId)) {\n+              invoiceMap.set(subId, inv);\n+            }\n+          }\n+\n+          // Transform grants with invoice info\n+          return rows.map((item: any) => {\n+            const grantData = item.toJSON();\n+            const invoice = invoiceMap.get(grantData.metadata.invoice_id);\n+            return {\n+              ...grantData,\n+              activity_type: 'grant',\n+              invoice: invoice\n+                ? {\n+                    total: invoice.total,\n+                    amount_paid: invoice.amount_paid,\n+                    currency_id: invoice.currency_id,\n+                    billing_reason: invoice.billing_reason,\n+                    subscription_id: invoice.subscription_id,\n+                    paymentCurrency: invoice.paymentCurrency,\n+                  }\n+                : null,\n+            };\n+          });\n         },\n         meta: { type: 'database' },\n       };\n@@ -344,7 +422,7 @@ router.get('/:id', authPortal, async (req, res) => {\n         {\n           model: MeterEvent,\n           as: 'meterEvent',\n-          attributes: ['id', 'source_data'],\n+          attributes: ['id', 'source_data', 'timestamp', 'processed_at', 'created_at'],\n           required: false,\n         },\n       ],\ndiff --git a/blocklets/core/api/src/routes/invoices.ts b/blocklets/core/api/src/routes/invoices.ts\nindex 3a42f934c..a03c19157 100644\n--- a/blocklets/core/api/src/routes/invoices.ts\n+++ b/blocklets/core/api/src/routes/invoices.ts\n@@ -311,6 +311,18 @@ router.get('/', authMine, async (req, res) => {\n             { model: PaymentCurrency, as: 'paymentCurrency' },\n             { model: PaymentMethod, as: 'paymentMethod' },\n             { model: Subscription, as: 'subscription', attributes: ['id', 'description'] },\n+            {\n+              model: InvoiceItem,\n+              as: 'lines',\n+              include: [\n+                {\n+                  model: Price,\n+                  as: 'price',\n+                  attributes: ['id', 'metadata'],\n+                  include: [{ model: Product, as: 'product', attributes: ['id', 'type', 'name'] }],\n+                },\n+              ],\n+            },\n             { model: Customer, as: 'customer' },\n           ],\n         });\ndiff --git a/blocklets/core/api/src/routes/meter-events.ts b/blocklets/core/api/src/routes/meter-events.ts\nindex e4f398654..5d74a1487 100644\n--- a/blocklets/core/api/src/routes/meter-events.ts\n+++ b/blocklets/core/api/src/routes/meter-events.ts\n@@ -352,6 +352,165 @@ router.get('/pending-amount', authMine, async (req, res) => {\n     return res.status(400).json({ error: err?.message });\n   }\n });\n+\n+// Get overdue summary by credit currency (total pending amounts grouped by currency)\n+router.get('/overdue-summary', auth, async (req, res) => {\n+  try {\n+    // Query to aggregate credit_pending by currency, showing total overdue per credit currency\n+    const results = await MeterEvent.sequelize!.query<{\n+      currency_id: string;\n+      total_pending: string;\n+      customer_count: number;\n+      event_count: number;\n+    }>(\n+      `SELECT \n+        m.currency_id,\n+        SUM(CAST(me.credit_pending AS DECIMAL(40,0))) as total_pending,\n+        COUNT(DISTINCT json_extract(me.payload, '$.customer_id')) as customer_count,\n+        COUNT(*) as event_count\n+      FROM meter_events me\n+      JOIN meters m ON me.event_name = m.event_name\n+      WHERE me.livemode = :livemode \n+        AND CAST(me.credit_pending AS DECIMAL(40,0)) > 0\n+      GROUP BY m.currency_id\n+      HAVING total_pending > 0\n+      ORDER BY total_pending DESC`,\n+      {\n+        replacements: { livemode: req.livemode ? 1 : 0 },\n+        type: QueryTypes.SELECT,\n+      }\n+    );\n+\n+    // Fetch currency details\n+    const currencyIds = results.map((r) => r.currency_id);\n+    const currencies =\n+      currencyIds.length > 0 ? await PaymentCurrency.findAll({ where: { id: { [Op.in]: currencyIds } } }) : [];\n+    const currencyMap = new Map(currencies.map((c) => [c.id, c]));\n+\n+    const list = results.map((r) => ({\n+      currency: currencyMap.get(r.currency_id),\n+      total_pending: r.total_pending,\n+      customer_count: r.customer_count,\n+      event_count: r.event_count,\n+    }));\n+\n+    return res.json({ list });\n+  } catch (err) {\n+    logger.error('Error getting overdue summary', err);\n+    return res.status(400).json({ error: err?.message });\n+  }\n+});\n+\n+// Get all customers with credit overdue (pending amount > 0)\n+router.get('/overdue-customers', auth, async (req, res) => {\n+  try {\n+    const page = Math.max(1, parseInt(String(req.query.page || '1'), 10));\n+    const pageSize = Math.min(100, Math.max(1, parseInt(String(req.query.pageSize || '20'), 10)));\n+    const offset = (page - 1) * pageSize;\n+    const currencyId = req.query.currency_id as string | undefined;\n+    const searchQuery = req.query.q as string | undefined;\n+\n+    // Get currency info\n+    let currency: PaymentCurrency | null = null;\n+    if (currencyId) {\n+      currency = await PaymentCurrency.findByPk(currencyId);\n+      if (!currency) {\n+        return res.status(404).json({ error: `Currency ${currencyId} not found` });\n+      }\n+    }\n+\n+    // If search query provided, first find matching customer IDs\n+    let customerFilter = '';\n+    const replacements: any = { livemode: req.livemode ? 1 : 0, limit: pageSize, offset };\n+    if (currencyId) {\n+      replacements.currencyId = currencyId;\n+    }\n+\n+    if (searchQuery) {\n+      const searchCustomers = await Customer.findAll({\n+        where: {\n+          [Op.or]: [\n+            { name: { [Op.like]: `%${searchQuery}%` } },\n+            { email: { [Op.like]: `%${searchQuery}%` } },\n+            { did: { [Op.like]: `%${searchQuery}%` } },\n+          ],\n+        },\n+        attributes: ['id'],\n+      });\n+      const searchCustomerIds = searchCustomers.map((c) => c.id);\n+      if (searchCustomerIds.length === 0) {\n+        return res.json({ list: [], count: 0, paging: { page, pageSize }, currency });\n+      }\n+      customerFilter = `AND json_extract(me.payload, '$.customer_id') IN (${searchCustomerIds.map((id) => `'${id}'`).join(',')})`;\n+    }\n+\n+    // Build query with optional currency filter\n+    const currencyJoin = currencyId\n+      ? 'JOIN meters m ON me.event_name = m.event_name AND m.currency_id = :currencyId'\n+      : '';\n+\n+    // Query to aggregate credit_pending by customer, order by event_count DESC\n+    const results = await MeterEvent.sequelize!.query<{\n+      customer_id: string;\n+      total_pending: string;\n+      event_count: number;\n+    }>(\n+      `SELECT \n+        json_extract(me.payload, '$.customer_id') as customer_id,\n+        SUM(CAST(me.credit_pending AS DECIMAL(40,0))) as total_pending,\n+        COUNT(*) as event_count\n+      FROM meter_events me\n+      ${currencyJoin}\n+      WHERE me.livemode = :livemode \n+        AND CAST(me.credit_pending AS DECIMAL(40,0)) > 0\n+        ${customerFilter}\n+      GROUP BY json_extract(me.payload, '$.customer_id')\n+      HAVING total_pending > 0\n+      ORDER BY event_count DESC\n+      LIMIT :limit OFFSET :offset`,\n+      {\n+        replacements,\n+        type: QueryTypes.SELECT,\n+      }\n+    );\n+\n+    // Get total count\n+    const countResult = await MeterEvent.sequelize!.query<{ count: number }>(\n+      `SELECT COUNT(*) as count FROM (\n+        SELECT json_extract(me.payload, '$.customer_id') as customer_id\n+        FROM meter_events me\n+        ${currencyJoin}\n+        WHERE me.livemode = :livemode \n+          AND CAST(me.credit_pending AS DECIMAL(40,0)) > 0\n+          ${customerFilter}\n+        GROUP BY json_extract(me.payload, '$.customer_id')\n+        HAVING SUM(CAST(me.credit_pending AS DECIMAL(40,0))) > 0\n+      )`,\n+      {\n+        replacements: { livemode: req.livemode ? 1 : 0, ...(currencyId ? { currencyId } : {}) },\n+        type: QueryTypes.SELECT,\n+      }\n+    );\n+\n+    const count = countResult[0]?.count || 0;\n+    const customerIds = results.map((r) => r.customer_id);\n+\n+    // Fetch customer details\n+    const customers = customerIds.length > 0 ? await Customer.findAll({ where: { id: { [Op.in]: customerIds } } }) : [];\n+    const customerMap = new Map(customers.map((c) => [c.id, c]));\n+\n+    const list = results.map((r) => ({\n+      customer: customerMap.get(r.customer_id),\n+      total_pending: r.total_pending,\n+      event_count: r.event_count,\n+    }));\n+\n+    return res.json({ list, count, paging: { page, pageSize }, currency });\n+  } catch (err) {\n+    logger.error('Error getting overdue customers', err);\n+    return res.status(400).json({ error: err?.message });\n+  }\n+});\n router.get('/:id', authMine, async (req, res) => {\n   try {\n     logger.info('get meter event', { id: req.params.id });\ndiff --git a/blocklets/core/src/components/customer/credit-overview.tsx b/blocklets/core/src/components/customer/credit-overview.tsx\nindex 2645c9b40..d4ac2bf11 100644\n--- a/blocklets/core/src/components/customer/credit-overview.tsx\n+++ b/blocklets/core/src/components/customer/credit-overview.tsx\n@@ -259,7 +259,13 @@ export default function CreditOverview({ customerId, settings, mode = 'portal' }\n \n   const filteredCreditCurrencies = useMemo(() => {\n     return creditCurrencies.filter((currency: TPaymentCurrency) => {\n-      return creditSummary?.grants?.[currency.id];\n+      const grantData = creditSummary?.grants?.[currency.id];\n+      if (!grantData) return false;\n+      // Filter out credits with zero balance\n+      if (grantData.totalAmount === '0' && grantData.remainingAmount === '0') {\n+        return false;\n+      }\n+      return true;\n     });\n   }, [creditCurrencies, creditSummary?.grants]);\n \n[继续包含diff的其余部分...]"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":9,"cache_creation_input_tokens":35483,"cache_read_input_tokens":12834,"cache_creation":{"ephemeral_5m_input_tokens":35483,"ephemeral_1h_input_tokens":0},"output_tokens":12292,"service_tier":"standard"}},"requestId":"req_011CX3bN4CQGmr1kRnnW32dn","type":"assistant","uuid":"fe98dae1-ad83-4037-9722-3cb66ec50397","timestamp":"2026-01-12T13:53:51.625Z"}
{"parentUuid":"fe98dae1-ad83-4037-9722-3cb66ec50397","isSidechain":false,"userType":"external","cwd":"~/Arcblock/payment-kit-master/blocklets/core","sessionId":"664f44d5-76eb-4da6-b55c-a98e01f05344","version":"2.0.76","gitBranch":"feat-quote","type":"user","message":{"role":"user","content":[{"type":"tool_result","tool_use_id":"toolu_01LCR9wGFQjHZxVB4z1yckSY","content":"Launching skill: diff-review-doc"}]},"uuid":"bc3febc5-7dac-478f-b9fe-c3b7370b4845","timestamp":"2026-01-12T13:56:18.507Z","toolUseResult":{"success":true,"commandName":"diff-review-doc"}}
{"parentUuid":"bc3febc5-7dac-478f-b9fe-c3b7370b4845","isSidechain":false,"userType":"external","cwd":"~/Arcblock/payment-kit-master/blocklets/core","sessionId":"664f44d5-76eb-4da6-b55c-a98e01f05344","version":"2.0.76","gitBranch":"feat-quote","type":"user","message":{"role":"user","content":[{"type":"text","text":"Base directory for this skill: ~/.claude/skills/diff-review-doc\n\n# Diff Review Doc\n\nGenerate comprehensive code review documents from git diffs, providing detailed analysis with real code snippets, business flow breakdown, and actionable review recommendations.\n\n## Workflow\n\n### 1. Obtain Diff Content\n\n**If user provides diff directly:**\n- Accept the diff content as-is\n- Parse to identify changed files and hunks\n\n**If no diff is provided:**\n- Use `scripts/get_diff.sh` to retrieve changes:\n  ```bash\n  # Get all uncommitted changes (default)\n  ./scripts/get_diff.sh\n\n  # Get staged changes only\n  ./scripts/get_diff.sh --staged\n\n  # Compare with a branch\n  ./scripts/get_diff.sh --branch main\n\n  # Get changes from specific commit\n  ./scripts/get_diff.sh --commit abc123\n  ```\n\n### 2. Analyze the Changes\n\n**Parse the diff to extract:**\n- File paths and change types (added/modified/deleted)\n- Line-level changes (+/- lines)\n- Context around changes\n\n**Read relevant files:**\n- For significant changes, read the full file to understand context\n- For large files (>500 lines), focus on changed sections with surrounding context\n- Pay special attention to backend files and large file changes\n\n**Identify patterns:**\n- Consult `references/patterns.md` for common code issues\n- Look for anti-patterns, security vulnerabilities, performance issues\n- Check architectural concerns\n\n### 3. Structure the Analysis\n\n**Follow this analysis framework:**\n\n1. **改动概览 (Change Summary)**\n   - Count files changed, lines added/removed\n   - Identify change type (feature/bugfix/refactor/performance/security)\n   - List key files with brief descriptions\n   - Note dependency or configuration changes\n\n2. **业务流程分析 (Business Flow Analysis)**\n   - Explain what functionality is being implemented/changed\n   - Map out the complete business flow\n   - Show data flow between components\n   - Identify all affected modules\n\n3. **关键代码详解 (Key Code Analysis)**\n   - For each significant file:\n     - Show actual diff snippets (use real code from the diff)\n     - Explain what the code does and why it changed\n     - Highlight logic correctness, edge cases, error handling, performance\n   - Prioritize backend files and large changes (>200 lines)\n   - Include file paths with line numbers for reference\n\n4. **风险评估 (Risk Assessment)**\n   - Categorize risks as High/Medium/Low\n   - Identify breaking changes, security concerns, performance impacts\n   - Suggest mitigation measures\n   - Flag large file changes and backend-critical changes\n\n### 4. Generate Review Recommendations\n\n**Consult `references/review-checklist.md` for comprehensive evaluation criteria:**\n\n- **代码质量 (Code Quality)**: Readability, complexity, best practices\n- **架构设计 (Architecture)**: Modularity, coupling, extensibility, data flow\n- **功能验证 (Functionality)**: Business logic, error handling, data consistency\n- **安全性 (Security)**: Input validation, authentication, data protection (if applicable)\n- **性能 (Performance)**: Database queries, resource usage, caching (if applicable)\n\n**For each category:**\n- Give a rating (1-5 stars)\n- List strengths (what's done well)\n- List issues (what needs improvement)\n- Provide specific, actionable recommendations\n\n**Final recommendation:**\n- Must Fix: Critical issues that block merge\n- Should Fix: Important issues to address\n- Nice to Have: Optional improvements\n- Merge decision: Approve / Conditional / Needs Work\n\n### 5. Write the Review Document\n\n**Use `assets/review-template.md` as the base structure:**\n- Copy the template structure\n- Fill in all sections with actual analysis from steps 2-4\n- Ensure all code snippets are real (from the actual diff)\n- Include complete business flow explanation\n- Provide specific, actionable review suggestions\n\n**Output:**\n- Save as a Markdown file (e.g., `REVIEW.md`)\n- Format for easy reading (proper headings, code blocks, lists)\n- Include generation timestamp\n\n## Key Principles\n\n### Base on Real Code\n- All code snippets must be extracted from the actual diff\n- Never use placeholder or example code\n- Show actual line numbers and file paths\n\n### Complete Business Context\n- Explain the full user journey and data flow\n- Connect frontend changes to backend logic\n- Show how pieces fit together\n\n### Actionable Review Suggestions\n- Be specific about what to check\n- Identify potential risks with clear explanations\n- Provide concrete improvement suggestions\n- Prioritize issues by severity\n\n### Focus on Critical Areas\n- **Large file changes**: >200 lines need detailed review\n- **Backend changes**: API, database, auth, integrations\n- **Architectural changes**: Design patterns, module boundaries\n- **Security-sensitive code**: Input validation, data access\n\n## Resources\n\n### scripts/get_diff.sh\nBash script to retrieve git diffs in various scenarios. Supports getting uncommitted changes, staged changes, branch comparisons, and specific commits.\n\n### references/review-checklist.md\nComprehensive checklist covering all aspects of code review: quality, architecture, functionality, security, performance, testing, compatibility, operations, and documentation.\n\nLoad this reference when generating review recommendations to ensure thorough evaluation.\n\n### references/patterns.md\nCatalog of common code patterns to watch for, including anti-patterns, security vulnerabilities, performance issues, and architectural concerns.\n\nLoad this reference during analysis phase to identify potential issues in the code changes.\n\n### assets/review-template.md\nStructured Markdown template for the review document. Provides consistent format with sections for change summary, business flow, code analysis, risk assessment, and review recommendations.\n\nUse as the base structure and fill in with actual analysis.\n\n\nARGUMENTS: diff --git a/blocklets/core/api/src/libs/notification/template/customer-auto-recharge-daily-limit-exceeded.ts b/blocklets/core/api/src/libs/notification/template/customer-auto-recharge-daily-limit-exceeded.ts\nnew file mode 100644\nindex 000000000..54cf7574f\n--- /dev/null\n+++ b/blocklets/core/api/src/libs/notification/template/customer-auto-recharge-daily-limit-exceeded.ts\n@@ -0,0 +1,222 @@\n+/* eslint-disable @typescript-eslint/brace-style */\n+/* eslint-disable @typescript-eslint/indent */\n+import { withQuery } from 'ufo';\n+import { getUserLocale } from '../../../integrations/blocklet/notification';\n+import { translate } from '../../../locales';\n+import { AutoRechargeConfig, Customer, PaymentMethod, Price, Product } from '../../../store/models';\n+import { PaymentCurrency } from '../../../store/models/payment-currency';\n+import { getRechargePaymentUrl } from '../../currency';\n+import { formatTime } from '../../time';\n+import { formatCurrencyInfo, getConnectQueryParam, getCustomerIndexUrl } from '../../util';\n+import type { BaseEmailTemplate, BaseEmailTemplateType } from './base';\n+\n+export interface CustomerAutoRechargeDailyLimitExceededEmailTemplateOptions {\n+  customerId: string;\n+  autoRechargeConfigId: string;\n+  currencyId: string;\n+  currentBalance: string;\n+}\n+\n+interface CustomerAutoRechargeDailyLimitExceededEmailTemplateContext {\n+  locale: string;\n+  userDid: string;\n+  at: string;\n+  creditCurrencyName: string;\n+  currentBalance: string;\n+  dailyLimit: string;\n+  dailyUsed: string;\n+  rechargeUrl: string | null;\n+  customerIndexUrl: string;\n+}\n+\n+export class CustomerAutoRechargeDailyLimitExceededEmailTemplate\n+  implements BaseEmailTemplate<CustomerAutoRechargeDailyLimitExceededEmailTemplateContext>\n+{\n+  options: CustomerAutoRechargeDailyLimitExceededEmailTemplateOptions;\n+\n+  constructor(options: CustomerAutoRechargeDailyLimitExceededEmailTemplateOptions) {\n+    this.options = options;\n+  }\n+\n+  async getContext(): Promise<CustomerAutoRechargeDailyLimitExceededEmailTemplateContext> {\n+    const customer = await Customer.findByPk(this.options.customerId);\n+    if (!customer) {\n+      throw new Error(`Customer not found: ${this.options.customerId}`);\n+    }\n+\n+    const autoRechargeConfig = await AutoRechargeConfig.findByPk(this.options.autoRechargeConfigId, {\n+      include: [\n+        {\n+          model: Price,\n+          as: 'price',\n+          include: [{ model: Product, as: 'product' }],\n+        },\n+        {\n+          model: PaymentMethod,\n+          as: 'paymentMethod',\n+        },\n+        {\n+          model: PaymentCurrency,\n+          as: 'rechargeCurrency',\n+        },\n+      ],\n+    });\n+    if (!autoRechargeConfig) {\n+      throw new Error(`AutoRechargeConfig not found: ${this.options.autoRechargeConfigId}`);\n+    }\n+\n+    // Get credit currency\n+    const creditCurrency = await PaymentCurrency.findByPk(autoRechargeConfig.currency_id);\n+    if (!creditCurrency) {\n+      throw new Error(`Credit currency not found: ${autoRechargeConfig.currency_id}`);\n+    }\n+\n+    const rechargeCurrency = await PaymentCurrency.findByPk(autoRechargeConfig.recharge_currency_id);\n+    const paymentMethod = await PaymentMethod.findByPk(autoRechargeConfig.payment_method_id);\n+\n+    const userDid: string = customer.did;\n+    const locale = await getUserLocale(userDid);\n+    const at: string = formatTime(Date.now());\n+\n+    const creditCurrencyName = creditCurrency.name || 'Credits';\n+    const currentBalance = formatCurrencyInfo(this.options.currentBalance, creditCurrency, null);\n+\n+    // Format daily limit and usage\n+    const dailyLimit = rechargeCurrency\n+      ? formatCurrencyInfo(autoRechargeConfig.daily_limits?.max_amount || '0', rechargeCurrency, paymentMethod)\n+      : autoRechargeConfig.daily_limits?.max_amount || '0';\n+    const dailyUsed = rechargeCurrency\n+      ? formatCurrencyInfo(autoRechargeConfig.daily_stats?.total_amount || '0', rechargeCurrency, paymentMethod)\n+      : autoRechargeConfig.daily_stats?.total_amount || '0';\n+\n+    // Get recharge URL\n+    let rechargeUrl: string | null = await getRechargePaymentUrl(creditCurrency);\n+    if (rechargeUrl) {\n+      rechargeUrl = withQuery(rechargeUrl, { ...getConnectQueryParam({ userDid }) });\n+    }\n+\n+    // Get customer index URL for managing credits\n+    const customerIndexUrl = getCustomerIndexUrl({\n+      locale,\n+      userDid,\n+    });\n+\n+    return {\n+      locale,\n+      userDid,\n+      at,\n+      creditCurrencyName,\n+      currentBalance,\n+      dailyLimit,\n+      dailyUsed,\n+      rechargeUrl,\n+      customerIndexUrl,\n+    };\n+  }\n+\n+  async getTemplate(): Promise<BaseEmailTemplateType> {\n+    const {\n+      locale,\n+      userDid,\n+      at,\n+      creditCurrencyName,\n+      currentBalance,\n+      dailyLimit,\n+      dailyUsed,\n+      rechargeUrl,\n+      customerIndexUrl,\n+    } = await this.getContext();\n+\n+    const template: BaseEmailTemplateType = {\n+      title: translate('notification.autoRechargeDailyLimitExceeded.title', locale),\n+      body: translate('notification.autoRechargeDailyLimitExceeded.body', locale, {\n+        at,\n+        creditCurrencyName,\n+      }),\n+      // @ts-expect-error\n+      attachments: [\n+        {\n+          type: 'section',\n+          fields: [\n+            {\n+              type: 'text',\n+              data: {\n+                type: 'plain',\n+                color: '#9397A1',\n+                text: translate('notification.common.account', locale),\n+              },\n+            },\n+            {\n+              type: 'text',\n+              data: {\n+                type: 'plain',\n+                text: userDid,\n+              },\n+            },\n+            {\n+              type: 'text',\n+              data: {\n+                type: 'plain',\n+                color: '#9397A1',\n+                text: translate('notification.common.currentBalance', locale),\n+              },\n+            },\n+            {\n+              type: 'text',\n+              data: {\n+                type: 'plain',\n+                color: '#FF6B00',\n+                text: currentBalance,\n+              },\n+            },\n+            {\n+              type: 'text',\n+              data: {\n+                type: 'plain',\n+                color: '#9397A1',\n+                text: translate('notification.autoRechargeDailyLimitExceeded.dailyLimit', locale),\n+              },\n+            },\n+            {\n+              type: 'text',\n+              data: {\n+                type: 'plain',\n+                text: dailyLimit,\n+              },\n+            },\n+            {\n+              type: 'text',\n+              data: {\n+                type: 'plain',\n+                color: '#9397A1',\n+                text: translate('notification.autoRechargeDailyLimitExceeded.dailyUsed', locale),\n+              },\n+            },\n+            {\n+              type: 'text',\n+              data: {\n+                type: 'plain',\n+                text: dailyUsed,\n+              },\n+            },\n+          ].filter(Boolean),\n+        },\n+      ].filter(Boolean),\n+      // @ts-ignore\n+      actions: [\n+        rechargeUrl && {\n+          name: translate('notification.common.reloadCredits', locale),\n+          title: translate('notification.common.reloadCredits', locale),\n+          link: rechargeUrl,\n+        },\n+        {\n+          name: translate('notification.common.manageCredit', locale),\n+          title: translate('notification.common.manageCredit', locale),\n+          link: customerIndexUrl,\n+        },\n+      ].filter(Boolean),\n+    };\n+\n+    return template;\n+  }\n+}\ndiff --git a/blocklets/core/api/src/libs/notification/template/customer-credit-low-balance.ts b/blocklets/core/api/src/libs/notification/template/customer-credit-low-balance.ts\nindex da264ea14..044a2f56e 100644\n--- a/blocklets/core/api/src/libs/notification/template/customer-credit-low-balance.ts\n+++ b/blocklets/core/api/src/libs/notification/template/customer-credit-low-balance.ts\n@@ -1,10 +1,10 @@\n /* eslint-disable @typescript-eslint/brace-style */\n /* eslint-disable @typescript-eslint/indent */\n import { withQuery } from 'ufo';\n-import { fromUnitToToken } from '@ocap/util';\n+import { BN, fromUnitToToken } from '@ocap/util';\n import { getUserLocale } from '../../../integrations/blocklet/notification';\n import { translate } from '../../../locales';\n-import { Customer, PaymentCurrency } from '../../../store/models';\n+import { Customer, PaymentCurrency, CreditGrant } from '../../../store/models';\n import type { BaseEmailTemplate, BaseEmailTemplateType } from './base';\n import { formatCreditAmount, getConnectQueryParam, getCustomerIndexUrl, formatNumber } from '../../util';\n import { getRechargePaymentUrl } from '../../currency';\n@@ -29,6 +29,41 @@ interface CustomerCreditLowBalanceEmailTemplateContext {\n export class CustomerCreditLowBalanceEmailTemplate\n   implements BaseEmailTemplate<CustomerCreditLowBalanceEmailTemplateContext>\n {\n+  // Notification configuration: 10 minute grace period before sending\n+  static readonly delay = 10 * 60; // seconds\n+  static readonly LOW_BALANCE_THRESHOLD_PERCENT = 10;\n+\n+  /**\n+   * Preflight check: verify if notification should still be sent\n+   * Returns false if user has recharged during grace period\n+   */\n+  static async preflightCheck(options: CustomerCreditLowBalanceEmailTemplateOptions): Promise<boolean> {\n+    try {\n+      const { customerId, currencyId } = options;\n+\n+      const availableGrants = await CreditGrant.getAvailableCreditsForCustomer(customerId, currencyId);\n+      const totalAmount = availableGrants.reduce((sum, grant) => sum.add(new BN(grant.amount)), new BN(0));\n+      const remainingAmount = availableGrants.reduce(\n+        (sum, grant) => sum.add(new BN(grant.remaining_amount)),\n+        new BN(0)\n+      );\n+\n+      // Skip if no credits exist\n+      if (totalAmount.lte(new BN(0))) {\n+        return false;\n+      }\n+\n+      // Calculate current percentage\n+      const currentPercentage = remainingAmount.mul(new BN(100)).div(totalAmount).toNumber();\n+\n+      // If balance is above threshold, user has recharged - skip notification\n+      return currentPercentage <= CustomerCreditLowBalanceEmailTemplate.LOW_BALANCE_THRESHOLD_PERCENT;\n+    } catch {\n+      // On error, proceed with sending to avoid missing important notifications\n+      return true;\n+    }\n+  }\n+\n   options: CustomerCreditLowBalanceEmailTemplateOptions;\n \n   constructor(options: CustomerCreditLowBalanceEmailTemplateOptions) {\n@@ -36,7 +71,7 @@ export class CustomerCreditLowBalanceEmailTemplate\n   }\n \n   async getContext(): Promise<CustomerCreditLowBalanceEmailTemplateContext> {\n-    const { customerId, currencyId, availableAmount, percentage } = this.options;\n+    const { customerId, currencyId } = this.options;\n \n     const customer = await Customer.findByPk(customerId);\n     if (!customer) {\n@@ -48,16 +83,24 @@ export class CustomerCreditLowBalanceEmailTemplate\n       throw new Error(`PaymentCurrency not found: ${currencyId}`);\n     }\n \n+    // Fetch latest balance data instead of using stale data from options\n+    const availableGrants = await CreditGrant.getAvailableCreditsForCustomer(customerId, currencyId);\n+    const totalAmount = availableGrants.reduce((sum, grant) => sum.add(new BN(grant.amount)), new BN(0));\n+    const remainingAmount = availableGrants.reduce((sum, grant) => sum.add(new BN(grant.remaining_amount)), new BN(0));\n+\n+    const currentPercentage = totalAmount.gt(new BN(0))\n+      ? remainingAmount.mul(new BN(100)).div(totalAmount).toNumber()\n+      : 0;\n+\n     const userDid = customer.did;\n     const locale = await getUserLocale(userDid);\n \n-    const formattedAmount = formatNumber(fromUnitToToken(availableAmount, paymentCurrency.decimal));\n+    const formattedAmount = formatNumber(fromUnitToToken(remainingAmount.toString(), paymentCurrency.decimal));\n     const available = formatCreditAmount(formattedAmount || '0', paymentCurrency.symbol);\n-    const percentageNum = parseFloat(percentage);\n-    const isCritical = percentageNum < 1;\n+    const isCritical = currentPercentage < 1;\n     const lowBalancePercentage = isCritical\n       ? translate('notification.creditLowBalance.lessThanOnePercent', locale)\n-      : `${percentage}%`;\n+      : `${currentPercentage}%`;\n \n     let rechargeUrl: string | null = await getRechargePaymentUrl(paymentCurrency);\n     if (rechargeUrl) {\ndiff --git a/blocklets/core/api/src/locales/en.ts b/blocklets/core/api/src/locales/en.ts\nindex 2ab23903e..b6c0609e4 100644\n--- a/blocklets/core/api/src/locales/en.ts\n+++ b/blocklets/core/api/src/locales/en.ts\n@@ -175,6 +175,13 @@ export default flat({\n       },\n     },\n \n+    autoRechargeDailyLimitExceeded: {\n+      title: 'Auto Top-Up daily limit reached',\n+      body: 'Your {creditCurrencyName} balance is low, but auto top-up was not triggered because you have reached the daily recharge limit on {at}. You can manually reload or wait until tomorrow for automatic top-up.',\n+      dailyLimit: 'Daily Limit',\n+      dailyUsed: 'Used Today',\n+    },\n+\n     subscriptionRefundSucceeded: {\n       title: '{productName} refund successful',\n       body: 'Your subscription to {productName} has been successfully refunded on {at}, with a refund amount of {refundInfo}. If you have any questions, please feel free to contact us.',\ndiff --git a/blocklets/core/api/src/locales/zh.ts b/blocklets/core/api/src/locales/zh.ts\nindex 23ec345fd..c8ac344c4 100644\n--- a/blocklets/core/api/src/locales/zh.ts\n+++ b/blocklets/core/api/src/locales/zh.ts\n@@ -167,6 +167,13 @@ export default flat({\n       },\n     },\n \n+    autoRechargeDailyLimitExceeded: {\n+      title: '自动充值已达每日限额',\n+      body: '您的 {creditCurrencyName} 余额偏低,但由于已达到每日充值限额,自动充值于 {at} 未能触发。您可以手动充值,或等待明天自动充值。',\n+      dailyLimit: '每日限额',\n+      dailyUsed: '今日已用',\n+    },\n+\n     subscriptionRefundSucceeded: {\n       title: '{productName} 退款成功',\n       body: '您订阅的 {productName} 在 {at} 已退款成功,退款金额为 {refundInfo}。如有任何疑问,请随时与我们联系。',\ndiff --git a/blocklets/core/api/src/queues/auto-recharge.ts b/blocklets/core/api/src/queues/auto-recharge.ts\nindex 5c52c9f30..a94da4bcf 100644\n--- a/blocklets/core/api/src/queues/auto-recharge.ts\n+++ b/blocklets/core/api/src/queues/auto-recharge.ts\n@@ -15,6 +15,7 @@ import {\n   TPriceExpanded,\n } from '../store/models';\n import logger from '../libs/logger';\n+import { createEvent } from '../libs/audit';\n import { createStripeInvoiceForAutoRecharge } from '../integrations/stripe/resource';\n import { ensureInvoiceAndItems } from '../libs/invoice';\n import dayjs from '../libs/dayjs';\n@@ -126,6 +127,12 @@ export async function processAutoRecharge(job: AutoRechargeJobData) {\n       customerId,\n       currencyId,\n     });\n+    // Send notification when daily limit is exceeded\n+    createEvent('Customer', 'customer.auto_recharge.daily_limit_exceeded', customer, {\n+      autoRechargeConfigId: config.id,\n+      currencyId,\n+      currentBalance: totalAvailable.toString(),\n+    });\n     return;\n   }\n \ndiff --git a/blocklets/core/api/src/queues/credit-consume.ts b/blocklets/core/api/src/queues/credit-consume.ts\nindex 97a25f215..d91006d9a 100644\n--- a/blocklets/core/api/src/queues/credit-consume.ts\n+++ b/blocklets/core/api/src/queues/credit-consume.ts\n@@ -249,6 +249,9 @@ async function consumeAvailableCredits(\n   const pendingAmount = Math.max(0, finalPending.toNumber()).toString();\n   const remainingBalance = totalAvailable.sub(consumed).toString();\n \n+  // Track whether insufficient event was triggered to skip low_balance notification\n+  let insufficientTriggered = false;\n+\n   // 如果无法完全消费所需额度,记录不足事件\n   if (finalPending.gt(new BN(0))) {\n     logger.warn('Insufficient credit balance', {\n@@ -260,6 +263,7 @@ async function consumeAvailableCredits(\n       pendingAmount,\n     });\n     if ((context.subscription && context.subscription.isActive()) || !context.subscription) {\n+      insufficientTriggered = true;\n       await createEvent('Customer', 'customer.credit.insufficient', context.customer, {\n         metadata: {\n           meter_event_id: context.meterEvent.id,\n@@ -297,6 +301,7 @@ async function consumeAvailableCredits(\n       });\n     }\n   } else if (remainingBalance === '0') {\n+    insufficientTriggered = true;\n     await createEvent('Customer', 'customer.credit.insufficient', context.customer, {\n       metadata: {\n         meter_event_id: context.meterEvent.id,\n@@ -312,7 +317,10 @@ async function consumeAvailableCredits(\n     }).catch(console.error);\n   }\n \n-  await checkLowBalance(customerId, currencyId, totalCreditAmountBN.toString(), remainingBalance, context);\n+  // Skip low_balance check if insufficient was already triggered (insufficient takes priority)\n+  if (!insufficientTriggered) {\n+    await checkLowBalance(customerId, currencyId, totalCreditAmountBN.toString(), remainingBalance, context);\n+  }\n \n   return {\n     consumed: totalConsumed.toString(),\ndiff --git a/blocklets/core/api/src/queues/notification.ts b/blocklets/core/api/src/queues/notification.ts\nindex b3f8b910e..961bd79c0 100644\n--- a/blocklets/core/api/src/queues/notification.ts\n+++ b/blocklets/core/api/src/queues/notification.ts\n@@ -102,6 +102,10 @@ import {\n   CustomerAutoRechargeFailedEmailTemplate,\n   CustomerAutoRechargeFailedEmailTemplateOptions,\n } from '../libs/notification/template/customer-auto-recharge-failed';\n+import {\n+  CustomerAutoRechargeDailyLimitExceededEmailTemplate,\n+  CustomerAutoRechargeDailyLimitExceededEmailTemplateOptions,\n+} from '../libs/notification/template/customer-auto-recharge-daily-limit-exceeded';\n import {\n   CustomerRevenueSucceededEmailTemplate,\n   CustomerRevenueSucceededEmailTemplateOptions,\n@@ -139,6 +143,7 @@ export type NotificationQueueJobType =\n   | 'customer.credit_grant.granted'\n   | 'customer.credit.low_balance'\n   | 'customer.auto_recharge.failed'\n+  | 'customer.auto_recharge.daily_limit_exceeded'\n   | 'webhook.endpoint.failed';\n \n export type NotificationQueueJob = {\n@@ -285,6 +290,12 @@ async function getNotificationTemplate(job: NotificationQueueJob): Promise<BaseE\n     return new CustomerAutoRechargeFailedEmailTemplate(job.options as CustomerAutoRechargeFailedEmailTemplateOptions);\n   }\n \n+  if (job.type === 'customer.auto_recharge.daily_limit_exceeded') {\n+    return new CustomerAutoRechargeDailyLimitExceededEmailTemplate(\n+      job.options as CustomerAutoRechargeDailyLimitExceededEmailTemplateOptions\n+    );\n+  }\n+\n   if (job.type === 'webhook.endpoint.failed') {\n     return new WebhookEndpointFailedEmailTemplate(job.options as WebhookEndpointFailedEmailTemplateOptions);\n   }\n@@ -296,6 +307,18 @@ async function handleNotificationJob(job: NotificationQueueJob): Promise<void> {\n   try {\n     const template = await getNotificationTemplate(job);\n \n+    // Check if template class has a preflightCheck\n+    const TemplateClass = template.constructor as any;\n+    if (TemplateClass.preflightCheck) {\n+      const shouldSend = await TemplateClass.preflightCheck(job.options);\n+      if (!shouldSend) {\n+        logger.info('handleNotificationJob.skipped: preflight check returned false', {\n+          type: job.type,\n+        });\n+        return;\n+      }\n+    }\n+\n     await new Notification(template, job.type).send();\n     logger.info('handleImmediateNotificationJob.success', { job });\n   } catch (error) {\n@@ -624,7 +647,7 @@ export async function startNotificationQueue() {\n   });\n \n   events.on('customer.credit.low_balance', (customer: Customer, { metadata }: { metadata: any }) => {\n-    addNotificationJob(\n+    addNotificationJobWithDelay(\n       'customer.credit.low_balance',\n       {\n         customerId: customer.id,\n@@ -678,6 +701,29 @@ export async function startNotificationQueue() {\n       }\n     }\n   );\n+\n+  events.on(\n+    'customer.auto_recharge.daily_limit_exceeded',\n+    (customer: Customer, { autoRechargeConfigId, currencyId, currentBalance }) => {\n+      logger.info('addNotificationJob:customer.auto_recharge.daily_limit_exceeded', {\n+        customerId: customer.id,\n+        autoRechargeConfigId,\n+        currencyId,\n+      });\n+      addNotificationJob(\n+        'customer.auto_recharge.daily_limit_exceeded',\n+        {\n+          customerId: customer.id,\n+          autoRechargeConfigId,\n+          currencyId,\n+          currentBalance,\n+        },\n+        [customer.id, autoRechargeConfigId, currencyId],\n+        true, // prevent duplicate\n+        24 * 3600 // 24 hours\n+      );\n+    }\n+  );\n }\n \n export async function handleNotificationPreferenceChange(\n@@ -812,3 +858,55 @@ export function addNotificationJob(\n     },\n   });\n }\n+\n+/**\n+ * Add a notification job with delay support\n+ * Use this when the template class has a static `delay` property\n+ */\n+export async function addNotificationJobWithDelay(\n+  type: NotificationQueueJobType,\n+  options: NotificationQueueJobOptions,\n+  extraIds: string[] = [],\n+  preventDuplicate: boolean = false,\n+  duplicateWindow: number = 600\n+) {\n+  const idParts = [type];\n+\n+  if (extraIds.length) {\n+    idParts.push(...extraIds);\n+  } else {\n+    idParts.push(Date.now().toString());\n+  }\n+\n+  if (preventDuplicate) {\n+    const cacheKey = `${type}.${extraIds.join('.')}`;\n+    const lastSent = notificationCache.get(cacheKey);\n+    const now = Date.now();\n+\n+    if (lastSent && now - lastSent < duplicateWindow * 1000) {\n+      logger.info('Notification skipped due to duplicate prevention', {\n+        type,\n+        cacheKey,\n+        lastSent: new Date(lastSent),\n+        duplicateWindow,\n+      });\n+      return Promise.resolve();\n+    }\n+\n+    notificationCache.set(cacheKey, now);\n+  }\n+\n+  // Get delay from template class\n+  const template = await getNotificationTemplate({ type, options });\n+  const TemplateClass = template.constructor as any;\n+  const { delay } = TemplateClass;\n+\n+  return notificationQueue.push({\n+    id: idParts.join('.'),\n+    job: {\n+      type,\n+      options,\n+    },\n+    ...(delay && delay > 0 ? { delay } : {}),\n+  });\n+}\ndiff --git a/blocklets/core/api/src/routes/credit-transactions.ts b/blocklets/core/api/src/routes/credit-transactions.ts\nindex 2e7114cf5..a371778c7 100644\n--- a/blocklets/core/api/src/routes/credit-transactions.ts\n+++ b/blocklets/core/api/src/routes/credit-transactions.ts\n@@ -15,6 +15,7 @@ import {\n   Subscription,\n   PaymentCurrency,\n   PaymentMethod,\n+  Invoice,\n   TCreditTransactionExpanded,\n } from '../store/models';\n \n@@ -118,7 +119,12 @@ router.get('/', authMine, async (req, res) => {\n               { model: Meter, as: 'meter' },\n               { model: Subscription, as: 'subscription', attributes: ['id', 'description', 'status'], required: false },\n               { model: CreditGrant, as: 'creditGrant', attributes: ['id', 'name', 'currency_id'] },\n-              { model: MeterEvent, as: 'meterEvent', attributes: ['id', 'source_data'], required: false },\n+              {\n+                model: MeterEvent,\n+                as: 'meterEvent',\n+                attributes: ['id', 'source_data', 'timestamp', 'processed_at', 'created_at'],\n+                required: false,\n+              },\n             ],\n           });\n           // Transform transactions\n@@ -135,6 +141,9 @@ router.get('/', authMine, async (req, res) => {\n         customer_id: query.customer_id,\n         status: ['granted', 'depleted', 'expired'],\n       };\n+      if (query.subscription_id) {\n+        grantWhere['metadata.subscription_id'] = query.subscription_id;\n+      }\n       if (query.start) {\n         grantWhere.created_at = {\n           [Op.gte]: new Date(query.start * 1000),\n@@ -162,11 +171,80 @@ router.get('/', authMine, async (req, res) => {\n               },\n             ],\n           });\n-          // Transform grants\n-          return rows.map((item: any) => ({\n-            ...item.toJSON(),\n-            activity_type: 'grant',\n-          }));\n+\n+          // Fetch invoice info for paid grants\n+          const invoiceIds = rows\n+            .map((item: any) => item.metadata?.invoice_id)\n+            .filter((id: string | undefined): id is string => !!id);\n+\n+          // For first scheduled grants (schedule_seq === 1) without invoice_id, find invoice by subscription_id\n+          const subscriptionIdsForFirstGrant = rows\n+            .filter(\n+              (item: any) =>\n+                item.metadata?.schedule_seq === 1 && !item.metadata?.invoice_id && item.metadata?.subscription_id\n+            )\n+            .map((item: any) => item.metadata.subscription_id);\n+\n+          const [invoicesByIds, invoicesBySubscription] = await Promise.all([\n+            invoiceIds.length > 0\n+              ? Invoice.findAll({\n+                  where: { id: { [Op.in]: invoiceIds } },\n+                  attributes: ['id', 'total', 'amount_paid', 'currency_id', 'billing_reason', 'subscription_id'],\n+                  include: [\n+                    {\n+                      model: PaymentCurrency,\n+                      as: 'paymentCurrency',\n+                      attributes: ['id', 'symbol', 'decimal', 'type'],\n+                    },\n+                  ],\n+                })\n+              : [],\n+            subscriptionIdsForFirstGrant.length > 0\n+              ? Invoice.findAll({\n+                  where: {\n+                    subscription_id: { [Op.in]: subscriptionIdsForFirstGrant },\n+                    status: 'paid',\n+                  },\n+                  attributes: ['id', 'total', 'amount_paid', 'currency_id', 'billing_reason', 'subscription_id'],\n+                  include: [\n+                    {\n+                      model: PaymentCurrency,\n+                      as: 'paymentCurrency',\n+                      attributes: ['id', 'symbol', 'decimal', 'type'],\n+                    },\n+                  ],\n+                  order: [['created_at', 'ASC']],\n+                })\n+              : [],\n+          ]);\n+\n+          const invoiceMap = new Map(invoicesByIds.map((inv: any) => [inv.id, inv]));\n+          for (const inv of invoicesBySubscription) {\n+            const subId = inv.subscription_id as string;\n+            if (subId && !invoiceMap.has(subId)) {\n+              invoiceMap.set(subId, inv);\n+            }\n+          }\n+\n+          // Transform grants with invoice info\n+          return rows.map((item: any) => {\n+            const grantData = item.toJSON();\n+            const invoice = invoiceMap.get(grantData.metadata.invoice_id);\n+            return {\n+              ...grantData,\n+              activity_type: 'grant',\n+              invoice: invoice\n+                ? {\n+                    total: invoice.total,\n+                    amount_paid: invoice.amount_paid,\n+                    currency_id: invoice.currency_id,\n+                    billing_reason: invoice.billing_reason,\n+                    subscription_id: invoice.subscription_id,\n+                    paymentCurrency: invoice.paymentCurrency,\n+                  }\n+                : null,\n+            };\n+          });\n         },\n         meta: { type: 'database' },\n       };\n@@ -344,7 +422,7 @@ router.get('/:id', authPortal, async (req, res) => {\n         {\n           model: MeterEvent,\n           as: 'meterEvent',\n-          attributes: ['id', 'source_data'],\n+          attributes: ['id', 'source_data', 'timestamp', 'processed_at', 'created_at'],\n           required: false,\n         },\n       ],\ndiff --git a/blocklets/core/api/src/routes/invoices.ts b/blocklets/core/api/src/routes/invoices.ts\nindex 3a42f934c..a03c19157 100644\n--- a/blocklets/core/api/src/routes/invoices.ts\n+++ b/blocklets/core/api/src/routes/invoices.ts\n@@ -311,6 +311,18 @@ router.get('/', authMine, async (req, res) => {\n             { model: PaymentCurrency, as: 'paymentCurrency' },\n             { model: PaymentMethod, as: 'paymentMethod' },\n             { model: Subscription, as: 'subscription', attributes: ['id', 'description'] },\n+            {\n+              model: InvoiceItem,\n+              as: 'lines',\n+              include: [\n+                {\n+                  model: Price,\n+                  as: 'price',\n+                  attributes: ['id', 'metadata'],\n+                  include: [{ model: Product, as: 'product', attributes: ['id', 'type', 'name'] }],\n+                },\n+              ],\n+            },\n             { model: Customer, as: 'customer' },\n           ],\n         });\ndiff --git a/blocklets/core/api/src/routes/meter-events.ts b/blocklets/core/api/src/routes/meter-events.ts\nindex e4f398654..5d74a1487 100644\n--- a/blocklets/core/api/src/routes/meter-events.ts\n+++ b/blocklets/core/api/src/routes/meter-events.ts\n@@ -352,6 +352,165 @@ router.get('/pending-amount', authMine, async (req, res) => {\n     return res.status(400).json({ error: err?.message });\n   }\n });\n+\n+// Get overdue summary by credit currency (total pending amounts grouped by currency)\n+router.get('/overdue-summary', auth, async (req, res) => {\n+  try {\n+    // Query to aggregate credit_pending by currency, showing total overdue per credit currency\n+    const results = await MeterEvent.sequelize!.query<{\n+      currency_id: string;\n+      total_pending: string;\n+      customer_count: number;\n+      event_count: number;\n+    }>(\n+      `SELECT \n+        m.currency_id,\n+        SUM(CAST(me.credit_pending AS DECIMAL(40,0))) as total_pending,\n+        COUNT(DISTINCT json_extract(me.payload, '$.customer_id')) as customer_count,\n+        COUNT(*) as event_count\n+      FROM meter_events me\n+      JOIN meters m ON me.event_name = m.event_name\n+      WHERE me.livemode = :livemode \n+        AND CAST(me.credit_pending AS DECIMAL(40,0)) > 0\n+      GROUP BY m.currency_id\n+      HAVING total_pending > 0\n+      ORDER BY total_pending DESC`,\n+      {\n+        replacements: { livemode: req.livemode ? 1 : 0 },\n+        type: QueryTypes.SELECT,\n+      }\n+    );\n+\n+    // Fetch currency details\n+    const currencyIds = results.map((r) => r.currency_id);\n+    const currencies =\n+      currencyIds.length > 0 ? await PaymentCurrency.findAll({ where: { id: { [Op.in]: currencyIds } } }) : [];\n+    const currencyMap = new Map(currencies.map((c) => [c.id, c]));\n+\n+    const list = results.map((r) => ({\n+      currency: currencyMap.get(r.currency_id),\n+      total_pending: r.total_pending,\n+      customer_count: r.customer_count,\n+      event_count: r.event_count,\n+    }));\n+\n+    return res.json({ list });\n+  } catch (err) {\n+    logger.error('Error getting overdue summary', err);\n+    return res.status(400).json({ error: err?.message });\n+  }\n+});\n+\n+// Get all customers with credit overdue (pending amount > 0)\n+router.get('/overdue-customers', auth, async (req, res) => {\n+  try {\n+    const page = Math.max(1, parseInt(String(req.query.page || '1'), 10));\n+    const pageSize = Math.min(100, Math.max(1, parseInt(String(req.query.pageSize || '20'), 10)));\n+    const offset = (page - 1) * pageSize;\n+    const currencyId = req.query.currency_id as string | undefined;\n+    const searchQuery = req.query.q as string | undefined;\n+\n+    // Get currency info\n+    let currency: PaymentCurrency | null = null;\n+    if (currencyId) {\n+      currency = await PaymentCurrency.findByPk(currencyId);\n+      if (!currency) {\n+        return res.status(404).json({ error: `Currency ${currencyId} not found` });\n+      }\n+    }\n+\n+    // If search query provided, first find matching customer IDs\n+    let customerFilter = '';\n+    const replacements: any = { livemode: req.livemode ? 1 : 0, limit: pageSize, offset };\n+    if (currencyId) {\n+      replacements.currencyId = currencyId;\n+    }\n+\n+    if (searchQuery) {\n+      const searchCustomers = await Customer.findAll({\n+        where: {\n+          [Op.or]: [\n+            { name: { [Op.like]: `%${searchQuery}%` } },\n+            { email: { [Op.like]: `%${searchQuery}%` } },\n+            { did: { [Op.like]: `%${searchQuery}%` } },\n+          ],\n+        },\n+        attributes: ['id'],\n+      });\n+      const searchCustomerIds = searchCustomers.map((c) => c.id);\n+      if (searchCustomerIds.length === 0) {\n+        return res.json({ list: [], count: 0, paging: { page, pageSize }, currency });\n+      }\n+      customerFilter = `AND json_extract(me.payload, '$.customer_id') IN (${searchCustomerIds.map((id) => `'${id}'`).join(',')})`;\n+    }\n+\n+    // Build query with optional currency filter\n+    const currencyJoin = currencyId\n+      ? 'JOIN meters m ON me.event_name = m.event_name AND m.currency_id = :currencyId'\n+      : '';\n+\n+    // Query to aggregate credit_pending by customer, order by event_count DESC\n+    const results = await MeterEvent.sequelize!.query<{\n+      customer_id: string;\n+      total_pending: string;\n+      event_count: number;\n+    }>(\n+      `SELECT \n+        json_extract(me.payload, '$.customer_id') as customer_id,\n+        SUM(CAST(me.credit_pending AS DECIMAL(40,0))) as total_pending,\n+        COUNT(*) as event_count\n+      FROM meter_events me\n+      ${currencyJoin}\n+      WHERE me.livemode = :livemode \n+        AND CAST(me.credit_pending AS DECIMAL(40,0)) > 0\n+        ${customerFilter}\n+      GROUP BY json_extract(me.payload, '$.customer_id')\n+      HAVING total_pending > 0\n+      ORDER BY event_count DESC\n+      LIMIT :limit OFFSET :offset`,\n+      {\n+        replacements,\n+        type: QueryTypes.SELECT,\n+      }\n+    );\n+\n+    // Get total count\n+    const countResult = await MeterEvent.sequelize!.query<{ count: number }>(\n+      `SELECT COUNT(*) as count FROM (\n+        SELECT json_extract(me.payload, '$.customer_id') as customer_id\n+        FROM meter_events me\n+        ${currencyJoin}\n+        WHERE me.livemode = :livemode \n+          AND CAST(me.credit_pending AS DECIMAL(40,0)) > 0\n+          ${customerFilter}\n+        GROUP BY json_extract(me.payload, '$.customer_id')\n+        HAVING SUM(CAST(me.credit_pending AS DECIMAL(40,0))) > 0\n+      )`,\n+      {\n+        replacements: { livemode: req.livemode ? 1 : 0, ...(currencyId ? { currencyId } : {}) },\n+        type: QueryTypes.SELECT,\n+      }\n+    );\n+\n+    const count = countResult[0]?.count || 0;\n+    const customerIds = results.map((r) => r.customer_id);\n+\n+    // Fetch customer details\n+    const customers = customerIds.length > 0 ? await Customer.findAll({ where: { id: { [Op.in]: customerIds } } }) : [];\n+    const customerMap = new Map(customers.map((c) => [c.id, c]));\n+\n+    const list = results.map((r) => ({\n+      customer: customerMap.get(r.customer_id),\n+      total_pending: r.total_pending,\n+      event_count: r.event_count,\n+    }));\n+\n+    return res.json({ list, count, paging: { page, pageSize }, currency });\n+  } catch (err) {\n+    logger.error('Error getting overdue customers', err);\n+    return res.status(400).json({ error: err?.message });\n+  }\n+});\n router.get('/:id', authMine, async (req, res) => {\n   try {\n     logger.info('get meter event', { id: req.params.id });\ndiff --git a/blocklets/core/src/components/customer/credit-overview.tsx b/blocklets/core/src/components/customer/credit-overview.tsx\nindex 2645c9b40..d4ac2bf11 100644\n--- a/blocklets/core/src/components/customer/credit-overview.tsx\n+++ b/blocklets/core/src/components/customer/credit-overview.tsx\n@@ -259,7 +259,13 @@ export default function CreditOverview({ customerId, settings, mode = 'portal' }\n \n   const filteredCreditCurrencies = useMemo(() => {\n     return creditCurrencies.filter((currency: TPaymentCurrency) => {\n-      return creditSummary?.grants?.[currency.id];\n+      const grantData = creditSummary?.grants?.[currency.id];\n+      if (!grantData) return false;\n+      // Filter out credits with zero balance\n+      if (grantData.totalAmount === '0' && grantData.remainingAmount === '0') {\n+        return false;\n+      }\n+      return true;\n     });\n   }, [creditCurrencies, creditSummary?.grants]);\n \n[继续包含diff的其余部分...]"}]},"isMeta":true,"uuid":"ee3f90ea-4f88-451c-83eb-d88d2c6e6af0","timestamp":"2026-01-12T13:56:18.504Z","sourceToolUseID":"toolu_01LCR9wGFQjHZxVB4z1yckSY"}
{"parentUuid":"ee3f90ea-4f88-451c-83eb-d88d2c6e6af0","isSidechain":false,"userType":"external","cwd":"~/Arcblock/payment-kit-master/blocklets/core","sessionId":"664f44d5-76eb-4da6-b55c-a98e01f05344","version":"2.0.76","gitBranch":"feat-quote","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01RahWWgQvi1kzGeBm3Mq6q9","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"用户提供了一个很大的 diff,要求我生成代码审查文档。这个 diff 涉及的主要内容包括:\n\n1. 新增了自动充值每日限额超出通知的模板\n2. 修改了低余额通知模板,增加了预检查和延迟发送机制\n3. 添加了新的通知类型和事件处理\n4. 添加了欠费相关的 API 路由\n5. 修改了前端组件以展示欠费信息\n6. 改进了 credit transaction 的显示逻辑\n7. 添加了国际化文本\n\n这是一个 Payment Kit 项目的重要功能改进,涉及通知系统、欠费管理、用户界面优化等多个方面。\n\n根据 skill 的指引,我需要:\n1. 分析 diff 内容\n2. 理解业务流程\n3. 提供详细的代码审查\n4. 评估风险\n5. 给出审查建议\n\n让我开始使用 skill 提供的工具和模板来生成审查文档。","signature":"Er8HCkYICxgCKkDtweFTbFCykR1i94DNPqnByZtba+Tl96J+ATT2+9uLCgT3ZNMWZasG3OfqobyZJaRqF+Kts6ovOPGdnPAnclCjEgzDezttDIEMzzx/2RkaDBAvgzIaqC1YsNwl1yIwnKvU1p6McWxwwMcVkcDfBm8q7kaUwStguqqtCFy9i06Qqhc4UvWDvE3NLAvHyHS3KqYGoxgKanAOr1PZWfue3HV1YvcWonouHeWc2hJpn0za6AeE7AXXqjAsghHqXBXyy0lhsijSGUOoxOBVUkBLi1Cc4G3VRLun8FlQg4RN9reJNfVhdqqUbbpazUmybS/yxlybvfqX5RhnFI2I0Unx7GTQLki+ClHjp6J1HmeO5ghUvD7PqQdT2O2V7bht6xDKKZNDlbioT5LyUw53rYfwu3+kerVAArrC3XilTrTrdppN4y6/+wziMJewijwUqGTHztNlOVrZYWcGHb1j+c6Mi1yvd6NoK4hxUBXJQdTx8gxMualkDE6MWmkIBzT5PrOnD5nS3fcvtNbd0USjBMuglMidUJrSenvO2G2hty+sedGt7uUoFqexN6V7RacB910i2/X+HpDes/YlOfx1wggcBc3OQOER4NJMAXWX+D9Rn95evd0kRXOPF3csWT0OSCYUI3fmtLBVIKw/Vcb0HwCbCuLyC4pvIzcYDF4/vB0Y7O/oYDi6BHCaYwWiHPancEiS79URJdn57CoD5kzCM6I8MYr2YWRSAOn47Bk0Q733KsgHcUF4i2yWPP7dzfIPM1dbCxVWnUXLpWebhHhfvx+Z6WbikXxkgiYQU9xZ+WKlI9HWpAL6i+sV/LMZBMyIgWjkZgb1Jhn4CIXrNBcg6ujH+Oe2lHUfbmKqRFv6/JQm5/PO0kkW6e8S+MYwintMDx5fSgOtQiKtJXCrG2slSo3FjzO6ayZJ2oaORqtcjJd65oaQlcowP+cRhSRBQUC99Ughr/4VePP+W+trWNExawikiprG/vsBdXPwSfCueOf55Cvgi/ohC+WuelJvxoc6ayp1sUO4eJHq/uREeRX8+TMiaYpB5DwG83BPGxNZxfxC8Srmb8FEoEW+QKkgoT0XnAaZOueajNPr9SpcqEUevBMH75exfB7riD03r+VcAv2BaB7Bo4lB7Uj2PI7Pzut7n6KoGvuL0EZ/UOLzaQfwQXtb+B1lX8eD6793BP4T4ifBpQTljaSEx7GZR6T3hzQqgxLbqUMk4DbPKAsX9C+JWWQYGBYaNK/U0cuUtOZQx+Rz8STPwRsIN868DGgYAQ=="}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":9,"cache_creation_input_tokens":24597,"cache_read_input_tokens":48317,"cache_creation":{"ephemeral_5m_input_tokens":24597,"ephemeral_1h_input_tokens":0},"output_tokens":3,"service_tier":"standard"}},"requestId":"req_011CX3bjJmaqBEgMpsT6Twy7","type":"assistant","uuid":"cb00f3c5-4b14-4d42-af70-c3652290b6b6","timestamp":"2026-01-12T13:56:29.503Z"}
{"parentUuid":"cb00f3c5-4b14-4d42-af70-c3652290b6b6","isSidechain":false,"userType":"external","cwd":"~/Arcblock/payment-kit-master/blocklets/core","sessionId":"664f44d5-76eb-4da6-b55c-a98e01f05344","version":"2.0.76","gitBranch":"feat-quote","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01RahWWgQvi1kzGeBm3Mq6q9","type":"message","role":"assistant","content":[{"type":"text","text":"由于这个diff非常大,让我先读取skill的相关参考资料,然后生成详细的审查文档。"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":9,"cache_creation_input_tokens":24597,"cache_read_input_tokens":48317,"cache_creation":{"ephemeral_5m_input_tokens":24597,"ephemeral_1h_input_tokens":0},"output_tokens":3,"service_tier":"standard"}},"requestId":"req_011CX3bjJmaqBEgMpsT6Twy7","type":"assistant","uuid":"61f0ec5d-dd34-4ceb-a127-bd2bf151e340","timestamp":"2026-01-12T13:56:30.355Z"}
{"parentUuid":"61f0ec5d-dd34-4ceb-a127-bd2bf151e340","isSidechain":false,"userType":"external","cwd":"~/Arcblock/payment-kit-master/blocklets/core","sessionId":"664f44d5-76eb-4da6-b55c-a98e01f05344","version":"2.0.76","gitBranch":"feat-quote","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01RahWWgQvi1kzGeBm3Mq6q9","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01DN6Nk4TQwWzVsGLwTpLarD","name":"Read","input":{"file_path":"~/.claude/skills/diff-review-doc/references/review-checklist.md"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":9,"cache_creation_input_tokens":24597,"cache_read_input_tokens":48317,"cache_creation":{"ephemeral_5m_input_tokens":24597,"ephemeral_1h_input_tokens":0},"output_tokens":3,"service_tier":"standard"}},"requestId":"req_011CX3bjJmaqBEgMpsT6Twy7","type":"assistant","uuid":"96ee5aaa-e644-45ef-b7e8-893067bcf24d","timestamp":"2026-01-12T13:56:31.599Z"}
{"parentUuid":"96ee5aaa-e644-45ef-b7e8-893067bcf24d","isSidechain":false,"userType":"external","cwd":"~/Arcblock/payment-kit-master/blocklets/core","sessionId":"664f44d5-76eb-4da6-b55c-a98e01f05344","version":"2.0.76","gitBranch":"feat-quote","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01RahWWgQvi1kzGeBm3Mq6q9","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01Reni1M25d7j5kG9Xh53T2C","name":"Read","input":{"file_path":"~/.claude/skills/diff-review-doc/references/patterns.md"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":9,"cache_creation_input_tokens":24597,"cache_read_input_tokens":48317,"cache_creation":{"ephemeral_5m_input_tokens":24597,"ephemeral_1h_input_tokens":0},"output_tokens":3,"service_tier":"standard"}},"requestId":"req_011CX3bjJmaqBEgMpsT6Twy7","type":"assistant","uuid":"1c620a66-7632-4255-9ddd-b9264de1c743","timestamp":"2026-01-12T13:56:32.184Z"}
{"parentUuid":"1c620a66-7632-4255-9ddd-b9264de1c743","isSidechain":false,"userType":"external","cwd":"~/Arcblock/payment-kit-master/blocklets/core","sessionId":"664f44d5-76eb-4da6-b55c-a98e01f05344","version":"2.0.76","gitBranch":"feat-quote","slug":"quirky-skipping-brooks","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01RahWWgQvi1kzGeBm3Mq6q9","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01D93hrkoN9hgfnxhBcXeRAA","name":"Read","input":{"file_path":"~/.claude/skills/diff-review-doc/assets/review-template.md"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":9,"cache_creation_input_tokens":24597,"cache_read_input_tokens":48317,"cache_creation":{"ephemeral_5m_input_tokens":24597,"ephemeral_1h_input_tokens":0},"output_tokens":557,"service_tier":"standard"}},"requestId":"req_011CX3bjJmaqBEgMpsT6Twy7","type":"assistant","uuid":"49599fb0-a644-4411-b469-3d277f38753c","timestamp":"2026-01-12T13:56:32.550Z"}
{"parentUuid":"49599fb0-a644-4411-b469-3d277f38753c","isSidechain":false,"userType":"external","cwd":"~/Arcblock/payment-kit-master/blocklets/core","sessionId":"664f44d5-76eb-4da6-b55c-a98e01f05344","version":"2.0.76","gitBranch":"feat-quote","slug":"quirky-skipping-brooks","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01DN6Nk4TQwWzVsGLwTpLarD","type":"tool_result","content":"     1→# Code Review Checklist\n     2→\n     3→## 代码质量 (Code Quality)\n     4→\n     5→### 可读性\n     6→- [ ] 变量、函数、类的命名是否清晰有意义？\n     7→- [ ] 代码逻辑是否容易理解？\n     8→- [ ] 是否有必要的注释（复杂逻辑、业务规则）？\n     9→- [ ] 代码格式是否符合项目规范？\n    10→\n    11→### 复杂度\n    12→- [ ] 函数是否过长（>50行）或过于复杂？\n    13→- [ ] 是否有深层嵌套（>3层）？\n    14→- [ ] 是否有重复代码可以抽取？\n    15→- [ ] 循环和条件逻辑是否可以简化？\n    16→\n    17→### 最佳实践\n    18→- [ ] 是否遵循 DRY (Don't Repeat Yourself) 原则？\n    19→- [ ] 是否遵循 SOLID 原则？\n    20→- [ ] 错误处理是否恰当？\n    21→- [ ] 日志记录是否充分？\n    22→\n    23→## 架构设计 (Architecture & Design)\n    24→\n    25→### 模块化\n    26→- [ ] 职责划分是否清晰？\n    27→- [ ] 模块耦合度是否合理？\n    28→- [ ] 接口设计是否合理？\n    29→- [ ] 是否有循环依赖？\n    30→\n    31→### 可扩展性\n    32→- [ ] 设计是否容易扩展新功能？\n    33→- [ ] 是否使用了合适的设计模式？\n    34→- [ ] 配置是否外部化？\n    35→- [ ] 是否有硬编码的值需要配置化？\n    36→\n    37→### 数据流\n    38→- [ ] 数据流向是否清晰？\n    39→- [ ] 状态管理是否合理？\n    40→- [ ] 是否有不必要的数据传递？\n    41→- [ ] 数据转换逻辑是否正确？\n    42→\n    43→## 功能验证 (Functionality)\n    44→\n    45→### 业务逻辑\n    46→- [ ] 功能是否符合需求？\n    47→- [ ] 边界条件是否处理正确？\n    48→- [ ] 业务规则是否完整实现？\n    49→- [ ] 是否有遗漏的场景？\n    50→\n    51→### 错误处理\n    52→- [ ] 异常情况是否都被捕获？\n    53→- [ ] 错误信息是否清晰有用？\n    54→- [ ] 是否有合适的降级策略？\n    55→- [ ] 失败回滚是否正确？\n    56→\n    57→### 数据一致性\n    58→- [ ] 并发场景下数据是否一致？\n    59→- [ ] 事务边界是否正确？\n    60→- [ ] 是否有数据竞争问题？\n    61→- [ ] 缓存更新是否正确？\n    62→\n    63→## 安全性 (Security)\n    64→\n    65→### 输入验证\n    66→- [ ] 是否验证所有用户输入？\n    67→- [ ] 是否防范 SQL 注入？\n    68→- [ ] 是否防范 XSS 攻击？\n    69→- [ ] 是否防范 CSRF 攻击？\n    70→\n    71→### 权限控制\n    72→- [ ] 是否进行了权限校验？\n    73→- [ ] 是否有越权访问风险？\n    74→- [ ] 敏感操作是否有二次验证？\n    75→- [ ] API 访问是否有限流？\n    76→\n    77→### 数据安全\n    78→- [ ] 敏感数据是否加密存储？\n    79→- [ ] 密码/密钥是否明文暴露？\n    80→- [ ] 是否有敏感信息泄露（日志、错误信息）？\n    81→- [ ] 数据传输是否加密？\n    82→\n    83→## 性能 (Performance)\n    84→\n    85→### 数据库\n    86→- [ ] SQL 查询是否有 N+1 问题？\n    87→- [ ] 是否使用了合适的索引？\n    88→- [ ] 是否有慢查询？\n    89→- [ ] 批量操作是否优化？\n    90→\n    91→### 资源使用\n    92→- [ ] 是否有内存泄漏？\n    93→- [ ] 大文件/数据是否分块处理？\n    94→- [ ] 是否有资源未释放（连接、文件句柄）？\n    95→- [ ] 循环中是否有不必要的操作？\n    96→\n    97→### 缓存策略\n    98→- [ ] 是否应该使用缓存？\n    99→- [ ] 缓存失效策略是否合理？\n   100→- [ ] 是否有缓存穿透/雪崩风险？\n   101→- [ ] 缓存一致性如何保证？\n   102→\n   103→## 测试 (Testing)\n   104→\n   105→### 测试覆盖\n   106→- [ ] 是否有单元测试？\n   107→- [ ] 关键路径是否有测试覆盖？\n   108→- [ ] 边界条件是否有测试？\n   109→- [ ] 异常情况是否有测试？\n   110→\n   111→### 测试质量\n   112→- [ ] 测试用例是否有意义？\n   113→- [ ] 测试是否独立且可重复？\n   114→- [ ] Mock/Stub 是否合理？\n   115→- [ ] 测试数据是否覆盖典型场景？\n   116→\n   117→## 兼容性 (Compatibility)\n   118→\n   119→### 向后兼容\n   120→- [ ] API 变更是否向后兼容？\n   121→- [ ] 数据库 schema 变更是否兼容？\n   122→- [ ] 是否有迁移脚本？\n   123→- [ ] 老版本客户端是否受影响？\n   124→\n   125→### 依赖管理\n   126→- [ ] 新依赖是否必要？\n   127→- [ ] 依赖版本是否稳定？\n   128→- [ ] 是否有依赖冲突？\n   129→- [ ] License 是否兼容？\n   130→\n   131→## 运维 (Operations)\n   132→\n   133→### 可观测性\n   134→- [ ] 关键操作是否有日志？\n   135→- [ ] 是否有性能监控埋点？\n   136→- [ ] 错误是否有告警？\n   137→- [ ] 是否支持链路追踪？\n   138→\n   139→### 部署\n   140→- [ ] 是否需要配置变更？\n   141→- [ ] 是否需要数据迁移？\n   142→- [ ] 回滚方案是否可行？\n   143→- [ ] 部署顺序是否有要求？\n   144→\n   145→## 文档 (Documentation)\n   146→\n   147→### 代码文档\n   148→- [ ] 复杂逻辑是否有注释？\n   149→- [ ] 公共 API 是否有文档？\n   150→- [ ] 特殊处理是否说明原因？\n   151→- [ ] TODOs/FIXMEs 是否合理？\n   152→\n   153→### 外部文档\n   154→- [ ] 是否需要更新 API 文档？\n   155→- [ ] 是否需要更新用户手册？\n   156→- [ ] 是否需要更新运维文档？\n   157→- [ ] 变更记录是否完整？\n   158→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"fd5ac6fe-26fc-4999-8358-2ac43799e55c","timestamp":"2026-01-12T13:57:37.891Z","toolUseResult":{"type":"text","file":{"filePath":"~/.claude/skills/diff-review-doc/references/review-checklist.md","content":"# Code Review Checklist\n\n## 代码质量 (Code Quality)\n\n### 可读性\n- [ ] 变量、函数、类的命名是否清晰有意义？\n- [ ] 代码逻辑是否容易理解？\n- [ ] 是否有必要的注释（复杂逻辑、业务规则）？\n- [ ] 代码格式是否符合项目规范？\n\n### 复杂度\n- [ ] 函数是否过长（>50行）或过于复杂？\n- [ ] 是否有深层嵌套（>3层）？\n- [ ] 是否有重复代码可以抽取？\n- [ ] 循环和条件逻辑是否可以简化？\n\n### 最佳实践\n- [ ] 是否遵循 DRY (Don't Repeat Yourself) 原则？\n- [ ] 是否遵循 SOLID 原则？\n- [ ] 错误处理是否恰当？\n- [ ] 日志记录是否充分？\n\n## 架构设计 (Architecture & Design)\n\n### 模块化\n- [ ] 职责划分是否清晰？\n- [ ] 模块耦合度是否合理？\n- [ ] 接口设计是否合理？\n- [ ] 是否有循环依赖？\n\n### 可扩展性\n- [ ] 设计是否容易扩展新功能？\n- [ ] 是否使用了合适的设计模式？\n- [ ] 配置是否外部化？\n- [ ] 是否有硬编码的值需要配置化？\n\n### 数据流\n- [ ] 数据流向是否清晰？\n- [ ] 状态管理是否合理？\n- [ ] 是否有不必要的数据传递？\n- [ ] 数据转换逻辑是否正确？\n\n## 功能验证 (Functionality)\n\n### 业务逻辑\n- [ ] 功能是否符合需求？\n- [ ] 边界条件是否处理正确？\n- [ ] 业务规则是否完整实现？\n- [ ] 是否有遗漏的场景？\n\n### 错误处理\n- [ ] 异常情况是否都被捕获？\n- [ ] 错误信息是否清晰有用？\n- [ ] 是否有合适的降级策略？\n- [ ] 失败回滚是否正确？\n\n### 数据一致性\n- [ ] 并发场景下数据是否一致？\n- [ ] 事务边界是否正确？\n- [ ] 是否有数据竞争问题？\n- [ ] 缓存更新是否正确？\n\n## 安全性 (Security)\n\n### 输入验证\n- [ ] 是否验证所有用户输入？\n- [ ] 是否防范 SQL 注入？\n- [ ] 是否防范 XSS 攻击？\n- [ ] 是否防范 CSRF 攻击？\n\n### 权限控制\n- [ ] 是否进行了权限校验？\n- [ ] 是否有越权访问风险？\n- [ ] 敏感操作是否有二次验证？\n- [ ] API 访问是否有限流？\n\n### 数据安全\n- [ ] 敏感数据是否加密存储？\n- [ ] 密码/密钥是否明文暴露？\n- [ ] 是否有敏感信息泄露（日志、错误信息）？\n- [ ] 数据传输是否加密？\n\n## 性能 (Performance)\n\n### 数据库\n- [ ] SQL 查询是否有 N+1 问题？\n- [ ] 是否使用了合适的索引？\n- [ ] 是否有慢查询？\n- [ ] 批量操作是否优化？\n\n### 资源使用\n- [ ] 是否有内存泄漏？\n- [ ] 大文件/数据是否分块处理？\n- [ ] 是否有资源未释放（连接、文件句柄）？\n- [ ] 循环中是否有不必要的操作？\n\n### 缓存策略\n- [ ] 是否应该使用缓存？\n- [ ] 缓存失效策略是否合理？\n- [ ] 是否有缓存穿透/雪崩风险？\n- [ ] 缓存一致性如何保证？\n\n## 测试 (Testing)\n\n### 测试覆盖\n- [ ] 是否有单元测试？\n- [ ] 关键路径是否有测试覆盖？\n- [ ] 边界条件是否有测试？\n- [ ] 异常情况是否有测试？\n\n### 测试质量\n- [ ] 测试用例是否有意义？\n- [ ] 测试是否独立且可重复？\n- [ ] Mock/Stub 是否合理？\n- [ ] 测试数据是否覆盖典型场景？\n\n## 兼容性 (Compatibility)\n\n### 向后兼容\n- [ ] API 变更是否向后兼容？\n- [ ] 数据库 schema 变更是否兼容？\n- [ ] 是否有迁移脚本？\n- [ ] 老版本客户端是否受影响？\n\n### 依赖管理\n- [ ] 新依赖是否必要？\n- [ ] 依赖版本是否稳定？\n- [ ] 是否有依赖冲突？\n- [ ] License 是否兼容？\n\n## 运维 (Operations)\n\n### 可观测性\n- [ ] 关键操作是否有日志？\n- [ ] 是否有性能监控埋点？\n- [ ] 错误是否有告警？\n- [ ] 是否支持链路追踪？\n\n### 部署\n- [ ] 是否需要配置变更？\n- [ ] 是否需要数据迁移？\n- [ ] 回滚方案是否可行？\n- [ ] 部署顺序是否有要求？\n\n## 文档 (Documentation)\n\n### 代码文档\n- [ ] 复杂逻辑是否有注释？\n- [ ] 公共 API 是否有文档？\n- [ ] 特殊处理是否说明原因？\n- [ ] TODOs/FIXMEs 是否合理？\n\n### 外部文档\n- [ ] 是否需要更新 API 文档？\n- [ ] 是否需要更新用户手册？\n- [ ] 是否需要更新运维文档？\n- [ ] 变更记录是否完整？\n","numLines":158,"startLine":1,"totalLines":158}}}
{"parentUuid":"a9814ee3-a8ec-48b8-8015-f30379bdd1f2","isSidechain":false,"userType":"external","cwd":"~/Arcblock/payment-kit-master/blocklets/core","sessionId":"664f44d5-76eb-4da6-b55c-a98e01f05344","version":"2.0.76","gitBranch":"feat-quote","slug":"quirky-skipping-brooks","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01D93hrkoN9hgfnxhBcXeRAA","type":"tool_result","content":"     1→# Code Review Document\n     2→\n     3→## 📋 改动概览 (Change Summary)\n     4→\n     5→**变更类型：** [Feature/Bugfix/Refactor/Performance/Security]\n     6→\n     7→**影响范围：**\n     8→- 修改文件数：X 个\n     9→- 新增文件数：X 个\n    10→- 删除文件数：X 个\n    11→- 代码行变更：+XXX -XXX\n    12→\n    13→**关键文件：**\n    14→- `path/to/file1.js` - 简要说明\n    15→- `path/to/file2.py` - 简要说明\n    16→\n    17→**依赖变更：**\n    18→- [ ] 新增依赖\n    19→- [ ] 更新依赖\n    20→- [ ] 配置变更\n    21→\n    22→---\n    23→\n    24→## 🔄 业务流程分析 (Business Flow Analysis)\n    25→\n    26→### 功能描述\n    27→[简要描述本次改动要实现的功能或解决的问题]\n    28→\n    29→### 业务流程\n    30→```\n    31→用户操作 → 前端处理 → API调用 → 后端逻辑 → 数据库操作 → 返回响应\n    32→```\n    33→\n    34→**详细流程：**\n    35→1. **步骤1：** [描述]\n    36→   - 涉及组件/模块：\n    37→   - 数据流：\n    38→\n    39→2. **步骤2：** [描述]\n    40→   - 涉及组件/模块：\n    41→   - 数据流：\n    42→\n    43→3. **步骤3：** [描述]\n    44→   - 涉及组件/模块：\n    45→   - 数据流：\n    46→\n    47→### 数据流图\n    48→```\n    49→[输入数据] → [处理过程] → [输出数据]\n    50→```\n    51→\n    52→---\n    53→\n    54→## 🔍 关键代码详解 (Key Code Analysis)\n    55→\n    56→### 1. `文件路径1`\n    57→\n    58→**改动类型：** [新增/修改/删除]\n    59→**改动行数：** +XXX -XXX\n    60→\n    61→#### 改动内容\n    62→```diff\n    63→- 删除的代码\n    64→+ 新增的代码\n    65→```\n    66→\n    67→#### 代码说明\n    68→[解释这段代码的作用、实现逻辑、为什么这样改]\n    69→\n    70→#### 关注点\n    71→- [ ] **逻辑正确性：** [说明]\n    72→- [ ] **边界处理：** [说明]\n    73→- [ ] **错误处理：** [说明]\n    74→- [ ] **性能影响：** [说明]\n    75→\n    76→---\n    77→\n    78→### 2. `文件路径2`\n    79→\n    80→**改动类型：** [新增/修改/删除]\n    81→**改动行数：** +XXX -XXX\n    82→\n    83→#### 改动内容\n    84→```diff\n    85→- 删除的代码\n    86→+ 新增的代码\n    87→```\n    88→\n    89→#### 代码说明\n    90→[解释这段代码的作用、实现逻辑、为什么这样改]\n    91→\n    92→#### 关注点\n    93→- [ ] **逻辑正确性：** [说明]\n    94→- [ ] **边界处理：** [说明]\n    95→- [ ] **错误处理：** [说明]\n    96→- [ ] **性能影响：** [说明]\n    97→\n    98→---\n    99→\n   100→### 3. `文件路径3`\n   101→\n   102→[继续添加其他关键文件的分析...]\n   103→\n   104→---\n   105→\n   106→## ⚠️ 风险评估 (Risk Assessment)\n   107→\n   108→### 高风险项 (High Risk)\n   109→- [ ] **[风险描述]**\n   110→  - **影响范围：** [说明]\n   111→  - **潜在问题：** [说明]\n   112→  - **建议措施：** [说明]\n   113→\n   114→### 中风险项 (Medium Risk)\n   115→- [ ] **[风险描述]**\n   116→  - **影响范围：** [说明]\n   117→  - **潜在问题：** [说明]\n   118→  - **建议措施：** [说明]\n   119→\n   120→### 低风险项 (Low Risk)\n   121→- [ ] **[风险描述]**\n   122→  - **说明：** [说明]\n   123→\n   124→---\n   125→\n   126→## 🎯 重点关注 (Focus Areas)\n   127→\n   128→### 大文件改动\n   129→> **标准：** 单文件 >200 行或核心业务逻辑文件\n   130→\n   131→#### `文件名` (±XXX 行)\n   132→- **改动原因：** [说明]\n   133→- **主要变更：** [说明]\n   134→- **测试情况：** [说明]\n   135→- **建议：** [说明]\n   136→\n   137→### 后端关键改动\n   138→> **特别关注：** API变更、数据库操作、权限逻辑、第三方集成\n   139→\n   140→#### API 变更\n   141→- [ ] 接口路径变更\n   142→- [ ] 请求参数变更\n   143→- [ ] 响应格式变更\n   144→- [ ] 错误码变更\n   145→\n   146→#### 数据库操作\n   147→- [ ] Schema 变更\n   148→- [ ] 查询优化\n   149→- [ ] 索引变更\n   150→- [ ] 迁移脚本\n   151→\n   152→#### 权限逻辑\n   153→- [ ] 权限校验变更\n   154→- [ ] 角色定义变更\n   155→- [ ] 访问控制变更\n   156→\n   157→---\n   158→\n   159→## ✅ Review 建议 (Review Recommendations)\n   160→\n   161→### 代码质量 (Code Quality)\n   162→**评分：** ⭐⭐⭐⭐☆ (X/5)\n   163→\n   164→**优点：**\n   165→- ✅ [列出好的实践]\n   166→- ✅ [列出好的实践]\n   167→\n   168→**需要改进：**\n   169→- ⚠️ [列出需要改进的地方]\n   170→- ⚠️ [列出需要改进的地方]\n   171→\n   172→**建议：**\n   173→- 💡 [具体的改进建议]\n   174→- 💡 [具体的改进建议]\n   175→\n   176→---\n   177→\n   178→### 架构设计 (Architecture)\n   179→**评分：** ⭐⭐⭐⭐☆ (X/5)\n   180→\n   181→**优点：**\n   182→- ✅ [列出好的设计]\n   183→- ✅ [列出好的设计]\n   184→\n   185→**需要改进：**\n   186→- ⚠️ [列出设计问题]\n   187→- ⚠️ [列出设计问题]\n   188→\n   189→**建议：**\n   190→- 💡 [具体的改进建议]\n   191→- 💡 [具体的改进建议]\n   192→\n   193→---\n   194→\n   195→### 功能验证 (Functionality)\n   196→**评分：** ⭐⭐⭐⭐☆ (X/5)\n   197→\n   198→**已验证：**\n   199→- ✅ [功能点1]\n   200→- ✅ [功能点2]\n   201→\n   202→**需要验证：**\n   203→- ❓ [需要测试的场景1]\n   204→- ❓ [需要测试的场景2]\n   205→\n   206→**建议：**\n   207→- 💡 [测试建议]\n   208→- 💡 [测试建议]\n   209→\n   210→---\n   211→\n   212→### 安全性 (Security)\n   213→**评分：** ⭐⭐⭐⭐☆ (X/5)\n   214→\n   215→**安全措施：**\n   216→- ✅ [已实现的安全措施]\n   217→- ✅ [已实现的安全措施]\n   218→\n   219→**潜在风险：**\n   220→- 🔒 [安全风险1]\n   221→- 🔒 [安全风险2]\n   222→\n   223→**建议：**\n   224→- 💡 [安全加固建议]\n   225→- 💡 [安全加固建议]\n   226→\n   227→---\n   228→\n   229→### 性能 (Performance)\n   230→**评分：** ⭐⭐⭐⭐☆ (X/5)\n   231→\n   232→**性能优化：**\n   233→- ✅ [已实现的优化]\n   234→- ✅ [已实现的优化]\n   235→\n   236→**潜在问题：**\n   237→- ⚡ [性能问题1]\n   238→- ⚡ [性能问题2]\n   239→\n   240→**建议：**\n   241→- 💡 [性能优化建议]\n   242→- 💡 [性能优化建议]\n   243→\n   244→---\n   245→\n   246→## 📝 总体评价 (Overall Assessment)\n   247→\n   248→### 综合评分\n   249→**总分：** ⭐⭐⭐⭐☆ (X/5)\n   250→\n   251→### 核心优点\n   252→1. [总结主要优点]\n   253→2. [总结主要优点]\n   254→3. [总结主要优点]\n   255→\n   256→### 主要问题\n   257→1. [总结主要问题]\n   258→2. [总结主要问题]\n   259→3. [总结主要问题]\n   260→\n   261→### 最终建议\n   262→- **Must Fix (必须修复)：**\n   263→  - [ ] [关键问题1]\n   264→  - [ ] [关键问题2]\n   265→\n   266→- **Should Fix (建议修复)：**\n   267→  - [ ] [重要问题1]\n   268→  - [ ] [重要问题2]\n   269→\n   270→- **Nice to Have (可选改进)：**\n   271→  - [ ] [优化建议1]\n   272→  - [ ] [优化建议2]\n   273→\n   274→### 是否建议合并\n   275→- [ ] ✅ **批准合并** - 代码质量良好，可以合并\n   276→- [ ] ⚠️ **条件批准** - 修复关键问题后可以合并\n   277→- [ ] ❌ **需要修改** - 存在重大问题，需要重新审查\n   278→\n   279→---\n   280→\n   281→## 📚 附加信息 (Additional Information)\n   282→\n   283→### 测试覆盖\n   284→- 单元测试：[说明]\n   285→- 集成测试：[说明]\n   286→- E2E 测试：[说明]\n   287→\n   288→### 文档更新\n   289→- [ ] API 文档\n   290→- [ ] 用户手册\n   291→- [ ] 开发文档\n   292→- [ ] 变更日志\n   293→\n   294→### 部署注意事项\n   295→- [ ] 配置变更\n   296→- [ ] 数据迁移\n   297→- [ ] 服务重启\n   298→- [ ] 回滚方案\n   299→\n   300→---\n   301→\n   302→**生成时间：** YYYY-MM-DD HH:mm:ss\n   303→**审查人：** Claude Code Review Assistant\n   304→**版本：** 1.0\n   305→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"521ef511-2695-4cf7-8e58-fce3d52d82a8","timestamp":"2026-01-12T13:57:41.105Z","toolUseResult":{"type":"text","file":{"filePath":"~/.claude/skills/diff-review-doc/assets/review-template.md","content":"# Code Review Document\n\n## 📋 改动概览 (Change Summary)\n\n**变更类型：** [Feature/Bugfix/Refactor/Performance/Security]\n\n**影响范围：**\n- 修改文件数：X 个\n- 新增文件数：X 个\n- 删除文件数：X 个\n- 代码行变更：+XXX -XXX\n\n**关键文件：**\n- `path/to/file1.js` - 简要说明\n- `path/to/file2.py` - 简要说明\n\n**依赖变更：**\n- [ ] 新增依赖\n- [ ] 更新依赖\n- [ ] 配置变更\n\n---\n\n## 🔄 业务流程分析 (Business Flow Analysis)\n\n### 功能描述\n[简要描述本次改动要实现的功能或解决的问题]\n\n### 业务流程\n```\n用户操作 → 前端处理 → API调用 → 后端逻辑 → 数据库操作 → 返回响应\n```\n\n**详细流程：**\n1. **步骤1：** [描述]\n   - 涉及组件/模块：\n   - 数据流：\n\n2. **步骤2：** [描述]\n   - 涉及组件/模块：\n   - 数据流：\n\n3. **步骤3：** [描述]\n   - 涉及组件/模块：\n   - 数据流：\n\n### 数据流图\n```\n[输入数据] → [处理过程] → [输出数据]\n```\n\n---\n\n## 🔍 关键代码详解 (Key Code Analysis)\n\n### 1. `文件路径1`\n\n**改动类型：** [新增/修改/删除]\n**改动行数：** +XXX -XXX\n\n#### 改动内容\n```diff\n- 删除的代码\n+ 新增的代码\n```\n\n#### 代码说明\n[解释这段代码的作用、实现逻辑、为什么这样改]\n\n#### 关注点\n- [ ] **逻辑正确性：** [说明]\n- [ ] **边界处理：** [说明]\n- [ ] **错误处理：** [说明]\n- [ ] **性能影响：** [说明]\n\n---\n\n### 2. `文件路径2`\n\n**改动类型：** [新增/修改/删除]\n**改动行数：** +XXX -XXX\n\n#### 改动内容\n```diff\n- 删除的代码\n+ 新增的代码\n```\n\n#### 代码说明\n[解释这段代码的作用、实现逻辑、为什么这样改]\n\n#### 关注点\n- [ ] **逻辑正确性：** [说明]\n- [ ] **边界处理：** [说明]\n- [ ] **错误处理：** [说明]\n- [ ] **性能影响：** [说明]\n\n---\n\n### 3. `文件路径3`\n\n[继续添加其他关键文件的分析...]\n\n---\n\n## ⚠️ 风险评估 (Risk Assessment)\n\n### 高风险项 (High Risk)\n- [ ] **[风险描述]**\n  - **影响范围：** [说明]\n  - **潜在问题：** [说明]\n  - **建议措施：** [说明]\n\n### 中风险项 (Medium Risk)\n- [ ] **[风险描述]**\n  - **影响范围：** [说明]\n  - **潜在问题：** [说明]\n  - **建议措施：** [说明]\n\n### 低风险项 (Low Risk)\n- [ ] **[风险描述]**\n  - **说明：** [说明]\n\n---\n\n## 🎯 重点关注 (Focus Areas)\n\n### 大文件改动\n> **标准：** 单文件 >200 行或核心业务逻辑文件\n\n#### `文件名` (±XXX 行)\n- **改动原因：** [说明]\n- **主要变更：** [说明]\n- **测试情况：** [说明]\n- **建议：** [说明]\n\n### 后端关键改动\n> **特别关注：** API变更、数据库操作、权限逻辑、第三方集成\n\n#### API 变更\n- [ ] 接口路径变更\n- [ ] 请求参数变更\n- [ ] 响应格式变更\n- [ ] 错误码变更\n\n#### 数据库操作\n- [ ] Schema 变更\n- [ ] 查询优化\n- [ ] 索引变更\n- [ ] 迁移脚本\n\n#### 权限逻辑\n- [ ] 权限校验变更\n- [ ] 角色定义变更\n- [ ] 访问控制变更\n\n---\n\n## ✅ Review 建议 (Review Recommendations)\n\n### 代码质量 (Code Quality)\n**评分：** ⭐⭐⭐⭐☆ (X/5)\n\n**优点：**\n- ✅ [列出好的实践]\n- ✅ [列出好的实践]\n\n**需要改进：**\n- ⚠️ [列出需要改进的地方]\n- ⚠️ [列出需要改进的地方]\n\n**建议：**\n- 💡 [具体的改进建议]\n- 💡 [具体的改进建议]\n\n---\n\n### 架构设计 (Architecture)\n**评分：** ⭐⭐⭐⭐☆ (X/5)\n\n**优点：**\n- ✅ [列出好的设计]\n- ✅ [列出好的设计]\n\n**需要改进：**\n- ⚠️ [列出设计问题]\n- ⚠️ [列出设计问题]\n\n**建议：**\n- 💡 [具体的改进建议]\n- 💡 [具体的改进建议]\n\n---\n\n### 功能验证 (Functionality)\n**评分：** ⭐⭐⭐⭐☆ (X/5)\n\n**已验证：**\n- ✅ [功能点1]\n- ✅ [功能点2]\n\n**需要验证：**\n- ❓ [需要测试的场景1]\n- ❓ [需要测试的场景2]\n\n**建议：**\n- 💡 [测试建议]\n- 💡 [测试建议]\n\n---\n\n### 安全性 (Security)\n**评分：** ⭐⭐⭐⭐☆ (X/5)\n\n**安全措施：**\n- ✅ [已实现的安全措施]\n- ✅ [已实现的安全措施]\n\n**潜在风险：**\n- 🔒 [安全风险1]\n- 🔒 [安全风险2]\n\n**建议：**\n- 💡 [安全加固建议]\n- 💡 [安全加固建议]\n\n---\n\n### 性能 (Performance)\n**评分：** ⭐⭐⭐⭐☆ (X/5)\n\n**性能优化：**\n- ✅ [已实现的优化]\n- ✅ [已实现的优化]\n\n**潜在问题：**\n- ⚡ [性能问题1]\n- ⚡ [性能问题2]\n\n**建议：**\n- 💡 [性能优化建议]\n- 💡 [性能优化建议]\n\n---\n\n## 📝 总体评价 (Overall Assessment)\n\n### 综合评分\n**总分：** ⭐⭐⭐⭐☆ (X/5)\n\n### 核心优点\n1. [总结主要优点]\n2. [总结主要优点]\n3. [总结主要优点]\n\n### 主要问题\n1. [总结主要问题]\n2. [总结主要问题]\n3. [总结主要问题]\n\n### 最终建议\n- **Must Fix (必须修复)：**\n  - [ ] [关键问题1]\n  - [ ] [关键问题2]\n\n- **Should Fix (建议修复)：**\n  - [ ] [重要问题1]\n  - [ ] [重要问题2]\n\n- **Nice to Have (可选改进)：**\n  - [ ] [优化建议1]\n  - [ ] [优化建议2]\n\n### 是否建议合并\n- [ ] ✅ **批准合并** - 代码质量良好，可以合并\n- [ ] ⚠️ **条件批准** - 修复关键问题后可以合并\n- [ ] ❌ **需要修改** - 存在重大问题，需要重新审查\n\n---\n\n## 📚 附加信息 (Additional Information)\n\n### 测试覆盖\n- 单元测试：[说明]\n- 集成测试：[说明]\n- E2E 测试：[说明]\n\n### 文档更新\n- [ ] API 文档\n- [ ] 用户手册\n- [ ] 开发文档\n- [ ] 变更日志\n\n### 部署注意事项\n- [ ] 配置变更\n- [ ] 数据迁移\n- [ ] 服务重启\n- [ ] 回滚方案\n\n---\n\n**生成时间：** YYYY-MM-DD HH:mm:ss\n**审查人：** Claude Code Review Assistant\n**版本：** 1.0\n","numLines":305,"startLine":1,"totalLines":305}}}
{"parentUuid":"521ef511-2695-4cf7-8e58-fce3d52d82a8","isSidechain":false,"userType":"external","cwd":"~/Arcblock/payment-kit-master/blocklets/core","sessionId":"664f44d5-76eb-4da6-b55c-a98e01f05344","version":"2.0.76","gitBranch":"feat-quote","slug":"quirky-skipping-brooks","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01X3dh17DQ39ESirSXSZBW7V","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"好的,我已经读取了相关的参考资料。现在让我基于这个大型 diff 生成一份全面的代码审查文档。这个 diff 包含了多个重要功能:\n\n1. 新增自动充值每日限额超出通知模板\n2. 改进低余额通知机制(增加预检查和延迟发送)\n3. 添加通知去重和延迟发送功能\n4. 新增欠费(overdue)管理功能和 UI\n5. 改进信用交易记录的显示\n6. 增强 credit transaction API,添加发票信息\n7. 前端优化:过滤零余额的信用货币显示\n8. 添加大量国际化文本\n\n让我按照模板来组织这份审查文档。","signature":"EvMFCkYICxgCKkAslR0B8je+RkvifEh1uicgWHUL9NHJ9llOswVDG2HWFu04q0JWXjo7gxiNr9UsZ/4je+jcuveskPM/AC8dE87kEgzh6/UDkHQ+uRPTr5YaDNBUsUPhwsCzK2/YnyIwUQNRLlxgMtRiMSzevm03Gm0T5Zs3ilz+DtXWUcg7dMyGy2ezSjcb6v5PI7y1miBsKtoEUCqOP76BDLGSDnvOTL/uvLPwvsAvUngXm4WlV+8pA5P3uiuR4sHXNOrZRIPQX9TGs2bFgH1QlDLvQbbX4VsnRKR7f6knQBTFn4db1UB1QmxPsXW7H6a72QcSPxTysI5VN3o3/dteIrGigP16lyIRdI9gSoFMtorehmCyNg+fMwIaj8uxtDOH21E+1LlT2n+c+KcKGKlxkTdWSkE+hojL9PNwIZpZXzh/9jvNU0dY2uUUvTpJaY+ATJ6nKYM0yIyOhhCD+4LClWBWMpHOV9QZT1YkkuxB1tp6P2Un28SWgtNWf3dYWuoB/ABJvqSRNiSI89o2657KOhLbr4j34BvrdD5GZWN5YOiBReysySzy7Eei/nvgW9fsjx+zXQsEEz/e30LH23t61vleV+Nz2rMZx1pXVC0Oqie3whtKUCUI4qWZxlw2QBF5R2XgihR9FiRylglYAz7h6dng1q2iYPP7IvriFTeuy5vv4//N8HwbU7E4JhQwUqKn8qfxc8mrk8MdtKpu0xa69biqADgzaX/AxYRImRrV6xugXm5EY3HSG1PxPXsthoyFQeQWeUeyxVpmY2dwqDFaLKPsz1KuNTIArrxXhVO2J/HW9C/aHqAybfuFA/f4QLyUcZPPoMQcztbWftsEuMsJHw6bplFEcCQd0kTMvtKOCKk0AGVwLm1gdkY3ebG/Q7Oc1rcKuGHuUK7yU5OF8KEzsRTuEu38ALBpv/e0/oPH/dbYoliKqdznCFJE3oxLoh7LhZUWGz3mYDgonV4RRkT+HrIws/Td42qfAcONZrjAnIIL7D8YAQ=="}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":13,"cache_creation_input_tokens":12765,"cache_read_input_tokens":72914,"cache_creation":{"ephemeral_5m_input_tokens":12765,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CX3bqGovaQnczCaQXc4Qx","type":"assistant","uuid":"c2aba70c-0fbf-45bd-9c6e-32459e5b96bb","timestamp":"2026-01-12T13:57:49.098Z"}
{"parentUuid":"c2aba70c-0fbf-45bd-9c6e-32459e5b96bb","isSidechain":false,"userType":"external","cwd":"~/Arcblock/payment-kit-master/blocklets/core","sessionId":"664f44d5-76eb-4da6-b55c-a98e01f05344","version":"2.0.76","gitBranch":"feat-quote","slug":"quirky-skipping-brooks","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01X3dh17DQ39ESirSXSZBW7V","type":"message","role":"assistant","content":[{"type":"text","text":"现在我来生成详细的代码审查文档:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":13,"cache_creation_input_tokens":12765,"cache_read_input_tokens":72914,"cache_creation":{"ephemeral_5m_input_tokens":12765,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CX3bqGovaQnczCaQXc4Qx","type":"assistant","uuid":"6f066f0b-ea1b-49ac-b570-5acb2207a7cf","timestamp":"2026-01-12T13:57:49.426Z"}
{"parentUuid":"6f066f0b-ea1b-49ac-b570-5acb2207a7cf","isSidechain":false,"userType":"external","cwd":"~/Arcblock/payment-kit-master/blocklets/core","sessionId":"664f44d5-76eb-4da6-b55c-a98e01f05344","version":"2.0.76","gitBranch":"feat-quote","slug":"quirky-skipping-brooks","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01X3dh17DQ39ESirSXSZBW7V","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01NR3pWRRDZxideib5ud2sMg","name":"Write","input":{"file_path":"~/Arcblock/payment-kit-master/blocklets/core/CODE_REVIEW.md","content":"# Code Review Document\n\n## 📋 改动概览 (Change Summary)\n\n**变更类型：** Feature + Enhancement\n\n**影响范围:**\n- 修改文件数：21 个\n- 新增文件数：3 个\n- 删除文件数：0 个\n- 代码行变更：+1500 -150 (估算)\n\n**关键文件:**\n- `api/src/libs/notification/template/customer-auto-recharge-daily-limit-exceeded.ts` - 新增每日限额通知模板 (+222行)\n- `api/src/libs/notification/template/customer-credit-low-balance.ts` - 增强低余额通知机制 (+37行)\n- `api/src/queues/notification.ts` - 新增延迟发送和预检查机制 (+65行)\n- `api/src/routes/meter-events.ts` - 新增欠费管理 API (+163行)\n- `api/src/routes/credit-transactions.ts` - 增强交易记录查询 (+77行)\n- `packages/react/src/history/credit/transactions-list.tsx` - 重构交易列表显示逻辑 (大幅改动)\n- `src/pages/admin/billing/overdue/index.tsx` - 新增欠费管理页面 (+286行)\n- `src/pages/admin/overview.tsx` - 增加欠费卡片展示 (+110行)\n\n**依赖变更:**\n- [x] 新增通知类型: `customer.auto_recharge.daily_limit_exceeded`\n- [x] 数据库查询增强：涉及 Invoice、CreditGrant 的关联查询\n- [x] 国际化配置更新\n\n---\n\n## 🔄 业务流程分析 (Business Flow Analysis)\n\n### 功能描述\n\n本次改动主要实现了三个核心功能增强：\n\n1. **自动充值每日限额通知** - 当自动充值因达到每日限额而失败时，通知用户\n2. **智能低余额通知** - 增加10分钟延迟和预检查机制，避免用户充值后仍收到通知\n3. **欠费管理系统** - 为管理员提供完整的欠费(credit pending)监控和管理功能\n\n### 业务流程\n\n#### 1. 自动充值每日限额通知流程\n\n```\nCredit消费触发 → 余额低于阈值 → 尝试自动充值 → 检查每日限额\n→ 限额已达 → 创建audit事件 → 触发通知队列 → 发送邮件通知用户\n```\n\n**详细流程:**\n1. **触发条件:**\n   - 用户 credit 消费后余额低于阈值\n   - 自动充值配置已启用\n   - 每日充值已达到 `daily_limits.max_amount`\n\n2. **事件创建:** (`api/src/queues/auto-recharge.ts:130`)\n   ```typescript\n   createEvent('Customer', 'customer.auto_recharge.daily_limit_exceeded', customer, {\n     autoRechargeConfigId: config.id,\n     currencyId,\n     currentBalance: totalAvailable.toString(),\n   });\n   ```\n\n3. **通知处理:**\n   - 24小时去重机制(防止重复通知)\n   - 生成邮件模板,包含当前余额、每日限额、今日已用金额\n   - 提供\"手动充值\"和\"管理额度\"按钮\n\n#### 2. 智能低余额通知流程\n\n```\nCredit消费 → 余额低于10% → 添加延迟通知(10分钟)\n→ 队列等待 → 预检查余额是否仍低于10% → 是:发送通知 / 否:跳过\n```\n\n**详细流程:**\n1. **触发条件:** (`api/src/queues/credit-consume.ts:320`)\n   - 余额低于总额度的10%\n   - `insufficient` 事件未触发(优先级让位给余额不足通知)\n\n2. **延迟机制:** 10分钟 grace period\n   - 给用户时间进行手动充值\n   - 避免通知风暴\n\n3. **预检查逻辑:** (`api/src/libs/notification/template/customer-credit-low-balance.ts:41`)\n   ```typescript\n   static async preflightCheck(options): Promise<boolean> {\n     // 重新获取最新余额数据\n     const availableGrants = await CreditGrant.getAvailableCreditsForCustomer(...);\n     const currentPercentage = remainingAmount.mul(100).div(totalAmount).toNumber();\n     // 如果已充值导致余额>10%,则跳过通知\n     return currentPercentage <= 10;\n   }\n   ```\n\n4. **数据一致性:**\n   - 通知模板从数据库实时获取最新余额(而非使用缓存的 options 数据)\n   - 确保显示给用户的金额准确无误\n\n#### 3. 欠费管理系统流程\n\n```\n用户消费 → Credit不足 → 产生pending事件\n→ 管理员查看欠费总览 → 按币种/客户查询 → 查看详细欠费事件\n```\n\n**详细流程:**\n1. **数据源:** `meter_events.credit_pending` 字段\n   - 记录无法扣除的 credit 金额\n\n2. **API 端点:**\n   - `GET /api/meter-events/overdue-summary` - 按币种汇总欠费\n   - `GET /api/meter-events/overdue-customers` - 按客户列出欠费,支持搜索和分页\n\n3. **前端展示:**\n   - Admin Overview 页面显示欠费卡片\n   - 新增 `/admin/billing/overdue` 页面,提供详细的欠费管理界面\n   - 支持按币种筛选、客户搜索\n\n### 数据流图\n\n```\n┌─────────────────┐\n│ Credit 消费事件  │\n└────────┬────────┘\n         │\n    ┌────▼─────┐\n    │余额检查   │\n    └─┬──┬─────┘\n      │  │\n  不足 │  │ 低但够用\n      │  │\n      ▼  ▼\n   pending  low_balance (10分钟后+预检)\n      │      │\n      ▼      ▼\n   欠费记录  通知用户\n      │\n      ▼\n   管理员查看\n```\n\n---\n\n## 🔍 关键代码详解 (Key Code Analysis)\n\n### 1. `api/src/libs/notification/template/customer-auto-recharge-daily-limit-exceeded.ts`\n\n**改动类型:** 新增文件\n**改动行数:** +222 行\n\n#### 代码说明\n\n这是一个完整的邮件通知模板类,遵循现有的模板模式:\n\n```typescript\nexport class CustomerAutoRechargeDailyLimitExceededEmailTemplate\n  implements BaseEmailTemplate<CustomerAutoRechargeDailyLimitExceededEmailTemplateContext>\n{\n  // 获取上下文数据\n  async getContext(): Promise<Context> {\n    // 查询客户、自动充值配置、币种信息\n    const autoRechargeConfig = await AutoRechargeConfig.findByPk(..., {\n      include: [Price, PaymentMethod, PaymentCurrency]\n    });\n\n    // 格式化显示数据\n    const dailyLimit = formatCurrencyInfo(config.daily_limits?.max_amount);\n    const dailyUsed = formatCurrencyInfo(config.daily_stats?.total_amount);\n\n    return { locale, userDid, currentBalance, dailyLimit, dailyUsed, ... };\n  }\n\n  // 生成邮件模板\n  async getTemplate(): Promise<BaseEmailTemplateType> {\n    return {\n      title: translate('notification.autoRechargeDailyLimitExceeded.title'),\n      body: translate('notification.autoRechargeDailyLimitExceeded.body'),\n      attachments: [...], // 显示账户信息、余额、限额等\n      actions: [...] // 手动充值、管理额度按钮\n    };\n  }\n}\n```\n\n#### 关注点\n\n- [x] **逻辑正确性:** 代码结构清晰,遵循现有模板模式\n- [x] **边界处理:** 正确处理 `rechargeCurrency` 和 `paymentMethod` 可能为 null 的情况\n- [x] **错误处理:** 对不存在的 customer/config/currency 抛出明确的错误\n- ⚠️ **性能影响:** 多次数据库查询(customer, config, currencies),但通知场景下可接受\n\n**建议:**\n- 可以考虑使用单次查询+include 优化数据库查询次数\n- `creditCurrency` 和 `rechargeCurrency` 查询可以合并为一次批量查询\n\n---\n\n### 2. `api/src/libs/notification/template/customer-credit-low-balance.ts`\n\n**改动类型:** 修改增强\n**改动行数:** +37 -3\n\n#### 改动内容\n\n```diff\nexport class CustomerCreditLowBalanceEmailTemplate {\n+  // 新增: 10分钟延迟配置\n+  static readonly delay = 10 * 60; // seconds\n+  static readonly LOW_BALANCE_THRESHOLD_PERCENT = 10;\n+\n+  // 新增: 预检查机制\n+  static async preflightCheck(options): Promise<boolean> {\n+    // 重新查询最新余额\n+    const availableGrants = await CreditGrant.getAvailableCreditsForCustomer(...);\n+    const currentPercentage = remainingAmount.mul(100).div(totalAmount).toNumber();\n+    // 如果余额已恢复,返回 false 跳过发送\n+    return currentPercentage <= 10;\n+  }\n\n  async getContext(): Promise<...> {\n-    const { customerId, currencyId, availableAmount, percentage } = this.options;\n+    const { customerId, currencyId } = this.options; // 移除 stale 数据\n\n+    // 实时获取最新数据而非使用缓存\n+    const availableGrants = await CreditGrant.getAvailableCreditsForCustomer(...);\n+    const remainingAmount = availableGrants.reduce(...);\n+    const currentPercentage = totalAmount.gt(0)\n+      ? remainingAmount.mul(100).div(totalAmount).toNumber()\n+      : 0;\n  }\n}\n```\n\n#### 代码说明\n\n**核心改进:**\n1. **延迟发送:** 10分钟 grace period,给用户充值时间\n2. **预检查:** 发送前重新验证余额,避免已充值用户仍收到通知\n3. **数据新鲜度:** 不再依赖 options 中可能过时的数据,而是实时查询\n\n**设计优势:**\n- 减少误报,提升用户体验\n- 避免\"刚充值就收到余额不足通知\"的尴尬情况\n\n#### 关注点\n\n- [x] **逻辑正确性:** 预检查逻辑正确,10%阈值合理\n- [x] **边界处理:** 正确处理 `totalAmount = 0` 的情况\n- [x] **错误处理:** try-catch 包裹预检查,失败时默认发送(避免漏通知)\n- ⚠️ **性能影响:** 每次通知增加一次数据库查询,但可接受\n\n---\n\n### 3. `api/src/queues/notification.ts`\n\n**改动类型:** 修改增强\n**改动行数:** +65 -1\n\n#### 改动内容\n\n```diff\n// 新增预检查逻辑\nasync function handleNotificationJob(job: NotificationQueueJob): Promise<void> {\n  const template = await getNotificationTemplate(job);\n\n+  // 检查模板类是否有预检查方法\n+  const TemplateClass = template.constructor as any;\n+  if (TemplateClass.preflightCheck) {\n+    const shouldSend = await TemplateClass.preflightCheck(job.options);\n+    if (!shouldSend) {\n+      logger.info('handleNotificationJob.skipped: preflight check returned false');\n+      return; // 跳过发送\n+    }\n+  }\n\n  await new Notification(template, job.type).send();\n}\n\n// 新增延迟发送函数\n+export async function addNotificationJobWithDelay(\n+  type, options, extraIds, preventDuplicate, duplicateWindow\n+) {\n+  // ... 去重逻辑 ...\n+\n+  // 从模板类获取 delay 配置\n+  const template = await getNotificationTemplate({ type, options });\n+  const TemplateClass = template.constructor as any;\n+  const { delay } = TemplateClass;\n+\n+  return notificationQueue.push({\n+    id: idParts.join('.'),\n+    job: { type, options },\n+    ...(delay && delay > 0 ? { delay } : {}) // 添加延迟\n+  });\n+}\n\n// 将 low_balance 切换到延迟发送\nevents.on('customer.credit.low_balance', (customer, { metadata }) => {\n-  addNotificationJob(...)\n+  addNotificationJobWithDelay(...) // 使用新函数\n});\n\n// 新增每日限额事件监听\n+events.on('customer.auto_recharge.daily_limit_exceeded', (...) => {\n+  addNotificationJob(..., true, 24 * 3600); // 24小时去重\n+});\n```\n\n#### 代码说明\n\n**设计亮点:**\n1. **通用预检查机制:** 通过检查静态方法实现可选的预检查\n2. **通用延迟机制:** 通过读取静态 `delay` 属性实现可配置延迟\n3. **去重防护:** 24小时窗口防止重复通知\n\n**架构优势:**\n- 向后兼容:现有模板无需修改\n- 扩展性好:新模板可以选择性启用预检查/延迟\n\n#### 关注点\n\n- [x] **逻辑正确性:** 预检查和延迟逻辑正确\n- [x] **边界处理:** 正确处理无 `preflightCheck` 方法的模板\n- ⚠️ **类型安全:** 使用 `as any` 访问静态方法,缺乏类型约束\n- [x] **性能影响:** `getNotificationTemplate` 被调用两次(去重检查+实际发送),但逻辑合理\n\n**建议:**\n- 可以定义接口来约束模板类的静态方法:\n  ```typescript\n  interface NotificationTemplateClass {\n    preflightCheck?(options: any): Promise<boolean>;\n    delay?: number;\n  }\n  ```\n\n---\n\n### 4. `api/src/routes/meter-events.ts`\n\n**改动类型:** 新增功能\n**改动行数:** +163 行\n\n#### 改动内容\n\n新增两个 API 端点:\n\n**1. `/overdue-summary` - 欠费总览**\n```typescript\nrouter.get('/overdue-summary', auth, async (req, res) => {\n  // SQL聚合查询:按币种汇总 credit_pending\n  const results = await MeterEvent.sequelize!.query(`\n    SELECT\n      m.currency_id,\n      SUM(CAST(me.credit_pending AS DECIMAL(40,0))) as total_pending,\n      COUNT(DISTINCT json_extract(me.payload, '$.customer_id')) as customer_count,\n      COUNT(*) as event_count\n    FROM meter_events me\n    JOIN meters m ON me.event_name = m.event_name\n    WHERE me.livemode = :livemode\n      AND CAST(me.credit_pending AS DECIMAL(40,0)) > 0\n    GROUP BY m.currency_id\n    HAVING total_pending > 0\n    ORDER BY total_pending DESC\n  `);\n\n  // 补充币种详情\n  const currencies = await PaymentCurrency.findAll(...);\n  return res.json({ list: results.map(...) });\n});\n```\n\n**2. `/overdue-customers` - 欠费客户列表**\n```typescript\nrouter.get('/overdue-customers', auth, async (req, res) => {\n  // 支持分页、币种筛选、客户搜索\n  const page = Math.max(1, parseInt(req.query.page || '1'));\n  const currencyId = req.query.currency_id;\n  const searchQuery = req.query.q;\n\n  // 如果有搜索,先查询匹配的客户ID\n  if (searchQuery) {\n    const searchCustomers = await Customer.findAll({\n      where: {\n        [Op.or]: [\n          { name: { [Op.like]: `%${searchQuery}%` } },\n          { email: { [Op.like]: `%${searchQuery}%` } },\n          { did: { [Op.like]: `%${searchQuery}%` } }\n        ]\n      }\n    });\n    customerFilter = `AND ... IN (${searchCustomerIds.join(',')})`;\n  }\n\n  // SQL聚合查询:按客户汇总\n  const results = await MeterEvent.sequelize!.query(`\n    SELECT\n      json_extract(me.payload, '$.customer_id') as customer_id,\n      SUM(CAST(me.credit_pending AS DECIMAL(40,0))) as total_pending,\n      COUNT(*) as event_count\n    FROM meter_events me\n    ${currencyJoin} -- 可选的币种过滤\n    WHERE me.livemode = :livemode\n      AND CAST(me.credit_pending AS DECIMAL(40,0)) > 0\n      ${customerFilter} -- 可选的搜索过滤\n    GROUP BY json_extract(me.payload, '$.customer_id')\n    HAVING total_pending > 0\n    ORDER BY event_count DESC\n    LIMIT :limit OFFSET :offset\n  `);\n\n  return res.json({ list, count, paging, currency });\n});\n```\n\n#### 关注点\n\n- [x] **逻辑正确性:** SQL 查询逻辑正确,聚合计算准确\n- ⚠️ **SQL注入风险:** `customerFilter` 使用字符串拼接:\n  ```typescript\n  customerFilter = `AND ... IN (${searchCustomerIds.map(id => `'${id}'`).join(',')})`;\n  ```\n  虽然 `searchCustomerIds` 来自数据库查询(相对安全),但仍建议使用参数化查询\n- [x] **性能优化:**\n  - 使用 `HAVING` 过滤,减少无效数据\n  - 索引假设: `meter_events.livemode`, `meter_events.credit_pending`\n  - 分页限制: `Math.min(100, pageSize)` 防止大查询\n- [x] **错误处理:** try-catch 包裹,返回 400 错误\n- ⚠️ **边界处理:** `searchQuery` 未转义,可能导致 LIKE 注入(虽然危害较小)\n\n**建议:**\n1. **SQL 安全性改进:**\n   ```typescript\n   // 使用参数化查询\n   const placeholders = searchCustomerIds.map((_, i) => `:customerId${i}`).join(',');\n   const replacements = searchCustomerIds.reduce((acc, id, i) => {\n     acc[`customerId${i}`] = id;\n     return acc;\n   }, { livemode: req.livemode ? 1 : 0 });\n   customerFilter = `AND ... IN (${placeholders})`;\n   ```\n\n2. **LIKE 转义:**\n   ```typescript\n   const escapedQuery = searchQuery.replace(/[%_]/g, '\\\\$&');\n   { name: { [Op.like]: `%${escapedQuery}%` } }\n   ```\n\n---\n\n### 5. `api/src/routes/credit-transactions.ts`\n\n**改动类型:** 修改增强\n**改动行数:** +77 -4\n\n#### 改动内容\n\n为 grant 类型的交易增加 invoice 信息关联:\n\n```diff\n// 1. 查询所有 grants\nconst rows = await CreditGrant.findAll({ ... });\n\n+// 2. 提取 invoice IDs\n+const invoiceIds = rows\n+  .map(item => item.metadata?.invoice_id)\n+  .filter(id => !!id);\n\n+// 3. 对于首次 scheduled grant (无invoice_id),通过 subscription_id 查找\n+const subscriptionIdsForFirstGrant = rows\n+  .filter(item =>\n+    item.metadata?.schedule_seq === 1 &&\n+    !item.metadata?.invoice_id &&\n+    item.metadata?.subscription_id\n+  )\n+  .map(item => item.metadata.subscription_id);\n\n+// 4. 并行查询 invoices\n+const [invoicesByIds, invoicesBySubscription] = await Promise.all([\n+  invoiceIds.length > 0 ? Invoice.findAll({ where: { id: { [Op.in]: invoiceIds } } }) : [],\n+  subscriptionIdsForFirstGrant.length > 0\n+    ? Invoice.findAll({\n+        where: { subscription_id: { [Op.in]: subscriptionIdsForFirstGrant }, status: 'paid' },\n+        order: [['created_at', 'ASC']] // 取最早的 invoice\n+      })\n+    : []\n+]);\n\n+// 5. 构建 Map 方便查找\n+const invoiceMap = new Map(...);\n+for (const inv of invoicesBySubscription) {\n+  const subId = inv.subscription_id as string;\n+  if (subId && !invoiceMap.has(subId)) {\n+    invoiceMap.set(subId, inv); // 以 subId 为 key 存储\n+  }\n+}\n\n// 6. 返回时附加 invoice 信息\nreturn rows.map(item => {\n  const grantData = item.toJSON();\n-  return { ...grantData, activity_type: 'grant' };\n+  const invoice = invoiceMap.get(grantData.metadata.invoice_id);\n+  return {\n+    ...grantData,\n+    activity_type: 'grant',\n+    invoice: invoice ? {\n+      total: invoice.total,\n+      amount_paid: invoice.amount_paid,\n+      currency_id: invoice.currency_id,\n+      paymentCurrency: invoice.paymentCurrency\n+    } : null\n+  };\n});\n```\n\n#### 代码说明\n\n**业务逻辑:**\n- Paid grant: `metadata.invoice_id` 直接关联 invoice\n- Scheduled grant (首次): 通过 `metadata.subscription_id` 查找 invoice\n- 其他 grant: 无 invoice\n\n**设计亮点:**\n- 使用 `Promise.all` 并行查询,优化性能\n- 使用 Map 优化查找效率 O(1)\n- 对首次 scheduled grant 的特殊处理很合理\n\n#### 关注点\n\n- [x] **逻辑正确性:** 业务逻辑清晰,正确处理不同类型的 grant\n- [x] **性能优化:** 批量查询+并行+Map,性能良好\n- ⚠️ **数据一致性:** 对于 subscription 查找,假设\"最早的 paid invoice\"即为首次 invoice,可能不够准确\n- [x] **边界处理:** 正确处理空数组情况\n\n**建议:**\n- 考虑在 `metadata` 中为首次 scheduled grant 也存储 `invoice_id`,避免复杂的查找逻辑\n- 或者在 `schedule_seq === 1` 时直接记录 invoice_id\n\n---\n\n### 6. `packages/react/src/history/credit/transactions-list.tsx`\n\n**改动类型:** 大幅重构\n**改动行数:** +150 -80 (估算)\n\n#### 改动内容\n\n**表格列重新设计:**\n\n```typescript\n// 旧设计: 金额 | Grant名称 | 描述 | 日期 | 操作\n// 新设计: 日期 | 描述 | 金额 | 操作\n\ncolumns = [\n  {\n    label: t('common.date'),\n    name: 'created_at',\n    // 简洁显示日期时间\n  },\n  {\n    label: t('common.description'),\n    name: 'description',\n    customBodyRenderLite: (_, index) => {\n      const item = data.list[index];\n      const isGrant = item.activity_type === 'grant';\n\n      // 根据不同类型显示不同描述\n      const isScheduled = isGrant && item.metadata?.delivery_mode === 'schedule';\n      const isPaid = isGrant && item.category === 'paid' &&\n                     (!isScheduled || item.metadata?.schedule_seq === 1);\n\n      let activityType = '';\n      let secondLine = '';\n\n      if (!isGrant) {\n        activityType = t('common.creditActivity.consumption');\n      } else if (isPaid) {\n        activityType = t('common.creditActivity.paidGrant');\n        // 显示支付金额\n        if (item.invoice?.total) {\n          secondLine = t('common.creditActivity.paidAmount', {\n            amount: formatCreditAmount(item.invoice.total, ...)\n          });\n        }\n      } else if (isScheduled) {\n        activityType = t('common.creditActivity.resetGrant');\n      } else {\n        activityType = t('common.creditActivity.promotionalGrant');\n      }\n\n      return (\n        <Stack direction=\"column\">\n          <Typography color={isGrant ? 'success.main' : 'error.main'}>\n            {activityType}\n          </Typography>\n          {secondLine && <Typography variant=\"caption\">{secondLine}</Typography>}\n        </Stack>\n      );\n    }\n  },\n  {\n    label: t('common.amount'),\n    name: 'credit_amount',\n    // 显示 +/- 金额,以及过期状态\n  },\n  {\n    label: t('common.actions'),\n    name: 'actions',\n    customBodyRenderLite: (_, index) => {\n      const item = data.list[index];\n      // 根据类型显示不同操作按钮\n      // - Paid grant: 显示\"订阅详情\"+\"发票详情\"\n      // - Scheduled grant: 显示\"订阅详情\"\n      // - Consumption with subscription: 显示\"订阅详情\"\n    }\n  }\n];\n```\n\n#### 代码说明\n\n**改进点:**\n1. **更清晰的分类:** 消费/付费充值/赠送/重置,一目了然\n2. **更多信息:** 显示支付金额、刷新周期等\n3. **更好的操作:** 根据类型提供相关操作按钮\n4. **状态标识:** 过期的 grant 显示\"已过期\"标签\n\n**业务逻辑:**\n- `category === 'paid'` + `schedule_seq === 1` → 付费充值\n- `delivery_mode === 'schedule'` + `seq > 1` → 额度重置\n- `category === 'promotional'` → 赠送\n\n#### 关注点\n\n- [x] **逻辑正确性:** 分类逻辑清晰准确\n- [x] **用户体验:** 信息层次分明,操作符合预期\n- ⚠️ **复杂度:** 嵌套条件较多,理解成本略高\n- [x] **国际化:** 完整的中英文支持\n\n---\n\n### 7. `src/pages/admin/billing/overdue/index.tsx`\n\n**改动类型:** 新增文件\n**改动行数:** +286 行\n\n#### 代码说明\n\n完整的欠费管理页面,包含:\n\n**1. 币种筛选器**\n```typescript\nfunction CurrencyFilter({ currencies, selectedCurrencyId, onChange }) {\n  // Material-UI Menu 实现下拉选择\n  // 支持清除选择\n}\n```\n\n**2. 数据表格**\n```typescript\n<Table\n  data={data?.list || []}\n  columns={[\n    { label: '客户', name: 'customer', render: <CustomerLink /> },\n    { label: '欠费金额', name: 'total_pending', render: formatCreditAmount },\n    { label: '欠费事件数', name: 'event_count' }\n  ]}\n  options={{\n    count: data?.count,\n    page: search.page - 1,\n    rowsPerPage: search.pageSize,\n    onSearchChange: (text) => setSearch({ ...prev, q: text, page: 1 })\n  }}\n/>\n```\n\n**3. URL 参数支持**\n```typescript\n// 支持从 overview 页面跳转并自动筛选币种\nuseEffect(() => {\n  const urlCurrencyId = searchParams.get('currency_id');\n  if (urlCurrencyId) {\n    setSearch(prev => ({ ...prev, currency_id: urlCurrencyId, page: 1 }));\n    setSearchParams({}, { replace: true }); // 清除URL参数\n  }\n}, []);\n```\n\n#### 关注点\n\n- [x] **功能完整:** 筛选、搜索、分页、排序\n- [x] **用户体验:** 从 overview 无缝跳转\n- [x] **状态管理:** 使用 `useLocalStorageState` 持久化搜索条件\n- [x] **性能:** 合理的分页大小限制\n\n---\n\n### 8. `src/pages/admin/overview.tsx`\n\n**改动类型:** 修改增强\n**改动行数:** +110 行\n\n#### 改动内容\n\n在 overview 页面添加欠费卡片:\n\n```typescript\nconst overdueSummary = useRequest<{\n  list: Array<{\n    currency: TPaymentCurrency;\n    total_pending: string;\n    customer_count: number;\n    event_count: number;\n  }>;\n}>(() => api.get('/api/meter-events/overdue-summary'));\n\nconst overdueList = overdueSummary.data?.list || [];\nconst hasOverdue = overdueList.length > 0;\n\n// 只在有欠费或加载中时显示卡片\n{(overdueLoading || hasOverdue) && (\n  <Card variant=\"outlined\">\n    <Stack direction=\"row\">\n      <WarningAmber sx={{ color: 'warning.main' }} />\n      <Typography variant=\"h5\">{t('admin.overviewPage.overdue.title')}</Typography>\n    </Stack>\n\n    {overdueList.map(item => (\n      <Stack\n        component={Link}\n        to={`/admin/billing/overdue?currency_id=${item.currency.id}`}\n        sx={{\n          backgroundColor: 'grey.50',\n          '&:hover': { backgroundColor: 'action.hover' }\n        }}>\n        <Avatar src={item.currency.logo} />\n        <Box>\n          <Typography variant=\"body2\">{item.currency.name}</Typography>\n          <Typography variant=\"caption\">\n            {t('admin.overviewPage.overdue.customers', { count: item.customer_count })}\n            {' · '}\n            {t('admin.overviewPage.overdue.events', { count: item.event_count })}\n          </Typography>\n        </Box>\n        <Typography variant=\"body2\" color=\"warning.main\">\n          -{formatCreditAmount(item.total_pending, item.currency.symbol)}\n        </Typography>\n        <ArrowForward className=\"arrow-icon\" />\n      </Stack>\n    ))}\n  </Card>\n)}\n```\n\n#### 关注点\n\n- [x] **视觉设计:** 警告色主题,清晰的卡片设计\n- [x] **交互体验:** Hover 效果,箭头动画\n- [x] **性能:** 条件渲染,无欠费时不显示卡片\n- [x] **导航流程:** 点击跳转到详情页并自动筛选币种\n\n---\n\n## ⚠️ 风险评估 (Risk Assessment)\n\n### 高风险项 (High Risk)\n\n- [x] **SQL 注入风险 - `meter-events.ts:L444`**\n  - **影响范围:** `/overdue-customers` API\n  - **潜在问题:** 虽然 `searchCustomerIds` 来自数据库查询,但字符串拼接仍有风险\n  - **建议措施:**\n    ```typescript\n    // 使用参数化查询\n    const placeholders = searchCustomerIds.map((_, i) => `:cid${i}`).join(',');\n    const replacements = { ...searchCustomerIds.reduce((acc, id, i) => {\n      acc[`cid${i}`] = id; return acc;\n    }, {}), livemode: req.livemode ? 1 : 0 };\n    ```\n\n- [x] **通知预检查失败回退 - `customer-credit-low-balance.ts:L64`**\n  - **影响范围:** 低余额通知可能在预检查失败时仍然发送\n  - **潜在问题:** 如果 `CreditGrant.getAvailableCreditsForCustomer` 失败,会默认发送通知\n  - **建议措施:** 增加日志和监控,评估是否需要更智能的失败处理\n\n### 中风险项 (Medium Risk)\n\n- [x] **N+1 查询风险 - `credit-transactions.ts:L188-L219`**\n  - **影响范围:** Grant 列表查询时的 invoice 关联\n  - **潜在问题:** 虽然已使用批量查询,但对于大量 subscriptions 仍可能性能下降\n  - **建议措施:**\n    - 监控查询性能\n    - 考虑在 `CreditGrant` 表直接存储 `invoice_id` 避免复杂关联\n\n- [x] **类型安全性 - `notification.ts:L310`**\n  - **影响范围:** 预检查和延迟配置的类型检查\n  - **潜在问题:** 使用 `as any` 绕过类型检查,可能运行时出错\n  - **建议措施:**\n    ```typescript\n    interface NotificationTemplateStatic {\n      preflightCheck?(options: any): Promise<boolean>;\n      delay?: number;\n    }\n    ```\n\n- [x] **数据一致性 - `credit-transactions.ts:L207`**\n  - **影响范围:** 首次 scheduled grant 的 invoice 查找\n  - **潜在问题:** 假设\"最早的 paid invoice\"即为首次 invoice,可能不准确\n  - **建议措施:**\n    - 在创建 grant 时直接关联 invoice_id\n    - 或在查询时增加更多条件(如 billing_reason)\n\n### 低风险项 (Low Risk)\n\n- [x] **LIKE 注入 - `meter-events.ts:L420`**\n  - **影响范围:** 客户搜索功能\n  - **潜在问题:** 未转义 `%` 和 `_` 字符\n  - **建议措施:** 使用 Sequelize 的转义功能\n\n- [x] **前端状态复杂度 - `transactions-list.tsx`**\n  - **影响范围:** 交易列表渲染逻辑\n  - **潜在问题:** 嵌套条件判断较多,维护成本略高\n  - **建议措施:** 考虑提取为独立的格式化函数\n\n---\n\n## 🎯 重点关注 (Focus Areas)\n\n### 大文件改动\n\n#### `packages/react/src/history/credit/transactions-list.tsx` (±230 行)\n\n- **改动原因:** 重构交易列表显示逻辑,增强用户体验\n- **主要变更:**\n  - 表格列重新排列(日期→描述→金额→操作)\n  - 根据交易类型显示不同的描述和操作\n  - 增加支付金额、刷新周期等详细信息\n- **测试情况:** 需要测试\n  - [ ] 不同类型 grant 的显示(paid/promotional/scheduled)\n  - [ ] 过期 grant 的显示\n  - [ ] 操作按钮的跳转\n- **建议:**\n  - 提取复杂的分类逻辑为独立函数\n  - 增加单元测试覆盖\n\n#### `src/pages/admin/billing/overdue/index.tsx` (+286 行)\n\n- **改动原因:** 新增欠费管理功能\n- **主要变更:** 完整的欠费查询和展示页面\n- **测试情况:** 需要测试\n  - [ ] 币种筛选功能\n  - [ ] 客户搜索功能\n  - [ ] 分页功能\n  - [ ] URL 参数跳转\n- **建议:**\n  - 测试大量欠费数据的性能\n  - 测试搜索边界情况(特殊字符、空结果)\n\n#### `api/src/libs/notification/template/customer-auto-recharge-daily-limit-exceeded.ts` (+222 行)\n\n- **改动原因:** 新增每日限额通知功能\n- **主要变更:** 完整的通知模板实现\n- **测试情况:** 需要测试\n  - [ ] 不同币种的格式化\n  - [ ] 多语言支持\n  - [ ] 边界情况(无 rechargeCurrency/paymentMethod)\n- **建议:**\n  - 增加集成测试验证邮件发送\n  - 测试与真实数据的兼容性\n\n### 后端关键改动\n\n#### API 变更\n\n**新增端点:**\n- `GET /api/meter-events/overdue-summary` - 欠费总览\n- `GET /api/meter-events/overdue-customers` - 欠费客户列表\n\n**修改端点:**\n- `GET /api/credit-transactions` - 增加 invoice 关联信息\n- `GET /api/invoices` - 增加 lines 关联\n\n**影响评估:**\n- [x] 向后兼容:所有新增字段为可选,不影响现有客户端\n- [x] 性能影响:新增 SQL 聚合查询,需监控\n- [x] 权限控制:使用 `auth` 中间件,权限正确\n\n#### 数据库操作\n\n**新增查询:**\n1. 欠费聚合查询(按币种/按客户)\n2. Invoice 批量查询\n3. CreditGrant 实时余额查询\n\n**性能考虑:**\n- 欠费查询:依赖 `meter_events.credit_pending` 索引\n- Invoice 查询:依赖 `invoices.subscription_id` 索引\n- 建议监控慢查询日志\n\n**数据一致性:**\n- 预检查机制确保通知数据准确\n- 实时查询避免缓存不一致\n\n#### 权限逻辑\n\n- [x] 所有新增 API 都使用 `auth` 中间件\n- [x] 前端 admin 路由受保护\n- [x] 无越权访问风险\n\n---\n\n## ✅ Review 建议 (Review Recommendations)\n\n### 代码质量 (Code Quality)\n**评分:** ⭐⭐⭐⭐⭐ (5/5)\n\n**优点:**\n- ✅ 代码结构清晰,遵循现有架构模式\n- ✅ 命名规范,变量、函数名清晰表意\n- ✅ 注释充分,关键逻辑有说明\n- ✅ 错误处理完整,有 try-catch 保护\n- ✅ 国际化支持完善\n\n**需要改进:**\n- ⚠️ 部分文件存在类型断言(`as any`),降低类型安全性\n- ⚠️ SQL 查询部分使用字符串拼接,有注入风险\n\n**建议:**\n- 💡 为通知模板定义接口约束静态方法\n- 💡 使用参数化查询替代字符串拼接\n- 💡 提取复杂的条件判断为独立函数,提升可读性\n\n---\n\n### 架构设计 (Architecture)\n**评分:** ⭐⭐⭐⭐☆ (4/5)\n\n**优点:**\n- ✅ 通用的预检查和延迟机制设计,扩展性好\n- ✅ 数据流清晰:事件→队列→通知→发送\n- ✅ 前后端分离,API 设计 RESTful\n- ✅ 模块职责明确,低耦合\n\n**需要改进:**\n- ⚠️ Invoice 关联查询逻辑复杂,可考虑在数据模型层优化\n- ⚠️ 通知去重机制使用内存 cache,可能在分布式环境下失效\n\n**建议:**\n- 💡 考虑在 `CreditGrant` 创建时直接关联 `invoice_id`,简化查询\n- 💡 评估是否需要使用 Redis 等持久化缓存实现去重\n- 💡 为预检查机制增加监控,追踪跳过的通知数量\n\n---\n\n### 功能验证 (Functionality)\n**评分:** ⭐⭐⭐⭐☆ (4/5)\n\n**已验证:**\n- ✅ 核心业务逻辑正确\n- ✅ 错误处理完整\n- ✅ 边界情况考虑周全(如零余额、空数据)\n\n**需要验证:**\n- ❓ 大数据量下的性能(欠费查询、invoice 关联查询)\n- ❓ 并发场景下的通知去重是否有效\n- ❓ 预检查失败时的用户影响(是否会漏通知)\n- ❓ 多语言环境下的邮件模板渲染\n- ❓ 不同类型 grant 的前端显示是否正确\n\n**建议:**\n- 💡 **必须测试:**\n  - 在 staging 环境模拟各种 credit 交易场景\n  - 验证 10 分钟延迟+预检查的实际效果\n  - 测试欠费查询在大数据量下的性能\n- 💡 **集成测试:**\n  - 自动充值达到限额→触发通知\n  - 低余额→充值→预检查跳过通知\n  - 欠费数据的准确性\n- 💡 **用户验收测试:** 让实际用户验证新的交易列表 UI\n\n---\n\n### 安全性 (Security)\n**评分:** ⭐⭐⭐⭐☆ (4/5)\n\n**安全措施:**\n- ✅ 所有 API 使用认证中间件\n- ✅ 使用 Sequelize ORM,主要查询安全\n- ✅ 输入验证(分页参数范围检查)\n- ✅ 无敏感信息泄露\n\n**潜在风险:**\n- 🔒 SQL 字符串拼接存在注入风险(虽然危害有限)\n- 🔒 LIKE 查询未转义特殊字符\n\n**建议:**\n- 💡 **必须修复:** 将 `meter-events.ts:L444` 的字符串拼接改为参数化查询\n- 💡 **建议修复:** LIKE 查询增加转义:\n  ```typescript\n  const escapedQuery = searchQuery.replace(/[%_\\\\]/g, '\\\\$&');\n  ```\n- 💡 **安全审计:** Review 所有使用原生 SQL 的地方,确保参数化\n\n---\n\n### 性能 (Performance)\n**评分:** ⭐⭐⭐⭐☆ (4/5)\n\n**性能优化:**\n- ✅ 批量查询代替 N+1 查询\n- ✅ 使用 `Promise.all` 并行查询\n- ✅ 分页限制防止大查询\n- ✅ 使用 Map 优化查找效率\n\n**潜在问题:**\n- ⚡ 欠费 SQL 聚合查询可能在大量数据时变慢\n- ⚡ Invoice 关联查询在大量 subscriptions 时可能低效\n- ⚡ 预检查增加一次数据库查询\n\n**建议:**\n- 💡 **监控:**\n  - 添加慢查询日志监控\n  - 监控欠费 API 的响应时间\n  - 监控 CreditGrant 查询性能\n- 💡 **索引优化:**\n  - 确保 `meter_events.credit_pending` 有索引\n  - 确保 `meter_events.livemode` 有索引\n  - 考虑组合索引 `(livemode, credit_pending)`\n- 💡 **缓存策略:**\n  - 欠费总览可以缓存 5-10 分钟\n  - Invoice 关联数据可以考虑缓存\n- 💡 **查询优化:**\n  - 评估是否需要物化视图存储欠费统计\n  - 考虑异步计算欠费数据\n\n---\n\n## 📝 总体评价 (Overall Assessment)\n\n### 综合评分\n**总分:** ⭐⭐⭐⭐⭐ (4.4/5)\n\n### 核心优点\n1. **功能完整且实用:** 三个核心功能(每日限额通知、智能低余额通知、欠费管理)都切中用户痛点\n2. **架构设计优秀:** 通用的预检查和延迟机制,扩展性强,向后兼容\n3. **用户体验提升:** 新的交易列表 UI 更清晰,欠费管理功能方便管理员监控\n4. **代码质量高:** 结构清晰,注释充分,错误处理完整\n5. **国际化支持:** 完整的中英文支持\n\n### 主要问题\n1. **SQL 注入风险:** `meter-events.ts` 中的字符串拼接需要改为参数化查询\n2. **类型安全性:** 使用 `as any` 降低类型检查,需要定义接口约束\n3. **性能监控不足:** 新增的 SQL 聚合查询需要监控和优化\n4. **测试覆盖不足:** 缺少集成测试和性能测试\n\n### 最终建议\n\n#### Must Fix (必须修复):\n- [ ] **SQL 注入修复** - `meter-events.ts:L444` 改为参数化查询\n- [ ] **索引验证** - 确保 `meter_events.credit_pending` 和 `livemode` 有索引\n- [ ] **集成测试** - 添加核心流程的集成测试(限额通知、预检查、欠费查询)\n\n#### Should Fix (建议修复):\n- [ ] **类型安全** - 为通知模板定义接口,移除 `as any`\n- [ ] **LIKE 转义** - 客户搜索增加特殊字符转义\n- [ ] **慢查询监控** - 添加 APM 监控,追踪欠费查询性能\n- [ ] **错误日志** - 预检查失败时增加详细日志\n- [ ] **代码复杂度** - 提取 `transactions-list.tsx` 的分类逻辑为独立函数\n\n#### Nice to Have (可选改进):\n- [ ] **数据模型优化** - 考虑在 CreditGrant 直接存储 invoice_id\n- [ ] **缓存优化** - 为欠费总览增加短时缓存\n- [ ] **去重机制** - 评估是否需要分布式去重(Redis)\n- [ ] **前端单元测试** - 为复杂的渲染逻辑增加测试\n\n### 是否建议合并\n- [x] ⚠️ **条件批准** - 修复 Must Fix 问题后可以合并\n\n**合并前检查清单:**\n1. [ ] 修复 SQL 注入风险\n2. [ ] 验证数据库索引\n3. [ ] 在 staging 环境完成集成测试\n4. [ ] 验证各类型 grant 的前端显示\n5. [ ] 进行一轮性能测试\n\n**合并后跟进:**\n1. 监控慢查询日志\n2. 监控通知发送成功率和预检查跳过率\n3. 收集用户反馈,优化 UI\n4. 补充自动化测试\n\n---\n\n## 📚 附加信息 (Additional Information)\n\n### 测试覆盖\n\n**单元测试:**\n- [ ] 通知模板的预检查逻辑\n- [ ] 交易类型分类逻辑\n- [ ] 金额格式化函数\n\n**集成测试:**\n- [ ] 自动充值限额流程\n- [ ] 低余额通知预检查\n- [ ] 欠费 API 的数据准确性\n\n**E2E 测试:**\n- [ ] 管理员查看欠费流程\n- [ ] 客户查看交易记录流程\n\n### 文档更新\n\n- [ ] API 文档:新增欠费相关端点\n- [ ] 用户手册:通知类型说明\n- [ ] 开发文档:通知预检查机制\n- [ ] 变更日志:记录本次新增功能\n\n### 部署注意事项\n\n**数据库:**\n- [ ] 验证索引: `meter_events.credit_pending`, `meter_events.livemode`\n- [ ] 无需数据迁移\n\n**配置变更:**\n- [ ] 无需配置变更\n\n**部署顺序:**\n1. 部署后端(API + 队列处理)\n2. 部署前端\n3. 监控通知队列和欠费查询\n\n**回滚方案:**\n- 通知系统向后兼容,可以直接回滚代码\n- 欠费功能为新增,不影响现有功能\n- 建议保留 1 个版本的回滚窗口\n\n**监控指标:**\n- 通知发送成功率\n- 预检查跳过率\n- 欠费 API 响应时间\n- CreditGrant 查询性能\n\n---\n\n**生成时间:** 2026-01-12\n**审查人:** Claude Code Review Assistant\n**版本:** 1.0\n"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":13,"cache_creation_input_tokens":12765,"cache_read_input_tokens":72914,"cache_creation":{"ephemeral_5m_input_tokens":12765,"ephemeral_1h_input_tokens":0},"output_tokens":14480,"service_tier":"standard"}},"requestId":"req_011CX3bqGovaQnczCaQXc4Qx","type":"assistant","uuid":"dcf6d179-34f9-4639-8c5e-e2bee7499885","timestamp":"2026-01-12T14:00:55.701Z"}
{"type":"file-history-snapshot","messageId":"dcf6d179-34f9-4639-8c5e-e2bee7499885","snapshot":{"messageId":"b90b5866-b009-44c8-9910-1ed735b3cd2f","trackedFileBackups":{"CODE_REVIEW.md":{"backupFileName":null,"version":1,"backupTime":"2026-01-12T14:01:07.614Z"}},"timestamp":"2026-01-12T13:51:31.971Z"},"isSnapshotUpdate":true}
{"parentUuid":"dcf6d179-34f9-4639-8c5e-e2bee7499885","isSidechain":false,"userType":"external","cwd":"~/Arcblock/payment-kit-master/blocklets/core","sessionId":"664f44d5-76eb-4da6-b55c-a98e01f05344","version":"2.0.76","gitBranch":"feat-quote","slug":"quirky-skipping-brooks","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01NR3pWRRDZxideib5ud2sMg","type":"tool_result","content":"File created successfully at: ~/Arcblock/payment-kit-master/blocklets/core/CODE_REVIEW.md"}]},"uuid":"fe3905e0-b2f3-4955-a99b-52a6dbf8ff3a","timestamp":"2026-01-12T14:01:07.666Z","toolUseResult":{"type":"create","filePath":"~/Arcblock/payment-kit-master/blocklets/core/CODE_REVIEW.md","content":"# Code Review Document\n\n## 📋 改动概览 (Change Summary)\n\n**变更类型：** Feature + Enhancement\n\n**影响范围:**\n- 修改文件数：21 个\n- 新增文件数：3 个\n- 删除文件数：0 个\n- 代码行变更：+1500 -150 (估算)\n\n**关键文件:**\n- `api/src/libs/notification/template/customer-auto-recharge-daily-limit-exceeded.ts` - 新增每日限额通知模板 (+222行)\n- `api/src/libs/notification/template/customer-credit-low-balance.ts` - 增强低余额通知机制 (+37行)\n- `api/src/queues/notification.ts` - 新增延迟发送和预检查机制 (+65行)\n- `api/src/routes/meter-events.ts` - 新增欠费管理 API (+163行)\n- `api/src/routes/credit-transactions.ts` - 增强交易记录查询 (+77行)\n- `packages/react/src/history/credit/transactions-list.tsx` - 重构交易列表显示逻辑 (大幅改动)\n- `src/pages/admin/billing/overdue/index.tsx` - 新增欠费管理页面 (+286行)\n- `src/pages/admin/overview.tsx` - 增加欠费卡片展示 (+110行)\n\n**依赖变更:**\n- [x] 新增通知类型: `customer.auto_recharge.daily_limit_exceeded`\n- [x] 数据库查询增强：涉及 Invoice、CreditGrant 的关联查询\n- [x] 国际化配置更新\n\n---\n\n## 🔄 业务流程分析 (Business Flow Analysis)\n\n### 功能描述\n\n本次改动主要实现了三个核心功能增强：\n\n1. **自动充值每日限额通知** - 当自动充值因达到每日限额而失败时，通知用户\n2. **智能低余额通知** - 增加10分钟延迟和预检查机制，避免用户充值后仍收到通知\n3. **欠费管理系统** - 为管理员提供完整的欠费(credit pending)监控和管理功能\n\n### 业务流程\n\n#### 1. 自动充值每日限额通知流程\n\n```\nCredit消费触发 → 余额低于阈值 → 尝试自动充值 → 检查每日限额\n→ 限额已达 → 创建audit事件 → 触发通知队列 → 发送邮件通知用户\n```\n\n**详细流程:**\n1. **触发条件:**\n   - 用户 credit 消费后余额低于阈值\n   - 自动充值配置已启用\n   - 每日充值已达到 `daily_limits.max_amount`\n\n2. **事件创建:** (`api/src/queues/auto-recharge.ts:130`)\n   ```typescript\n   createEvent('Customer', 'customer.auto_recharge.daily_limit_exceeded', customer, {\n     autoRechargeConfigId: config.id,\n     currencyId,\n     currentBalance: totalAvailable.toString(),\n   });\n   ```\n\n3. **通知处理:**\n   - 24小时去重机制(防止重复通知)\n   - 生成邮件模板,包含当前余额、每日限额、今日已用金额\n   - 提供\"手动充值\"和\"管理额度\"按钮\n\n#### 2. 智能低余额通知流程\n\n```\nCredit消费 → 余额低于10% → 添加延迟通知(10分钟)\n→ 队列等待 → 预检查余额是否仍低于10% → 是:发送通知 / 否:跳过\n```\n\n**详细流程:**\n1. **触发条件:** (`api/src/queues/credit-consume.ts:320`)\n   - 余额低于总额度的10%\n   - `insufficient` 事件未触发(优先级让位给余额不足通知)\n\n2. **延迟机制:** 10分钟 grace period\n   - 给用户时间进行手动充值\n   - 避免通知风暴\n\n3. **预检查逻辑:** (`api/src/libs/notification/template/customer-credit-low-balance.ts:41`)\n   ```typescript\n   static async preflightCheck(options): Promise<boolean> {\n     // 重新获取最新余额数据\n     const availableGrants = await CreditGrant.getAvailableCreditsForCustomer(...);\n     const currentPercentage = remainingAmount.mul(100).div(totalAmount).toNumber();\n     // 如果已充值导致余额>10%,则跳过通知\n     return currentPercentage <= 10;\n   }\n   ```\n\n4. **数据一致性:**\n   - 通知模板从数据库实时获取最新余额(而非使用缓存的 options 数据)\n   - 确保显示给用户的金额准确无误\n\n#### 3. 欠费管理系统流程\n\n```\n用户消费 → Credit不足 → 产生pending事件\n→ 管理员查看欠费总览 → 按币种/客户查询 → 查看详细欠费事件\n```\n\n**详细流程:**\n1. **数据源:** `meter_events.credit_pending` 字段\n   - 记录无法扣除的 credit 金额\n\n2. **API 端点:**\n   - `GET /api/meter-events/overdue-summary` - 按币种汇总欠费\n   - `GET /api/meter-events/overdue-customers` - 按客户列出欠费,支持搜索和分页\n\n3. **前端展示:**\n   - Admin Overview 页面显示欠费卡片\n   - 新增 `/admin/billing/overdue` 页面,提供详细的欠费管理界面\n   - 支持按币种筛选、客户搜索\n\n### 数据流图\n\n```\n┌─────────────────┐\n│ Credit 消费事件  │\n└────────┬────────┘\n         │\n    ┌────▼─────┐\n    │余额检查   │\n    └─┬──┬─────┘\n      │  │\n  不足 │  │ 低但够用\n      │  │\n      ▼  ▼\n   pending  low_balance (10分钟后+预检)\n      │      │\n      ▼      ▼\n   欠费记录  通知用户\n      │\n      ▼\n   管理员查看\n```\n\n---\n\n## 🔍 关键代码详解 (Key Code Analysis)\n\n### 1. `api/src/libs/notification/template/customer-auto-recharge-daily-limit-exceeded.ts`\n\n**改动类型:** 新增文件\n**改动行数:** +222 行\n\n#### 代码说明\n\n这是一个完整的邮件通知模板类,遵循现有的模板模式:\n\n```typescript\nexport class CustomerAutoRechargeDailyLimitExceededEmailTemplate\n  implements BaseEmailTemplate<CustomerAutoRechargeDailyLimitExceededEmailTemplateContext>\n{\n  // 获取上下文数据\n  async getContext(): Promise<Context> {\n    // 查询客户、自动充值配置、币种信息\n    const autoRechargeConfig = await AutoRechargeConfig.findByPk(..., {\n      include: [Price, PaymentMethod, PaymentCurrency]\n    });\n\n    // 格式化显示数据\n    const dailyLimit = formatCurrencyInfo(config.daily_limits?.max_amount);\n    const dailyUsed = formatCurrencyInfo(config.daily_stats?.total_amount);\n\n    return { locale, userDid, currentBalance, dailyLimit, dailyUsed, ... };\n  }\n\n  // 生成邮件模板\n  async getTemplate(): Promise<BaseEmailTemplateType> {\n    return {\n      title: translate('notification.autoRechargeDailyLimitExceeded.title'),\n      body: translate('notification.autoRechargeDailyLimitExceeded.body'),\n      attachments: [...], // 显示账户信息、余额、限额等\n      actions: [...] // 手动充值、管理额度按钮\n    };\n  }\n}\n```\n\n#### 关注点\n\n- [x] **逻辑正确性:** 代码结构清晰,遵循现有模板模式\n- [x] **边界处理:** 正确处理 `rechargeCurrency` 和 `paymentMethod` 可能为 null 的情况\n- [x] **错误处理:** 对不存在的 customer/config/currency 抛出明确的错误\n- ⚠️ **性能影响:** 多次数据库查询(customer, config, currencies),但通知场景下可接受\n\n**建议:**\n- 可以考虑使用单次查询+include 优化数据库查询次数\n- `creditCurrency` 和 `rechargeCurrency` 查询可以合并为一次批量查询\n\n---\n\n### 2. `api/src/libs/notification/template/customer-credit-low-balance.ts`\n\n**改动类型:** 修改增强\n**改动行数:** +37 -3\n\n#### 改动内容\n\n```diff\nexport class CustomerCreditLowBalanceEmailTemplate {\n+  // 新增: 10分钟延迟配置\n+  static readonly delay = 10 * 60; // seconds\n+  static readonly LOW_BALANCE_THRESHOLD_PERCENT = 10;\n+\n+  // 新增: 预检查机制\n+  static async preflightCheck(options): Promise<boolean> {\n+    // 重新查询最新余额\n+    const availableGrants = await CreditGrant.getAvailableCreditsForCustomer(...);\n+    const currentPercentage = remainingAmount.mul(100).div(totalAmount).toNumber();\n+    // 如果余额已恢复,返回 false 跳过发送\n+    return currentPercentage <= 10;\n+  }\n\n  async getContext(): Promise<...> {\n-    const { customerId, currencyId, availableAmount, percentage } = this.options;\n+    const { customerId, currencyId } = this.options; // 移除 stale 数据\n\n+    // 实时获取最新数据而非使用缓存\n+    const availableGrants = await CreditGrant.getAvailableCreditsForCustomer(...);\n+    const remainingAmount = availableGrants.reduce(...);\n+    const currentPercentage = totalAmount.gt(0)\n+      ? remainingAmount.mul(100).div(totalAmount).toNumber()\n+      : 0;\n  }\n}\n```\n\n#### 代码说明\n\n**核心改进:**\n1. **延迟发送:** 10分钟 grace period,给用户充值时间\n2. **预检查:** 发送前重新验证余额,避免已充值用户仍收到通知\n3. **数据新鲜度:** 不再依赖 options 中可能过时的数据,而是实时查询\n\n**设计优势:**\n- 减少误报,提升用户体验\n- 避免\"刚充值就收到余额不足通知\"的尴尬情况\n\n#### 关注点\n\n- [x] **逻辑正确性:** 预检查逻辑正确,10%阈值合理\n- [x] **边界处理:** 正确处理 `totalAmount = 0` 的情况\n- [x] **错误处理:** try-catch 包裹预检查,失败时默认发送(避免漏通知)\n- ⚠️ **性能影响:** 每次通知增加一次数据库查询,但可接受\n\n---\n\n### 3. `api/src/queues/notification.ts`\n\n**改动类型:** 修改增强\n**改动行数:** +65 -1\n\n#### 改动内容\n\n```diff\n// 新增预检查逻辑\nasync function handleNotificationJob(job: NotificationQueueJob): Promise<void> {\n  const template = await getNotificationTemplate(job);\n\n+  // 检查模板类是否有预检查方法\n+  const TemplateClass = template.constructor as any;\n+  if (TemplateClass.preflightCheck) {\n+    const shouldSend = await TemplateClass.preflightCheck(job.options);\n+    if (!shouldSend) {\n+      logger.info('handleNotificationJob.skipped: preflight check returned false');\n+      return; // 跳过发送\n+    }\n+  }\n\n  await new Notification(template, job.type).send();\n}\n\n// 新增延迟发送函数\n+export async function addNotificationJobWithDelay(\n+  type, options, extraIds, preventDuplicate, duplicateWindow\n+) {\n+  // ... 去重逻辑 ...\n+\n+  // 从模板类获取 delay 配置\n+  const template = await getNotificationTemplate({ type, options });\n+  const TemplateClass = template.constructor as any;\n+  const { delay } = TemplateClass;\n+\n+  return notificationQueue.push({\n+    id: idParts.join('.'),\n+    job: { type, options },\n+    ...(delay && delay > 0 ? { delay } : {}) // 添加延迟\n+  });\n+}\n\n// 将 low_balance 切换到延迟发送\nevents.on('customer.credit.low_balance', (customer, { metadata }) => {\n-  addNotificationJob(...)\n+  addNotificationJobWithDelay(...) // 使用新函数\n});\n\n// 新增每日限额事件监听\n+events.on('customer.auto_recharge.daily_limit_exceeded', (...) => {\n+  addNotificationJob(..., true, 24 * 3600); // 24小时去重\n+});\n```\n\n#### 代码说明\n\n**设计亮点:**\n1. **通用预检查机制:** 通过检查静态方法实现可选的预检查\n2. **通用延迟机制:** 通过读取静态 `delay` 属性实现可配置延迟\n3. **去重防护:** 24小时窗口防止重复通知\n\n**架构优势:**\n- 向后兼容:现有模板无需修改\n- 扩展性好:新模板可以选择性启用预检查/延迟\n\n#### 关注点\n\n- [x] **逻辑正确性:** 预检查和延迟逻辑正确\n- [x] **边界处理:** 正确处理无 `preflightCheck` 方法的模板\n- ⚠️ **类型安全:** 使用 `as any` 访问静态方法,缺乏类型约束\n- [x] **性能影响:** `getNotificationTemplate` 被调用两次(去重检查+实际发送),但逻辑合理\n\n**建议:**\n- 可以定义接口来约束模板类的静态方法:\n  ```typescript\n  interface NotificationTemplateClass {\n    preflightCheck?(options: any): Promise<boolean>;\n    delay?: number;\n  }\n  ```\n\n---\n\n### 4. `api/src/routes/meter-events.ts`\n\n**改动类型:** 新增功能\n**改动行数:** +163 行\n\n#### 改动内容\n\n新增两个 API 端点:\n\n**1. `/overdue-summary` - 欠费总览**\n```typescript\nrouter.get('/overdue-summary', auth, async (req, res) => {\n  // SQL聚合查询:按币种汇总 credit_pending\n  const results = await MeterEvent.sequelize!.query(`\n    SELECT\n      m.currency_id,\n      SUM(CAST(me.credit_pending AS DECIMAL(40,0))) as total_pending,\n      COUNT(DISTINCT json_extract(me.payload, '$.customer_id')) as customer_count,\n      COUNT(*) as event_count\n    FROM meter_events me\n    JOIN meters m ON me.event_name = m.event_name\n    WHERE me.livemode = :livemode\n      AND CAST(me.credit_pending AS DECIMAL(40,0)) > 0\n    GROUP BY m.currency_id\n    HAVING total_pending > 0\n    ORDER BY total_pending DESC\n  `);\n\n  // 补充币种详情\n  const currencies = await PaymentCurrency.findAll(...);\n  return res.json({ list: results.map(...) });\n});\n```\n\n**2. `/overdue-customers` - 欠费客户列表**\n```typescript\nrouter.get('/overdue-customers', auth, async (req, res) => {\n  // 支持分页、币种筛选、客户搜索\n  const page = Math.max(1, parseInt(req.query.page || '1'));\n  const currencyId = req.query.currency_id;\n  const searchQuery = req.query.q;\n\n  // 如果有搜索,先查询匹配的客户ID\n  if (searchQuery) {\n    const searchCustomers = await Customer.findAll({\n      where: {\n        [Op.or]: [\n          { name: { [Op.like]: `%${searchQuery}%` } },\n          { email: { [Op.like]: `%${searchQuery}%` } },\n          { did: { [Op.like]: `%${searchQuery}%` } }\n        ]\n      }\n    });\n    customerFilter = `AND ... IN (${searchCustomerIds.join(',')})`;\n  }\n\n  // SQL聚合查询:按客户汇总\n  const results = await MeterEvent.sequelize!.query(`\n    SELECT\n      json_extract(me.payload, '$.customer_id') as customer_id,\n      SUM(CAST(me.credit_pending AS DECIMAL(40,0))) as total_pending,\n      COUNT(*) as event_count\n    FROM meter_events me\n    ${currencyJoin} -- 可选的币种过滤\n    WHERE me.livemode = :livemode\n      AND CAST(me.credit_pending AS DECIMAL(40,0)) > 0\n      ${customerFilter} -- 可选的搜索过滤\n    GROUP BY json_extract(me.payload, '$.customer_id')\n    HAVING total_pending > 0\n    ORDER BY event_count DESC\n    LIMIT :limit OFFSET :offset\n  `);\n\n  return res.json({ list, count, paging, currency });\n});\n```\n\n#### 关注点\n\n- [x] **逻辑正确性:** SQL 查询逻辑正确,聚合计算准确\n- ⚠️ **SQL注入风险:** `customerFilter` 使用字符串拼接:\n  ```typescript\n  customerFilter = `AND ... IN (${searchCustomerIds.map(id => `'${id}'`).join(',')})`;\n  ```\n  虽然 `searchCustomerIds` 来自数据库查询(相对安全),但仍建议使用参数化查询\n- [x] **性能优化:**\n  - 使用 `HAVING` 过滤,减少无效数据\n  - 索引假设: `meter_events.livemode`, `meter_events.credit_pending`\n  - 分页限制: `Math.min(100, pageSize)` 防止大查询\n- [x] **错误处理:** try-catch 包裹,返回 400 错误\n- ⚠️ **边界处理:** `searchQuery` 未转义,可能导致 LIKE 注入(虽然危害较小)\n\n**建议:**\n1. **SQL 安全性改进:**\n   ```typescript\n   // 使用参数化查询\n   const placeholders = searchCustomerIds.map((_, i) => `:customerId${i}`).join(',');\n   const replacements = searchCustomerIds.reduce((acc, id, i) => {\n     acc[`customerId${i}`] = id;\n     return acc;\n   }, { livemode: req.livemode ? 1 : 0 });\n   customerFilter = `AND ... IN (${placeholders})`;\n   ```\n\n2. **LIKE 转义:**\n   ```typescript\n   const escapedQuery = searchQuery.replace(/[%_]/g, '\\\\$&');\n   { name: { [Op.like]: `%${escapedQuery}%` } }\n   ```\n\n---\n\n### 5. `api/src/routes/credit-transactions.ts`\n\n**改动类型:** 修改增强\n**改动行数:** +77 -4\n\n#### 改动内容\n\n为 grant 类型的交易增加 invoice 信息关联:\n\n```diff\n// 1. 查询所有 grants\nconst rows = await CreditGrant.findAll({ ... });\n\n+// 2. 提取 invoice IDs\n+const invoiceIds = rows\n+  .map(item => item.metadata?.invoice_id)\n+  .filter(id => !!id);\n\n+// 3. 对于首次 scheduled grant (无invoice_id),通过 subscription_id 查找\n+const subscriptionIdsForFirstGrant = rows\n+  .filter(item =>\n+    item.metadata?.schedule_seq === 1 &&\n+    !item.metadata?.invoice_id &&\n+    item.metadata?.subscription_id\n+  )\n+  .map(item => item.metadata.subscription_id);\n\n+// 4. 并行查询 invoices\n+const [invoicesByIds, invoicesBySubscription] = await Promise.all([\n+  invoiceIds.length > 0 ? Invoice.findAll({ where: { id: { [Op.in]: invoiceIds } } }) : [],\n+  subscriptionIdsForFirstGrant.length > 0\n+    ? Invoice.findAll({\n+        where: { subscription_id: { [Op.in]: subscriptionIdsForFirstGrant }, status: 'paid' },\n+        order: [['created_at', 'ASC']] // 取最早的 invoice\n+      })\n+    : []\n+]);\n\n+// 5. 构建 Map 方便查找\n+const invoiceMap = new Map(...);\n+for (const inv of invoicesBySubscription) {\n+  const subId = inv.subscription_id as string;\n+  if (subId && !invoiceMap.has(subId)) {\n+    invoiceMap.set(subId, inv); // 以 subId 为 key 存储\n+  }\n+}\n\n// 6. 返回时附加 invoice 信息\nreturn rows.map(item => {\n  const grantData = item.toJSON();\n-  return { ...grantData, activity_type: 'grant' };\n+  const invoice = invoiceMap.get(grantData.metadata.invoice_id);\n+  return {\n+    ...grantData,\n+    activity_type: 'grant',\n+    invoice: invoice ? {\n+      total: invoice.total,\n+      amount_paid: invoice.amount_paid,\n+      currency_id: invoice.currency_id,\n+      paymentCurrency: invoice.paymentCurrency\n+    } : null\n+  };\n});\n```\n\n#### 代码说明\n\n**业务逻辑:**\n- Paid grant: `metadata.invoice_id` 直接关联 invoice\n- Scheduled grant (首次): 通过 `metadata.subscription_id` 查找 invoice\n- 其他 grant: 无 invoice\n\n**设计亮点:**\n- 使用 `Promise.all` 并行查询,优化性能\n- 使用 Map 优化查找效率 O(1)\n- 对首次 scheduled grant 的特殊处理很合理\n\n#### 关注点\n\n- [x] **逻辑正确性:** 业务逻辑清晰,正确处理不同类型的 grant\n- [x] **性能优化:** 批量查询+并行+Map,性能良好\n- ⚠️ **数据一致性:** 对于 subscription 查找,假设\"最早的 paid invoice\"即为首次 invoice,可能不够准确\n- [x] **边界处理:** 正确处理空数组情况\n\n**建议:**\n- 考虑在 `metadata` 中为首次 scheduled grant 也存储 `invoice_id`,避免复杂的查找逻辑\n- 或者在 `schedule_seq === 1` 时直接记录 invoice_id\n\n---\n\n### 6. `packages/react/src/history/credit/transactions-list.tsx`\n\n**改动类型:** 大幅重构\n**改动行数:** +150 -80 (估算)\n\n#### 改动内容\n\n**表格列重新设计:**\n\n```typescript\n// 旧设计: 金额 | Grant名称 | 描述 | 日期 | 操作\n// 新设计: 日期 | 描述 | 金额 | 操作\n\ncolumns = [\n  {\n    label: t('common.date'),\n    name: 'created_at',\n    // 简洁显示日期时间\n  },\n  {\n    label: t('common.description'),\n    name: 'description',\n    customBodyRenderLite: (_, index) => {\n      const item = data.list[index];\n      const isGrant = item.activity_type === 'grant';\n\n      // 根据不同类型显示不同描述\n      const isScheduled = isGrant && item.metadata?.delivery_mode === 'schedule';\n      const isPaid = isGrant && item.category === 'paid' &&\n                     (!isScheduled || item.metadata?.schedule_seq === 1);\n\n      let activityType = '';\n      let secondLine = '';\n\n      if (!isGrant) {\n        activityType = t('common.creditActivity.consumption');\n      } else if (isPaid) {\n        activityType = t('common.creditActivity.paidGrant');\n        // 显示支付金额\n        if (item.invoice?.total) {\n          secondLine = t('common.creditActivity.paidAmount', {\n            amount: formatCreditAmount(item.invoice.total, ...)\n          });\n        }\n      } else if (isScheduled) {\n        activityType = t('common.creditActivity.resetGrant');\n      } else {\n        activityType = t('common.creditActivity.promotionalGrant');\n      }\n\n      return (\n        <Stack direction=\"column\">\n          <Typography color={isGrant ? 'success.main' : 'error.main'}>\n            {activityType}\n          </Typography>\n          {secondLine && <Typography variant=\"caption\">{secondLine}</Typography>}\n        </Stack>\n      );\n    }\n  },\n  {\n    label: t('common.amount'),\n    name: 'credit_amount',\n    // 显示 +/- 金额,以及过期状态\n  },\n  {\n    label: t('common.actions'),\n    name: 'actions',\n    customBodyRenderLite: (_, index) => {\n      const item = data.list[index];\n      // 根据类型显示不同操作按钮\n      // - Paid grant: 显示\"订阅详情\"+\"发票详情\"\n      // - Scheduled grant: 显示\"订阅详情\"\n      // - Consumption with subscription: 显示\"订阅详情\"\n    }\n  }\n];\n```\n\n#### 代码说明\n\n**改进点:**\n1. **更清晰的分类:** 消费/付费充值/赠送/重置,一目了然\n2. **更多信息:** 显示支付金额、刷新周期等\n3. **更好的操作:** 根据类型提供相关操作按钮\n4. **状态标识:** 过期的 grant 显示\"已过期\"标签\n\n**业务逻辑:**\n- `category === 'paid'` + `schedule_seq === 1` → 付费充值\n- `delivery_mode === 'schedule'` + `seq > 1` → 额度重置\n- `category === 'promotional'` → 赠送\n\n#### 关注点\n\n- [x] **逻辑正确性:** 分类逻辑清晰准确\n- [x] **用户体验:** 信息层次分明,操作符合预期\n- ⚠️ **复杂度:** 嵌套条件较多,理解成本略高\n- [x] **国际化:** 完整的中英文支持\n\n---\n\n### 7. `src/pages/admin/billing/overdue/index.tsx`\n\n**改动类型:** 新增文件\n**改动行数:** +286 行\n\n#### 代码说明\n\n完整的欠费管理页面,包含:\n\n**1. 币种筛选器**\n```typescript\nfunction CurrencyFilter({ currencies, selectedCurrencyId, onChange }) {\n  // Material-UI Menu 实现下拉选择\n  // 支持清除选择\n}\n```\n\n**2. 数据表格**\n```typescript\n<Table\n  data={data?.list || []}\n  columns={[\n    { label: '客户', name: 'customer', render: <CustomerLink /> },\n    { label: '欠费金额', name: 'total_pending', render: formatCreditAmount },\n    { label: '欠费事件数', name: 'event_count' }\n  ]}\n  options={{\n    count: data?.count,\n    page: search.page - 1,\n    rowsPerPage: search.pageSize,\n    onSearchChange: (text) => setSearch({ ...prev, q: text, page: 1 })\n  }}\n/>\n```\n\n**3. URL 参数支持**\n```typescript\n// 支持从 overview 页面跳转并自动筛选币种\nuseEffect(() => {\n  const urlCurrencyId = searchParams.get('currency_id');\n  if (urlCurrencyId) {\n    setSearch(prev => ({ ...prev, currency_id: urlCurrencyId, page: 1 }));\n    setSearchParams({}, { replace: true }); // 清除URL参数\n  }\n}, []);\n```\n\n#### 关注点\n\n- [x] **功能完整:** 筛选、搜索、分页、排序\n- [x] **用户体验:** 从 overview 无缝跳转\n- [x] **状态管理:** 使用 `useLocalStorageState` 持久化搜索条件\n- [x] **性能:** 合理的分页大小限制\n\n---\n\n### 8. `src/pages/admin/overview.tsx`\n\n**改动类型:** 修改增强\n**改动行数:** +110 行\n\n#### 改动内容\n\n在 overview 页面添加欠费卡片:\n\n```typescript\nconst overdueSummary = useRequest<{\n  list: Array<{\n    currency: TPaymentCurrency;\n    total_pending: string;\n    customer_count: number;\n    event_count: number;\n  }>;\n}>(() => api.get('/api/meter-events/overdue-summary'));\n\nconst overdueList = overdueSummary.data?.list || [];\nconst hasOverdue = overdueList.length > 0;\n\n// 只在有欠费或加载中时显示卡片\n{(overdueLoading || hasOverdue) && (\n  <Card variant=\"outlined\">\n    <Stack direction=\"row\">\n      <WarningAmber sx={{ color: 'warning.main' }} />\n      <Typography variant=\"h5\">{t('admin.overviewPage.overdue.title')}</Typography>\n    </Stack>\n\n    {overdueList.map(item => (\n      <Stack\n        component={Link}\n        to={`/admin/billing/overdue?currency_id=${item.currency.id}`}\n        sx={{\n          backgroundColor: 'grey.50',\n          '&:hover': { backgroundColor: 'action.hover' }\n        }}>\n        <Avatar src={item.currency.logo} />\n        <Box>\n          <Typography variant=\"body2\">{item.currency.name}</Typography>\n          <Typography variant=\"caption\">\n            {t('admin.overviewPage.overdue.customers', { count: item.customer_count })}\n            {' · '}\n            {t('admin.overviewPage.overdue.events', { count: item.event_count })}\n          </Typography>\n        </Box>\n        <Typography variant=\"body2\" color=\"warning.main\">\n          -{formatCreditAmount(item.total_pending, item.currency.symbol)}\n        </Typography>\n        <ArrowForward className=\"arrow-icon\" />\n      </Stack>\n    ))}\n  </Card>\n)}\n```\n\n#### 关注点\n\n- [x] **视觉设计:** 警告色主题,清晰的卡片设计\n- [x] **交互体验:** Hover 效果,箭头动画\n- [x] **性能:** 条件渲染,无欠费时不显示卡片\n- [x] **导航流程:** 点击跳转到详情页并自动筛选币种\n\n---\n\n## ⚠️ 风险评估 (Risk Assessment)\n\n### 高风险项 (High Risk)\n\n- [x] **SQL 注入风险 - `meter-events.ts:L444`**\n  - **影响范围:** `/overdue-customers` API\n  - **潜在问题:** 虽然 `searchCustomerIds` 来自数据库查询,但字符串拼接仍有风险\n  - **建议措施:**\n    ```typescript\n    // 使用参数化查询\n    const placeholders = searchCustomerIds.map((_, i) => `:cid${i}`).join(',');\n    const replacements = { ...searchCustomerIds.reduce((acc, id, i) => {\n      acc[`cid${i}`] = id; return acc;\n    }, {}), livemode: req.livemode ? 1 : 0 };\n    ```\n\n- [x] **通知预检查失败回退 - `customer-credit-low-balance.ts:L64`**\n  - **影响范围:** 低余额通知可能在预检查失败时仍然发送\n  - **潜在问题:** 如果 `CreditGrant.getAvailableCreditsForCustomer` 失败,会默认发送通知\n  - **建议措施:** 增加日志和监控,评估是否需要更智能的失败处理\n\n### 中风险项 (Medium Risk)\n\n- [x] **N+1 查询风险 - `credit-transactions.ts:L188-L219`**\n  - **影响范围:** Grant 列表查询时的 invoice 关联\n  - **潜在问题:** 虽然已使用批量查询,但对于大量 subscriptions 仍可能性能下降\n  - **建议措施:**\n    - 监控查询性能\n    - 考虑在 `CreditGrant` 表直接存储 `invoice_id` 避免复杂关联\n\n- [x] **类型安全性 - `notification.ts:L310`**\n  - **影响范围:** 预检查和延迟配置的类型检查\n  - **潜在问题:** 使用 `as any` 绕过类型检查,可能运行时出错\n  - **建议措施:**\n    ```typescript\n    interface NotificationTemplateStatic {\n      preflightCheck?(options: any): Promise<boolean>;\n      delay?: number;\n    }\n    ```\n\n- [x] **数据一致性 - `credit-transactions.ts:L207`**\n  - **影响范围:** 首次 scheduled grant 的 invoice 查找\n  - **潜在问题:** 假设\"最早的 paid invoice\"即为首次 invoice,可能不准确\n  - **建议措施:**\n    - 在创建 grant 时直接关联 invoice_id\n    - 或在查询时增加更多条件(如 billing_reason)\n\n### 低风险项 (Low Risk)\n\n- [x] **LIKE 注入 - `meter-events.ts:L420`**\n  - **影响范围:** 客户搜索功能\n  - **潜在问题:** 未转义 `%` 和 `_` 字符\n  - **建议措施:** 使用 Sequelize 的转义功能\n\n- [x] **前端状态复杂度 - `transactions-list.tsx`**\n  - **影响范围:** 交易列表渲染逻辑\n  - **潜在问题:** 嵌套条件判断较多,维护成本略高\n  - **建议措施:** 考虑提取为独立的格式化函数\n\n---\n\n## 🎯 重点关注 (Focus Areas)\n\n### 大文件改动\n\n#### `packages/react/src/history/credit/transactions-list.tsx` (±230 行)\n\n- **改动原因:** 重构交易列表显示逻辑,增强用户体验\n- **主要变更:**\n  - 表格列重新排列(日期→描述→金额→操作)\n  - 根据交易类型显示不同的描述和操作\n  - 增加支付金额、刷新周期等详细信息\n- **测试情况:** 需要测试\n  - [ ] 不同类型 grant 的显示(paid/promotional/scheduled)\n  - [ ] 过期 grant 的显示\n  - [ ] 操作按钮的跳转\n- **建议:**\n  - 提取复杂的分类逻辑为独立函数\n  - 增加单元测试覆盖\n\n#### `src/pages/admin/billing/overdue/index.tsx` (+286 行)\n\n- **改动原因:** 新增欠费管理功能\n- **主要变更:** 完整的欠费查询和展示页面\n- **测试情况:** 需要测试\n  - [ ] 币种筛选功能\n  - [ ] 客户搜索功能\n  - [ ] 分页功能\n  - [ ] URL 参数跳转\n- **建议:**\n  - 测试大量欠费数据的性能\n  - 测试搜索边界情况(特殊字符、空结果)\n\n#### `api/src/libs/notification/template/customer-auto-recharge-daily-limit-exceeded.ts` (+222 行)\n\n- **改动原因:** 新增每日限额通知功能\n- **主要变更:** 完整的通知模板实现\n- **测试情况:** 需要测试\n  - [ ] 不同币种的格式化\n  - [ ] 多语言支持\n  - [ ] 边界情况(无 rechargeCurrency/paymentMethod)\n- **建议:**\n  - 增加集成测试验证邮件发送\n  - 测试与真实数据的兼容性\n\n### 后端关键改动\n\n#### API 变更\n\n**新增端点:**\n- `GET /api/meter-events/overdue-summary` - 欠费总览\n- `GET /api/meter-events/overdue-customers` - 欠费客户列表\n\n**修改端点:**\n- `GET /api/credit-transactions` - 增加 invoice 关联信息\n- `GET /api/invoices` - 增加 lines 关联\n\n**影响评估:**\n- [x] 向后兼容:所有新增字段为可选,不影响现有客户端\n- [x] 性能影响:新增 SQL 聚合查询,需监控\n- [x] 权限控制:使用 `auth` 中间件,权限正确\n\n#### 数据库操作\n\n**新增查询:**\n1. 欠费聚合查询(按币种/按客户)\n2. Invoice 批量查询\n3. CreditGrant 实时余额查询\n\n**性能考虑:**\n- 欠费查询:依赖 `meter_events.credit_pending` 索引\n- Invoice 查询:依赖 `invoices.subscription_id` 索引\n- 建议监控慢查询日志\n\n**数据一致性:**\n- 预检查机制确保通知数据准确\n- 实时查询避免缓存不一致\n\n#### 权限逻辑\n\n- [x] 所有新增 API 都使用 `auth` 中间件\n- [x] 前端 admin 路由受保护\n- [x] 无越权访问风险\n\n---\n\n## ✅ Review 建议 (Review Recommendations)\n\n### 代码质量 (Code Quality)\n**评分:** ⭐⭐⭐⭐⭐ (5/5)\n\n**优点:**\n- ✅ 代码结构清晰,遵循现有架构模式\n- ✅ 命名规范,变量、函数名清晰表意\n- ✅ 注释充分,关键逻辑有说明\n- ✅ 错误处理完整,有 try-catch 保护\n- ✅ 国际化支持完善\n\n**需要改进:**\n- ⚠️ 部分文件存在类型断言(`as any`),降低类型安全性\n- ⚠️ SQL 查询部分使用字符串拼接,有注入风险\n\n**建议:**\n- 💡 为通知模板定义接口约束静态方法\n- 💡 使用参数化查询替代字符串拼接\n- 💡 提取复杂的条件判断为独立函数,提升可读性\n\n---\n\n### 架构设计 (Architecture)\n**评分:** ⭐⭐⭐⭐☆ (4/5)\n\n**优点:**\n- ✅ 通用的预检查和延迟机制设计,扩展性好\n- ✅ 数据流清晰:事件→队列→通知→发送\n- ✅ 前后端分离,API 设计 RESTful\n- ✅ 模块职责明确,低耦合\n\n**需要改进:**\n- ⚠️ Invoice 关联查询逻辑复杂,可考虑在数据模型层优化\n- ⚠️ 通知去重机制使用内存 cache,可能在分布式环境下失效\n\n**建议:**\n- 💡 考虑在 `CreditGrant` 创建时直接关联 `invoice_id`,简化查询\n- 💡 评估是否需要使用 Redis 等持久化缓存实现去重\n- 💡 为预检查机制增加监控,追踪跳过的通知数量\n\n---\n\n### 功能验证 (Functionality)\n**评分:** ⭐⭐⭐⭐☆ (4/5)\n\n**已验证:**\n- ✅ 核心业务逻辑正确\n- ✅ 错误处理完整\n- ✅ 边界情况考虑周全(如零余额、空数据)\n\n**需要验证:**\n- ❓ 大数据量下的性能(欠费查询、invoice 关联查询)\n- ❓ 并发场景下的通知去重是否有效\n- ❓ 预检查失败时的用户影响(是否会漏通知)\n- ❓ 多语言环境下的邮件模板渲染\n- ❓ 不同类型 grant 的前端显示是否正确\n\n**建议:**\n- 💡 **必须测试:**\n  - 在 staging 环境模拟各种 credit 交易场景\n  - 验证 10 分钟延迟+预检查的实际效果\n  - 测试欠费查询在大数据量下的性能\n- 💡 **集成测试:**\n  - 自动充值达到限额→触发通知\n  - 低余额→充值→预检查跳过通知\n  - 欠费数据的准确性\n- 💡 **用户验收测试:** 让实际用户验证新的交易列表 UI\n\n---\n\n### 安全性 (Security)\n**评分:** ⭐⭐⭐⭐☆ (4/5)\n\n**安全措施:**\n- ✅ 所有 API 使用认证中间件\n- ✅ 使用 Sequelize ORM,主要查询安全\n- ✅ 输入验证(分页参数范围检查)\n- ✅ 无敏感信息泄露\n\n**潜在风险:**\n- 🔒 SQL 字符串拼接存在注入风险(虽然危害有限)\n- 🔒 LIKE 查询未转义特殊字符\n\n**建议:**\n- 💡 **必须修复:** 将 `meter-events.ts:L444` 的字符串拼接改为参数化查询\n- 💡 **建议修复:** LIKE 查询增加转义:\n  ```typescript\n  const escapedQuery = searchQuery.replace(/[%_\\\\]/g, '\\\\$&');\n  ```\n- 💡 **安全审计:** Review 所有使用原生 SQL 的地方,确保参数化\n\n---\n\n### 性能 (Performance)\n**评分:** ⭐⭐⭐⭐☆ (4/5)\n\n**性能优化:**\n- ✅ 批量查询代替 N+1 查询\n- ✅ 使用 `Promise.all` 并行查询\n- ✅ 分页限制防止大查询\n- ✅ 使用 Map 优化查找效率\n\n**潜在问题:**\n- ⚡ 欠费 SQL 聚合查询可能在大量数据时变慢\n- ⚡ Invoice 关联查询在大量 subscriptions 时可能低效\n- ⚡ 预检查增加一次数据库查询\n\n**建议:**\n- 💡 **监控:**\n  - 添加慢查询日志监控\n  - 监控欠费 API 的响应时间\n  - 监控 CreditGrant 查询性能\n- 💡 **索引优化:**\n  - 确保 `meter_events.credit_pending` 有索引\n  - 确保 `meter_events.livemode` 有索引\n  - 考虑组合索引 `(livemode, credit_pending)`\n- 💡 **缓存策略:**\n  - 欠费总览可以缓存 5-10 分钟\n  - Invoice 关联数据可以考虑缓存\n- 💡 **查询优化:**\n  - 评估是否需要物化视图存储欠费统计\n  - 考虑异步计算欠费数据\n\n---\n\n## 📝 总体评价 (Overall Assessment)\n\n### 综合评分\n**总分:** ⭐⭐⭐⭐⭐ (4.4/5)\n\n### 核心优点\n1. **功能完整且实用:** 三个核心功能(每日限额通知、智能低余额通知、欠费管理)都切中用户痛点\n2. **架构设计优秀:** 通用的预检查和延迟机制,扩展性强,向后兼容\n3. **用户体验提升:** 新的交易列表 UI 更清晰,欠费管理功能方便管理员监控\n4. **代码质量高:** 结构清晰,注释充分,错误处理完整\n5. **国际化支持:** 完整的中英文支持\n\n### 主要问题\n1. **SQL 注入风险:** `meter-events.ts` 中的字符串拼接需要改为参数化查询\n2. **类型安全性:** 使用 `as any` 降低类型检查,需要定义接口约束\n3. **性能监控不足:** 新增的 SQL 聚合查询需要监控和优化\n4. **测试覆盖不足:** 缺少集成测试和性能测试\n\n### 最终建议\n\n#### Must Fix (必须修复):\n- [ ] **SQL 注入修复** - `meter-events.ts:L444` 改为参数化查询\n- [ ] **索引验证** - 确保 `meter_events.credit_pending` 和 `livemode` 有索引\n- [ ] **集成测试** - 添加核心流程的集成测试(限额通知、预检查、欠费查询)\n\n#### Should Fix (建议修复):\n- [ ] **类型安全** - 为通知模板定义接口,移除 `as any`\n- [ ] **LIKE 转义** - 客户搜索增加特殊字符转义\n- [ ] **慢查询监控** - 添加 APM 监控,追踪欠费查询性能\n- [ ] **错误日志** - 预检查失败时增加详细日志\n- [ ] **代码复杂度** - 提取 `transactions-list.tsx` 的分类逻辑为独立函数\n\n#### Nice to Have (可选改进):\n- [ ] **数据模型优化** - 考虑在 CreditGrant 直接存储 invoice_id\n- [ ] **缓存优化** - 为欠费总览增加短时缓存\n- [ ] **去重机制** - 评估是否需要分布式去重(Redis)\n- [ ] **前端单元测试** - 为复杂的渲染逻辑增加测试\n\n### 是否建议合并\n- [x] ⚠️ **条件批准** - 修复 Must Fix 问题后可以合并\n\n**合并前检查清单:**\n1. [ ] 修复 SQL 注入风险\n2. [ ] 验证数据库索引\n3. [ ] 在 staging 环境完成集成测试\n4. [ ] 验证各类型 grant 的前端显示\n5. [ ] 进行一轮性能测试\n\n**合并后跟进:**\n1. 监控慢查询日志\n2. 监控通知发送成功率和预检查跳过率\n3. 收集用户反馈,优化 UI\n4. 补充自动化测试\n\n---\n\n## 📚 附加信息 (Additional Information)\n\n### 测试覆盖\n\n**单元测试:**\n- [ ] 通知模板的预检查逻辑\n- [ ] 交易类型分类逻辑\n- [ ] 金额格式化函数\n\n**集成测试:**\n- [ ] 自动充值限额流程\n- [ ] 低余额通知预检查\n- [ ] 欠费 API 的数据准确性\n\n**E2E 测试:**\n- [ ] 管理员查看欠费流程\n- [ ] 客户查看交易记录流程\n\n### 文档更新\n\n- [ ] API 文档:新增欠费相关端点\n- [ ] 用户手册:通知类型说明\n- [ ] 开发文档:通知预检查机制\n- [ ] 变更日志:记录本次新增功能\n\n### 部署注意事项\n\n**数据库:**\n- [ ] 验证索引: `meter_events.credit_pending`, `meter_events.livemode`\n- [ ] 无需数据迁移\n\n**配置变更:**\n- [ ] 无需配置变更\n\n**部署顺序:**\n1. 部署后端(API + 队列处理)\n2. 部署前端\n3. 监控通知队列和欠费查询\n\n**回滚方案:**\n- 通知系统向后兼容,可以直接回滚代码\n- 欠费功能为新增,不影响现有功能\n- 建议保留 1 个版本的回滚窗口\n\n**监控指标:**\n- 通知发送成功率\n- 预检查跳过率\n- 欠费 API 响应时间\n- CreditGrant 查询性能\n\n---\n\n**生成时间:** 2026-01-12\n**审查人:** Claude Code Review Assistant\n**版本:** 1.0\n","structuredPatch":[],"originalFile":null}}
{"parentUuid":"fe3905e0-b2f3-4955-a99b-52a6dbf8ff3a","isSidechain":false,"userType":"external","cwd":"~/Arcblock/payment-kit-master/blocklets/core","sessionId":"664f44d5-76eb-4da6-b55c-a98e01f05344","version":"2.0.76","gitBranch":"feat-quote","slug":"quirky-skipping-brooks","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01UZZWZB8hFYPT7eP5TBnGL8","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"我已经成功生成了一份详细的代码审查文档。这份文档涵盖了:\n\n1. **改动概览** - 统计了文件变更、关键文件列表\n2. **业务流程分析** - 详细分析了三个核心功能的业务流程和数据流\n3. **关键代码详解** - 对 8 个关键文件进行了深入分析,包括实际的代码片段和关注点\n4. **风险评估** - 识别了高中低风险项,特别是 SQL 注入风险\n5. **重点关注** - 标识了大文件改动和后端关键改动\n6. **Review 建议** - 从代码质量、架构、功能、安全、性能五个维度进行评分和建议\n7. **总体评价** - 给出综合评分 4.4/5,条件批准合并,列出了必须修复、建议修复和可选改进的清单\n8. **附加信息** - 提供了测试、文档、部署方面的检查清单\n\n这份文档基于实际的 diff 内容,使用了真实的代码片段,提供了具体可行的建议。现在我应该告诉用户文档已生成,并总结主要发现。","signature":"EvYICkYICxgCKkCkM5Ft3mQK+Lc+9IYu4yigjFjlkgrRTGboQQks/GtWNPhDgt95+4u0YvMHCu+kEcN79fOHVUyr6DYTnygnLVb3EgwkXeJF2BEIb2/aeH8aDLZfEjPspjzjxcvOoSIwiesBnd858bU7vUBROmMl+R+4R2lKuv1H0jibY07PEqc/AiiwOJxzVUyufEAdwp1UKt0HMS0Z47DojjoeyFjYuuE1OMaMM/V808VQH8nLYBYqCiQCepMK+fSlA0lAwHQaAmAOPrkxUi1tj6c7igsMjhQqNna69zSCQJ5AOujL43ePy1VELCZx7YbScGR5r979LJ7cZ2znxKG/il6vfjvdUSobBsskfvqJJJ5e466pVmCSOMqB6A4mhnOskSB/KxrNiJdKlDd6aSRctQ4ECH3xvyApxwTO4sMWxglY5165XHIlVTPX6MkH+G/j2zLl4gMt6cJvo4ZhemVBPqE1a/C2x2jnwBZqK/NMfpKOwlAFJbHKx9opHqKLPn9g8LOb92afMqW6KJlCPc91EsXEy7Z58CyBVpzloYkqC6f/HkjDFPu/gf8vh0B/EFW3Oio0k94HS8FiVDSeSz5UvG1Amvf0PGlZeLgcc7ZpjYiczoOXmW0MvnwwQKlNZ6LmKas4DVrWLrxordPs2p9qGwF2IA7iXDyvCN2WkFzHk/LfNTdPInP9ldD+3uxNjze9xgFgyPIG04avlAgEi/n0ea2aem5+4jr6gY2YS3oBfC7sRs8jq8ojWzZzcB5pWv52Aa7Ljd7WneagngMG6RYO7Xag1yJ4xMtgbjOhBvQaGn/WnP1zd0xy+ZtuP9qyM78xhnO7lCSSP7Yj16fOU5ZNhIjcERLq13EXNtUYBNSowEhfVCel1nLB+iUj+zBuyfFkQjFnpenJfEjPnrHFpfsnB0YPCIHNnzm+x/qDB4ZiPRtEo84FpXp6hBHhEUeakgF6w3IdhK8PeUzpyeAP7nP/uwl4hlICgPuJLI1AOL7nw+uLA8EnQ4lIuP/yir/2Swzzx040xEGvCTot4jAik/BGiUW5GX0t7tR2vud5nZYEIRSdvLfY5aU1A53fFW3WlME6XaUxTmr2P41wRx0W36YUY0M0S0VCZUZ5UgvDuAfYnTdU2a38hVzGDYdddlNyzPpLIbFyImtCVRMnfDrrZwzA8gYIormy0K2q8odPHm/cfXkl/faTkr2Lf1BbDsss9CDcDQ8ql4KYCVTrkW+1Tabre8NbKEVcI9IOzenzq1UPn3SdTqbiTP6H3vr2pTbYzMbMke3oXtQ261g/WZ7CAkgbZfxkffnuCjuXrJsRzMi3RzHI1RGq4GSxYykmSc5Z+0OHgv+aayD7P2GsT6rQ6jlyHRZB42vw7n6nx3Py1KJZTUS/lIi0kQ7AjURSGmJO+jy/NYrP2D8GqkLWu6mjyzUcBArhmVZx58cTjWeUsUTsK6/7PBZJMaRRve4Kr/K/1PlGcs5Dy6cyo7BhybbWVCQNzoqMMvk6zDMMqLVqrhm++h5V2KMyzdEYAQ=="}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":11,"cache_creation_input_tokens":14561,"cache_read_input_tokens":85679,"cache_creation":{"ephemeral_5m_input_tokens":14561,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CX3c6aN2hMwMPoLdSgWMT","type":"assistant","uuid":"59745fd5-d08f-4209-b598-819cf021b719","timestamp":"2026-01-12T14:01:18.662Z"}
{"parentUuid":"59745fd5-d08f-4209-b598-819cf021b719","isSidechain":false,"userType":"external","cwd":"~/Arcblock/payment-kit-master/blocklets/core","sessionId":"664f44d5-76eb-4da6-b55c-a98e01f05344","version":"2.0.76","gitBranch":"feat-quote","slug":"quirky-skipping-brooks","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01UZZWZB8hFYPT7eP5TBnGL8","type":"message","role":"assistant","content":[{"type":"text","text":"✅ 代码审查文档已生成完成!\n\n我已经为这个大型 diff 生成了一份全面的代码审查文档,保存在:\n`~/Arcblock/payment-kit-master/blocklets/core/CODE_REVIEW.md`\n\n## 📊 审查摘要\n\n**综合评分:** ⭐⭐⭐⭐⭐ (4.4/5)\n\n**变更规模:**\n- 21 个文件修改,3 个新文件\n- 约 +1500 / -150 行代码\n\n**核心功能:**\n1. 🔔 **自动充值每日限额通知** - 达到限额时通知用户\n2. 🧠 **智能低余额通知** - 10分钟延迟+预检查,避免误报\n3. 📊 **欠费管理系统** - 完整的欠费监控和管理功能\n\n## ⚠️ 关键发现\n\n### Must Fix (阻塞合并):\n1. **SQL 注入风险** - `meter-events.ts:L444` 使用字符串拼接,需改为参数化查询\n2. **数据库索引验证** - 确保 `meter_events.credit_pending` 和 `livemode` 有索引\n3. **集成测试** - 核心流程需要测试验证\n\n### Should Fix (强烈建议):\n1. 类型安全性 - 移除 `as any`,定义通知模板接口\n2. LIKE 转义 - 客户搜索需转义特殊字符\n3. 性能监控 - 添加慢查询监控\n4. 代码复杂度 - 提取交易列表的复杂分类逻辑\n\n## 💡 主要优点\n\n- ✅ 架构设计优秀,扩展性强\n- ✅ 功能切中用户痛点\n- ✅ 代码质量高,注释充分\n- ✅ 完整的国际化支持\n- ✅ 良好的用户体验\n\n## 🎯 合并建议\n\n**条件批准** - 修复 Must Fix 项后可合并\n\n详细的分析、代码片段、风险评估和改进建议都在生成的文档中,请查看完整报告!"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":11,"cache_creation_input_tokens":14561,"cache_read_input_tokens":85679,"cache_creation":{"ephemeral_5m_input_tokens":14561,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CX3c6aN2hMwMPoLdSgWMT","type":"assistant","uuid":"f46ca549-5329-4a2d-832e-b29d96ce987b","timestamp":"2026-01-12T14:01:26.772Z"}
